<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>35 MINUTE DAILY WORKOUT</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Archivo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --energy-orange: #FF6B35;
            --electric-yellow: #F7C948;
            --deep-charcoal: #1A1A1D;
            --slate: #2E2E32;
            --vibrant-cyan: #00D9FF;
            --pure-white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: var(--deep-charcoal);
            color: var(--pure-white);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 20px, var(--pure-white) 20px, var(--pure-white) 21px),
                repeating-linear-gradient(-45deg, transparent, transparent 20px, var(--pure-white) 20px, var(--pure-white) 21px);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(3rem, 8vw, 6rem);
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--energy-orange), var(--electric-yellow), var(--vibrant-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            line-height: 1;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.2) saturate(1.3); }
        }

        .tagline {
            font-size: 1.1rem;
            color: var(--electric-yellow);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            font-weight: 600;
        }

        .date-display {
            display: inline-block;
            background: var(--slate);
            padding: 0.75rem 2rem;
            border-radius: 50px;
            margin: 2rem 0;
            border: 2px solid var(--energy-orange);
            font-weight: 600;
            letter-spacing: 0.05em;
            animation: fadeIn 1s ease-out 0.3s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .generate-btn {
            background: linear-gradient(135deg, var(--energy-orange), #FF8C42);
            color: var(--pure-white);
            border: none;
            padding: 1.25rem 3rem;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
            transition: all 0.3s ease;
            font-family: 'Archivo', sans-serif;
            position: relative;
            overflow: hidden;
            animation: fadeIn 1s ease-out 0.5s both;
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .generate-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.6);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .workout-container {
            margin-top: 3rem;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .workout-summary {
            background: linear-gradient(135deg, var(--slate), #3A3A3F);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            border-left: 6px solid var(--electric-yellow);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .workout-summary h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 0.08em;
            color: var(--electric-yellow);
            margin-bottom: 1rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .summary-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--vibrant-cyan);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
        }

        .exercise-block {
            background: var(--slate);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border-left: 6px solid var(--energy-orange);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            animation: slideInLeft 0.6s ease-out both;
        }

        .exercise-block:nth-child(even) {
            border-left-color: var(--vibrant-cyan);
            animation-delay: 0.1s;
        }

        .exercise-block:nth-child(3n) {
            border-left-color: var(--electric-yellow);
            animation-delay: 0.2s;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .exercise-block:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .exercise-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 0.05em;
            color: var(--pure-white);
        }

        .exercise-duration {
            background: var(--energy-orange);
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .exercise-description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .exercise-tips {
            background: rgba(0, 217, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            margin-top: 1rem;
        }

        .tips-title {
            font-weight: 700;
            color: var(--vibrant-cyan);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
        }

        .timer-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--energy-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 3rem;
            }

            .exercise-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <!-- Auth Screen (Google Sign-In) -->
    <div id="authScreen" class="container">
        <header>
            <h1>DAILY WORKOUT</h1>
            <p class="tagline">35 Minutes to Peak Performance</p>
        </header>
        
        <div style="max-width: 500px; margin: 4rem auto; text-align: center;">
            <div class="workout-summary">
                <h2>Welcome!</h2>
                <p style="margin: 1.5rem 0; line-height: 1.6; color: rgba(255, 255, 255, 0.8);">
                    Sign in with Google to start your fitness journey, track your progress, and connect with friends!
                </p>
                <button onclick="signInWithGoogle()" style="background: white; color: #444; border: none; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; font-family: 'Archivo', sans-serif; display: inline-flex; align-items: center; gap: 0.75rem;">
                    <svg width="24" height="24" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
                <p style="margin-top: 1.5rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);">
                    Your data is securely stored with Firebase
                </p>
            </div>
        </div>
    </div>

    <!-- App Screen (Main Application) -->
    <div id="appScreen" class="container" style="display: none;">
        <header>
            <h1>DAILY WORKOUT</h1>
            <p class="tagline">35 Minutes to Peak Performance</p>
            <div class="date-display" id="dateDisplay"></div>
            <div id="userProfileBadge" style="display: none; margin-top: 1rem;">
                <div style="display: inline-flex; align-items: center; gap: 0.75rem; background: rgba(0, 217, 255, 0.2); padding: 0.75rem 1.5rem; border-radius: 50px; border: 2px solid var(--vibrant-cyan);">
                    <img id="userAvatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;" src="" alt="User">
                    <div style="text-align: left;">
                        <div style="font-weight: 700; color: var(--vibrant-cyan);"><span id="displayNameSpan"></span></div>
                        <button onclick="signOutUser()" style="background: none; border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; font-size: 0.85rem; padding: 0; margin-top: 0.2rem;">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <div style="text-align: center;">
            <button class="generate-btn" id="generateBtn">
                <span style="position: relative; z-index: 1;">Generate Today's Workout</span>
            </button>
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="generate-btn" id="customizeBtn" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); box-shadow: 0 10px 30px rgba(156, 39, 176, 0.4); padding: 1rem 2rem; font-size: 1rem;">
                    <span style="position: relative; z-index: 1;">‚öôÔ∏è Customize Workout</span>
                </button>
                <button class="generate-btn" id="viewStatsBtn" style="background: linear-gradient(135deg, var(--vibrant-cyan), #00B8D4); box-shadow: 0 10px 30px rgba(0, 217, 255, 0.4); padding: 1rem 2rem; font-size: 1rem;">
                    <span style="position: relative; z-index: 1;">üìä My Progress</span>
                </button>
                <button class="generate-btn" id="viewSocialBtn" style="background: linear-gradient(135deg, var(--electric-yellow), #F4A300); box-shadow: 0 10px 30px rgba(247, 201, 72, 0.4); padding: 1rem 2rem; font-size: 1rem;">
                    <span style="position: relative; z-index: 1;">üë• Friends & Feed</span>
                </button>
            </div>
        </div>

        <div id="socialContainer" class="hidden"></div>
        <div id="statsContainer" class="hidden"></div>
        <div id="workoutContainer" class="hidden"></div>

        <footer>
            <p><strong>Your Weekly Training Plan:</strong></p>
            <p style="margin-top: 0.5rem; line-height: 1.8;">
                Mon: HIIT üî• | Tue: Upper Body üí™ | Wed: Recovery üßò | Thu: Lower Body & Core üí™ | Fri: Cross Training ‚ö° | Sat: HIIT üî• | Sun: Recovery üßò
            </p>
            <p style="margin-top: 1rem; font-size: 0.85rem;">Consistent workouts. Smart recovery. Maximum results.</p>
            <p style="margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.5);">
                <strong>Equipment needed:</strong> Barbell, dumbbells, kettlebell, bench, and basic gym setup. Most workouts require weights for optimal results.
            </p>
        </footer>
    </div>

    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyANOaf5ePwf26-NTBDra6qugOJCaiSELTk",
            authDomain: "camp-hope-2ca32.firebaseapp.com",
            projectId: "camp-hope-2ca32",
            storageBucket: "camp-hope-2ca32.firebasestorage.app",
            messagingSenderId: "543842577310",
            appId: "1:543842577310:web:3ac478061d1de5430d048f",
            measurementId: "G-NJV0K3DK72"
        };

        // Initialize Firebase with compat API
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log('Firebase initialized successfully');

        // Display today's date
        const dateDisplay = document.getElementById('dateDisplay');
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateDisplay.textContent = today.toLocaleDateString('en-US', options);

        // User Profile Management with Firebase Auth
        let currentUser = null;

        // Firebase Auth State Observer (compat API)
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                currentUser = {
                    id: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    username: user.email.split('@')[0]
                };
                
                // Initialize user profile in Firestore
                await initializeUserProfile(user);
                
                // Load preferences
                await loadPreferences();
                
                // Show app
                showAppInterface();
                
                // Auto-generate workout
                setTimeout(() => {
                    document.getElementById('generateBtn').click();
                }, 500);
            } else {
                // User is signed out
                currentUser = null;
                showAuthInterface();
            }
        });

        async function initializeUserProfile(user) {
            const userRef = db.collection('users').doc(user.uid);
            const userSnap = await userRef.get();
            
            if (!userSnap.exists) {
                // Create new user profile
                await userRef.set({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    createdAt: new Date().toISOString(),
                    friends: []
                });
            }
        }

        function showAuthInterface() {
            const appScreen = document.getElementById('appScreen');
            const authScreen = document.getElementById('authScreen');
            
            if (appScreen) appScreen.style.display = 'none';
            if (authScreen) authScreen.style.display = 'block';
        }

        function showAppInterface() {
            const appScreen = document.getElementById('appScreen');
            const authScreen = document.getElementById('authScreen');
            
            if (authScreen) authScreen.style.display = 'none';
            if (appScreen) appScreen.style.display = 'block';
            
            // Update user profile display
            const userBadge = document.getElementById('userProfileBadge');
            const displayNameSpan = document.getElementById('displayNameSpan');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userBadge) userBadge.style.display = 'block';
            if (displayNameSpan) displayNameSpan.textContent = currentUser.displayName;
            if (userAvatar) userAvatar.src = currentUser.photoURL;
        }

        // Google Sign In (compat API - function in global scope)
        function signInWithGoogle() {
            console.log('Sign in button clicked');
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('Sign in successful:', result.user.email);
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                    alert('Error signing in: ' + error.message);
                });
        }

        // Sign Out (compat API)
        function signOutUser() {
            auth.signOut()
                .then(() => {
                    console.log('Signed out');
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                });
        }

        // Remove old profile setup function - replaced by Firebase Auth
        function showProfileSetup() {
            // Redirect to Google Sign In
            showAuthInterface();
        }

        window.submitProfile = async function() {
            // No longer needed - using Firebase Auth
        }

        async function createProfile(username, displayName) {
            // No longer needed - using Firebase Auth  
            return true;
        }

        async function updateProfile(updates) {
            if (!currentUser) return;
            const userRef = db.collection('users').doc(currentUser.id);
            await userRef.update(updates);
        }

        // Fitness data storage functions
        // Fitness data storage with Firebase Firestore
        async function saveWorkoutCompletion(workoutData) {
            if (!currentUser) return false;
            
            try {
                const workoutRef = db.collection('workouts').doc(`${currentUser.id}_${getTodayDateKey()}`);
                const completionData = {
                    userId: currentUser.id,
                    username: currentUser.username,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL || '',
                    date: new Date().toISOString(),
                    workoutType: workoutData.workoutType,
                    dayName: workoutData.dayName,
                    totalTime: workoutData.totalTime,
                    exercisesCompleted: workoutData.exercises.length,
                    completed: true
                };
                
                await workoutRef.set(completionData);
                return true;
            } catch (error) {
                console.error('Error saving workout:', error);
                return false;
            }
        }

        async function saveExercisePerformance(exerciseName, performanceData) {
            if (!currentUser) return;
            
            try {
                const perfRef = db.collection('performance').doc(`${currentUser.id}_${exerciseName}_${getTodayDateKey()}`);
                const data = {
                    ...performanceData,
                    userId: currentUser.id,
                    username: currentUser.username,
                    exerciseName: exerciseName,
                    timestamp: new Date().toISOString()
                };
                await perfRef.set(data);
            } catch (error) {
                console.error('Error saving performance:', error);
            }
        }

        async function getWorkoutHistory(limitCount = 30) {
            if (!currentUser) return [];
            
            try {
                const querySnapshot = await db.collection('workouts')
                    .where('userId', '==', currentUser.id)
                    .orderBy('date', 'desc')
                    .limit(limitCount)
                    .get();
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting workout history:', error);
                return [];
            }
        }

        async function getExerciseHistory(exerciseName, limitCount = 10) {
            if (!currentUser) return [];
            
            try {
                const querySnapshot = await db.collection('performance')
                    .where('userId', '==', currentUser.id)
                    .where('exerciseName', '==', exerciseName)
                    .orderBy('timestamp', 'desc')
                    .limit(limitCount)
                    .get();
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting exercise history:', error);
                return [];
            }
        }

        // Friend Management with Firebase
        async function addFriend(friendEmail) {
            if (!currentUser) return false;
            
            try {
                // Search for user by email
                const querySnapshot = await db.collection('users')
                    .where('email', '==', friendEmail)
                    .get();
                
                if (querySnapshot.empty) {
                    return false;
                }
                
                const friendDoc = querySnapshot.docs[0];
                const friendData = friendDoc.data();
                
                if (friendData.uid === currentUser.id) {
                    return false; // Can't add yourself
                }
                
                // Add to friends list
                const userRef = db.collection('users').doc(currentUser.id);
                await userRef.update({
                    friends: firebase.firestore.FieldValue.arrayUnion(friendData.uid)
                });
                
                // Update local currentUser
                if (!currentUser.friends) currentUser.friends = [];
                if (!currentUser.friends.includes(friendData.uid)) {
                    currentUser.friends.push(friendData.uid);
                }
                
                return true;
            } catch (error) {
                console.error('Error adding friend:', error);
                return false;
            }
        }

        async function getFriendsActivity(limitCount = 20) {
            if (!currentUser) return [];
            
            try {
                // Get current user's friends list
                const userRef = db.collection('users').doc(currentUser.id);
                const userSnap = await userRef.get();
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                if (friends.length === 0) return [];
                
                // Get workouts from friends (Firestore 'in' limit is 10)
                const querySnapshot = await db.collection('workouts')
                    .where('userId', 'in', friends.slice(0, 10))
                    .orderBy('date', 'desc')
                    .limit(limitCount)
                    .get();
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting friends activity:', error);
                return [];
            }
        }

        async function getFriendProfiles() {
            if (!currentUser) return [];
            
            try {
                const userRef = db.collection('users').doc(currentUser.id);
                const userSnap = await userRef.get();
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                if (friends.length === 0) return [];
                
                const profiles = [];
                for (let friendId of friends) {
                    const friendRef = db.collection('users').doc(friendId);
                    const friendSnap = await friendRef.get();
                    if (friendSnap.exists) {
                        profiles.push(friendSnap.data());
                    }
                }
                return profiles;
            } catch (error) {
                console.error('Error getting friend profiles:', error);
                return [];
            }
        }

        async function getFriendStats(friendId) {
            try {
                const querySnapshot = await db.collection('workouts')
                    .where('userId', '==', friendId)
                    .orderBy('date', 'desc')
                    .limit(30)
                    .get();
                const workouts = querySnapshot.docs.map(doc => doc.data());
                
                return {
                    totalWorkouts: workouts.length,
                    totalMinutes: workouts.reduce((sum, w) => sum + (w.totalTime || 0), 0),
                    lastWorkout: workouts.length > 0 ? workouts[0].date : null
                };
            } catch (error) {
                return null;
            }
        }

        function getTodayDateKey() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        async function getStats() {
            const history = await getWorkoutHistory(90);
            const totalWorkouts = history.length;
            const last7Days = history.filter(w => {
                const workoutDate = new Date(w.date);
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                return workoutDate >= sevenDaysAgo;
            }).length;
            
            const workoutTypes = history.reduce((acc, w) => {
                acc[w.workoutType] = (acc[w.workoutType] || 0) + 1;
                return acc;
            }, {});

            return {
                totalWorkouts,
                last7Days,
                workoutTypes,
                totalMinutes: history.reduce((sum, w) => sum + (w.totalTime || 0), 0)
            };
        }

        // User preferences for workout customization
        let workoutPreferences = {
            duration: 35, // 20, 35, or 45 minutes
            difficulty: 'intermediate', // beginner, intermediate, advanced
            equipment: 'full-gym', // full-gym, dumbbells-only, minimal, bodyweight
            injuries: [], // array of injury types: knee, shoulder, back, wrist, ankle
            planType: 'single', // single, weekly, monthly
            singleWorkoutType: 'hiit', // Default to HIIT for first-time users
            workoutMix: { // For weekly/monthly plans
                'hiit': 0,
                'upper-strength': 0,
                'lower-strength': 0,
                'full-body-hiit': 0,
                'full-body-strength': 0,
                'cross-training': 0,
                'circuit': 0,
                'cardio': 0,
                'recovery': 0
            },
            currentPlan: null // Stores generated weekly/monthly plan
        };

        // Load preferences from Firestore
        async function loadPreferences() {
            if (!currentUser) return;
            
            try {
                const prefRef = db.collection('preferences').doc(currentUser.id);
                const prefSnap = await prefRef.get();
                if (prefSnap.exists) {
                    const data = prefSnap.data();
                    workoutPreferences = { ...workoutPreferences, ...data };
                }
            } catch (error) {
                console.log('No saved preferences, using defaults');
            }
        }

        // Save preferences to Firestore
        async function savePreferences() {
            if (!currentUser) return;
            
            try {
                const prefRef = db.collection('preferences').doc(currentUser.id);
                await prefRef.set(workoutPreferences);
            } catch (error) {
                console.error('Error saving preferences:', error);
            }
        }

        // Show preferences modal
        function showPreferencesModal() {
            const modal = document.createElement('div');
            modal.id = 'preferencesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
                overflow-y: auto;
            `;

            const totalWorkouts = Object.values(workoutPreferences.workoutMix).reduce((a, b) => a + b, 0);
            const isPlanSelected = workoutPreferences.planType !== 'single';
            const expectedTotal = workoutPreferences.planType === 'weekly' ? 7 : 30;

            modal.innerHTML = `
                <div style="background: var(--slate); border-radius: 16px; padding: 2rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--energy-orange);">
                    <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--electric-yellow); margin-bottom: 2rem; text-align: center;">Customize Your Training Plan</h2>
                    
                    <!-- Plan Type -->
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(255, 107, 53, 0.1); border-radius: 12px; border: 2px solid var(--energy-orange);">
                        <label style="display: block; font-size: 1.1rem; font-weight: 700; color: var(--energy-orange); margin-bottom: 1rem;">üìÖ Plan Type</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button class="plan-btn" data-plan="single" style="padding: 1rem; background: ${workoutPreferences.planType === 'single' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'single' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Single Day<br><span style="font-size: 0.8rem; opacity: 0.7;">One workout</span></button>
                            <button class="plan-btn" data-plan="weekly" style="padding: 1rem; background: ${workoutPreferences.planType === 'weekly' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'weekly' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Weekly Plan<br><span style="font-size: 0.8rem; opacity: 0.7;">7 workouts</span></button>
                            <button class="plan-btn" data-plan="monthly" style="padding: 1rem; background: ${workoutPreferences.planType === 'monthly' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'monthly' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Monthly Plan<br><span style="font-size: 0.8rem; opacity: 0.7;">30 workouts</span></button>
                        </div>
                    </div>

                    <!-- Workout Mix (shown for weekly/monthly) -->
                    <div id="workoutMixSection" style="margin-bottom: 2rem; display: ${isPlanSelected ? 'block' : 'none'};">
                        <label style="display: block; font-size: 1.1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">üéØ Workout Mix ${isPlanSelected ? `(${totalWorkouts}/${expectedTotal} days)` : ''}</label>
                        <div style="background: rgba(0, 217, 255, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 217, 255, 0.3); margin-bottom: 1rem;">
                            <p style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8); margin-bottom: 0.5rem;">Choose how many days of each workout type:</p>
                        </div>
                        <div style="display: grid; gap: 0.75rem;">
                            ${Object.entries({
                                'hiit': 'HIIT üî•',
                                'upper-strength': 'Upper Body Strength üí™',
                                'lower-strength': 'Lower Body Strength ü¶µ',
                                'full-body-hiit': 'Full Body HIIT üî•üí™',
                                'full-body-strength': 'Full Body Strength üí™ü¶µ',
                                'cross-training': 'Cross Training ‚ö°',
                                'circuit': 'Circuit Training üîÑ',
                                'cardio': 'Cardio/Aerobic üèÉ',
                                'recovery': 'Recovery & Stretching üßò'
                            }).map(([key, label]) => `
                                <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.05); padding: 0.75rem 1rem; border-radius: 8px;">
                                    <label style="font-size: 0.9rem; color: white;">${label}</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <button class="mix-btn" data-action="decrease" data-type="${key}" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">-</button>
                                        <span id="mix-${key}" style="min-width: 30px; text-align: center; font-weight: 700; color: var(--vibrant-cyan);">${workoutPreferences.workoutMix[key]}</span>
                                        <button class="mix-btn" data-action="increase" data-type="${key}" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Single Day Workout Type (shown for single day) -->
                    <div id="singleDaySection" style="margin-bottom: 2rem; display: ${!isPlanSelected ? 'block' : 'none'};">
                        <label style="display: block; font-size: 1.1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">üéØ Today's Workout Type</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            ${Object.entries({
                                'hiit': 'HIIT üî•',
                                'upper-strength': 'Upper Body üí™',
                                'lower-strength': 'Lower Body ü¶µ',
                                'full-body-hiit': 'Full Body HIIT üî•',
                                'full-body-strength': 'Full Body Strength üí™',
                                'cross-training': 'Cross Training ‚ö°',
                                'circuit': 'Circuit Training üîÑ',
                                'cardio': 'Cardio üèÉ',
                                'recovery': 'Recovery üßò'
                            }).map(([key, label]) => `
                                <button class="single-workout-btn" data-type="${key}" style="padding: 1rem; background: ${workoutPreferences.singleWorkoutType === key ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === key ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.9rem;">${label}</button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Duration -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">‚è±Ô∏è Workout Duration</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button class="duration-btn" data-duration="20" style="padding: 1rem; background: ${workoutPreferences.duration === 20 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 20 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">20 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Quick</span></button>
                            <button class="duration-btn" data-duration="35" style="padding: 1rem; background: ${workoutPreferences.duration === 35 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 35 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">35 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Standard</span></button>
                            <button class="duration-btn" data-duration="45" style="padding: 1rem; background: ${workoutPreferences.duration === 45 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 45 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">45 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Extended</span></button>
                        </div>
                    </div>

                    <!-- Difficulty -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">üí™ Difficulty Level</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button class="difficulty-btn" data-difficulty="beginner" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'beginner' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'beginner' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Beginner<br><span style="font-size: 0.8rem; opacity: 0.7;">Lighter</span></button>
                            <button class="difficulty-btn" data-difficulty="intermediate" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'intermediate' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'intermediate' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Intermediate<br><span style="font-size: 0.8rem; opacity: 0.7;">Moderate</span></button>
                            <button class="difficulty-btn" data-difficulty="advanced" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'advanced' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'advanced' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Advanced<br><span style="font-size: 0.8rem; opacity: 0.7;">Intense</span></button>
                        </div>
                    </div>

                    <!-- Equipment -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">üèãÔ∏è Available Equipment</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <button class="equipment-btn" data-equipment="full-gym" style="padding: 1rem; background: ${workoutPreferences.equipment === 'full-gym' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'full-gym' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Full Gym<br><span style="font-size: 0.8rem; opacity: 0.7;">All equipment</span></button>
                            <button class="equipment-btn" data-equipment="dumbbells-only" style="padding: 1rem; background: ${workoutPreferences.equipment === 'dumbbells-only' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'dumbbells-only' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Dumbbells Only<br><span style="font-size: 0.8rem; opacity: 0.7;">+ bench</span></button>
                            <button class="equipment-btn" data-equipment="minimal" style="padding: 1rem; background: ${workoutPreferences.equipment === 'minimal' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'minimal' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Minimal<br><span style="font-size: 0.8rem; opacity: 0.7;">Light weights</span></button>
                            <button class="equipment-btn" data-equipment="bodyweight" style="padding: 1rem; background: ${workoutPreferences.equipment === 'bodyweight' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'bodyweight' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Bodyweight<br><span style="font-size: 0.8rem; opacity: 0.7;">No equipment</span></button>
                        </div>
                    </div>

                    <!-- Injuries -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">‚öïÔ∏è Injury Modifications</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            ${['knee', 'shoulder', 'back', 'wrist', 'ankle', 'elbow'].map(injury => `
                                <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" class="injury-check" value="${injury}" ${workoutPreferences.injuries.includes(injury) ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                    <span style="text-transform: capitalize;">${injury} Issues</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button id="savePreferencesBtn" style="flex: 1; background: linear-gradient(135deg, var(--energy-orange), #FF8C42); color: white; border: none; padding: 1rem; font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px;">Save & Generate</button>
                        <button id="cancelPreferencesBtn" style="flex: 0.5; background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem; font-size: 1rem; font-weight: 600; cursor: pointer; border-radius: 8px;">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Plan type buttons
            modal.querySelectorAll('.plan-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const planType = e.target.dataset.plan;
                    workoutPreferences.planType = planType;
                    modal.querySelectorAll('.plan-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    
                    // Show/hide workout mix or single day selection
                    const mixSection = document.getElementById('workoutMixSection');
                    const singleSection = document.getElementById('singleDaySection');
                    if (planType === 'single') {
                        mixSection.style.display = 'none';
                        singleSection.style.display = 'block';
                    } else {
                        mixSection.style.display = 'block';
                        singleSection.style.display = 'none';
                        // Update label
                        const expectedTotal = planType === 'weekly' ? 7 : 30;
                        const totalWorkouts = Object.values(workoutPreferences.workoutMix).reduce((a, b) => a + b, 0);
                        mixSection.querySelector('label').innerHTML = `üéØ Workout Mix (${totalWorkouts}/${expectedTotal} days)`;
                    }
                });
            });

            // Workout mix buttons
            modal.querySelectorAll('.mix-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    const type = e.target.dataset.type;
                    const expectedTotal = workoutPreferences.planType === 'weekly' ? 7 : 30;
                    const currentTotal = Object.values(workoutPreferences.workoutMix).reduce((a, b) => a + b, 0);
                    
                    if (action === 'increase' && currentTotal < expectedTotal) {
                        workoutPreferences.workoutMix[type]++;
                    } else if (action === 'decrease' && workoutPreferences.workoutMix[type] > 0) {
                        workoutPreferences.workoutMix[type]--;
                    }
                    
                    document.getElementById(`mix-${type}`).textContent = workoutPreferences.workoutMix[type];
                    const newTotal = Object.values(workoutPreferences.workoutMix).reduce((a, b) => a + b, 0);
                    document.querySelector('#workoutMixSection label').innerHTML = `üéØ Workout Mix (${newTotal}/${expectedTotal} days)`;
                });
            });

            // Single workout type buttons
            modal.querySelectorAll('.single-workout-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    workoutPreferences.singleWorkoutType = e.target.dataset.type;
                    modal.querySelectorAll('.single-workout-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.05)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--vibrant-cyan)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                });
            });

            // Duration buttons
            modal.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    modal.querySelectorAll('.duration-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.duration = parseInt(e.target.dataset.duration);
                });
            });

            // Difficulty buttons
            modal.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    modal.querySelectorAll('.difficulty-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.difficulty = e.target.dataset.difficulty;
                });
            });

            // Equipment buttons
            modal.querySelectorAll('.equipment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    modal.querySelectorAll('.equipment-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.equipment = e.target.dataset.equipment;
                });
            });

            // Injury checkboxes
            modal.querySelectorAll('.injury-check').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    workoutPreferences.injuries = Array.from(modal.querySelectorAll('.injury-check:checked')).map(cb => cb.value);
                });
            });

            // Save button
            document.getElementById('savePreferencesBtn').addEventListener('click', async () => {
                // Validation
                if (workoutPreferences.planType !== 'single') {
                    const total = Object.values(workoutPreferences.workoutMix).reduce((a, b) => a + b, 0);
                    const expected = workoutPreferences.planType === 'weekly' ? 7 : 30;
                    if (total !== expected) {
                        alert(`Please select exactly ${expected} workout days. Currently: ${total}`);
                        return;
                    }
                } else {
                    if (!workoutPreferences.singleWorkoutType) {
                        alert('Please select a workout type for today');
                        return;
                    }
                }
                
                await savePreferences();
                modal.remove();
                
                // Generate workout(s) based on plan type
                if (workoutPreferences.planType === 'single') {
                    generateSingleDayWorkout();
                } else {
                    generatePlan();
                }
            });

            // Cancel button
            document.getElementById('cancelPreferencesBtn').addEventListener('click', () => {
                modal.remove();
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        window.showPreferencesModal = showPreferencesModal;

        // Show preferences modal

        // Filter exercises based on preferences
        function filterExercisesByPreferences(exercises) {
            return exercises.filter(exercise => {
                // Equipment filtering
                if (workoutPreferences.equipment === 'bodyweight') {
                    // Only bodyweight exercises
                    const bodyweightKeywords = ['bodyweight', 'push-up', 'pull-up', 'plank', 'burpee', 'mountain climber', 'jump', 'squat', 'lunge'];
                    const isBodyweight = bodyweightKeywords.some(keyword => 
                        exercise.name.toLowerCase().includes(keyword) || 
                        !exercise.name.toLowerCase().includes('barbell') && 
                        !exercise.name.toLowerCase().includes('dumbbell') && 
                        !exercise.name.toLowerCase().includes('kettlebell')
                    );
                    if (!isBodyweight) return false;
                }
                
                if (workoutPreferences.equipment === 'dumbbells-only') {
                    // Replace barbell with dumbbell variants
                    if (exercise.name.toLowerCase().includes('barbell')) {
                        exercise.name = exercise.name.replace('Barbell', 'Dumbbell');
                        exercise.description = exercise.description.replace('barbell', 'dumbbell');
                    }
                    if (exercise.name.toLowerCase().includes('kettlebell') && 
                        !exercise.name.includes('Swing')) {
                        return false; // Skip kettlebell-specific moves except swings
                    }
                }
                
                if (workoutPreferences.equipment === 'minimal') {
                    // No heavy barbells or machines
                    if (exercise.name.toLowerCase().includes('barbell') || 
                        exercise.name.toLowerCase().includes('leg press') ||
                        exercise.name.toLowerCase().includes('cable')) {
                        return false;
                    }
                }
                
                // Injury modifications
                if (workoutPreferences.injuries.includes('knee')) {
                    if (exercise.name.toLowerCase().includes('jump') || 
                        exercise.name.toLowerCase().includes('squat') ||
                        exercise.name.toLowerCase().includes('lunge')) {
                        exercise.tips += ' | MODIFICATION: Reduce depth, no jumping, or substitute with leg press';
                    }
                }
                
                if (workoutPreferences.injuries.includes('shoulder')) {
                    if (exercise.name.toLowerCase().includes('overhead') || 
                        exercise.name.toLowerCase().includes('press') ||
                        exercise.name.toLowerCase().includes('shoulder')) {
                        exercise.tips += ' | MODIFICATION: Reduce range of motion or substitute with lower angle press';
                    }
                }
                
                if (workoutPreferences.injuries.includes('back')) {
                    if (exercise.name.toLowerCase().includes('deadlift') || 
                        exercise.name.toLowerCase().includes('row') ||
                        exercise.name.toLowerCase().includes('good morning')) {
                        exercise.tips += ' | MODIFICATION: Keep weight light, focus on form, or substitute with machine variant';
                    }
                }
                
                if (workoutPreferences.injuries.includes('wrist')) {
                    if (exercise.name.toLowerCase().includes('push-up') || 
                        exercise.name.toLowerCase().includes('plank') ||
                        exercise.name.toLowerCase().includes('burpee')) {
                        exercise.tips += ' | MODIFICATION: Use push-up handles or perform on knuckles';
                    }
                }
                
                return true;
            });
        }

        // Adjust workout duration based on preferences
        function adjustWorkoutDuration() {
            const baseDuration = workoutPreferences.duration;
            
            if (baseDuration === 20) {
                return { warmup: 3, main: 15, cooldown: 2 };
            } else if (baseDuration === 45) {
                return { warmup: 7, main: 35, cooldown: 3 };
            } else {
                return { warmup: 5, main: 26, cooldown: 4 }; // 35 min default
            }
        }

        // Adjust reps/sets based on difficulty
        function adjustExerciseDifficulty(exercise) {
            const ex = { ...exercise };
            
            if (workoutPreferences.difficulty === 'beginner') {
                if (ex.reps) {
                    ex.reps = ex.reps.replace(/\d+-\d+/g, (match) => {
                        const [min, max] = match.split('-').map(Number);
                        return `${Math.max(1, min - 2)}-${max - 2}`;
                    });
                    ex.reps = ex.reps.replace(/\d+ sets/g, (match) => {
                        const sets = parseInt(match);
                        return `${Math.max(2, sets - 1)} sets`;
                    });
                }
                ex.description += ' (Beginner: lighter weight, focus on form)';
            } else if (workoutPreferences.difficulty === 'advanced') {
                if (ex.reps) {
                    ex.reps = ex.reps.replace(/\d+-\d+/g, (match) => {
                        const [min, max] = match.split('-').map(Number);
                        return `${min + 2}-${max + 3}`;
                    });
                    ex.reps = ex.reps.replace(/\d+ sets/g, (match) => {
                        const sets = parseInt(match);
                        return `${sets + 1} sets`;
                    });
                }
                ex.description += ' (Advanced: heavier weight, maximum intensity)';
            }
            
            return ex;
        }

        // Weekly workout schedule - cohesive program to avoid overtraining
        const weeklySchedule = {
            0: { // Sunday
                type: 'Recovery & Stretching',
                focus: 'Full body mobility and flexibility',
                intensity: 'Low'
            },
            1: { // Monday
                type: 'HIIT',
                focus: 'Full body high intensity',
                intensity: 'High',
                muscleGroups: ['full-body']
            },
            2: { // Tuesday
                type: 'Strength',
                focus: 'Upper body push & pull',
                intensity: 'Medium-High',
                muscleGroups: ['chest', 'back', 'shoulders', 'arms']
            },
            3: { // Wednesday
                type: 'Recovery & Stretching',
                focus: 'Active recovery and deep stretching',
                intensity: 'Low'
            },
            4: { // Thursday
                type: 'Strength',
                focus: 'Lower body & core',
                intensity: 'Medium-High',
                muscleGroups: ['legs', 'glutes', 'core']
            },
            5: { // Friday
                type: 'Cross Training',
                focus: 'Functional fitness & conditioning',
                intensity: 'Medium-High',
                muscleGroups: ['full-body']
            },
            6: { // Saturday
                type: 'HIIT',
                focus: 'Metabolic conditioning',
                intensity: 'High',
                muscleGroups: ['full-body']
            }
        };
        
        const exerciseDatabase = {
            warmup: [
                { name: 'Jumping Jacks', duration: 2, description: 'Full body dynamic warm-up', tips: 'Keep a steady rhythm and land softly on your feet', video: 'https://www.youtube.com/watch?v=2W4ZNSwoW_4' },
                { name: 'Arm Circles & Shoulder Rolls', duration: 2, description: 'Dynamic shoulder mobility', tips: 'Make large circles, both forward and backward', video: 'https://www.youtube.com/watch?v=5NRUMZv6yvw' },
                { name: 'Leg Swings', duration: 1, description: 'Hip mobility and activation', tips: 'Swing each leg forward/back and side to side', video: 'https://www.youtube.com/watch?v=4aoSKXXupYM' },
                { name: 'Inchworms', duration: 2, description: 'Full body mobility', tips: 'Walk hands out to plank, walk feet to hands', video: 'https://www.youtube.com/watch?v=qJbfN7B5UzM' },
                { name: 'Bodyweight Squats', duration: 2, description: 'Lower body activation', tips: 'Full range of motion, controlled tempo', video: 'https://www.youtube.com/watch?v=aclHkVaku9U' }
            ],
            
            // HIIT Exercises (Monday & Saturday - Full Body)
            hiit: [
                { name: 'Dumbbell Burpee Clean and Press', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Full body explosive HIIT with dumbbells', tips: 'Burpee with dumbbells, clean to shoulders, press overhead', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=I1kK4b2kram' },
                { name: 'Barbell Thrusters', duration: 3, reps: '30 sec work / 30 sec rest', description: 'High intensity squat to press', tips: 'Explosive squat, drive barbell overhead without pause', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=L219ltL15zk' },
                { name: 'Dumbbell Squat Jumps', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Weighted explosive lower body power', tips: 'Hold light dumbbells at sides, land softly, explode up', muscleGroups: ['legs', 'glutes'], video: 'https://www.youtube.com/watch?v=Azl5lVCwzjc' },
                { name: 'Kettlebell Swings (HIIT Pace)', duration: 3, reps: '40 sec work / 20 sec rest', description: 'High intensity hip power', tips: 'Explosive hip snap, maximum pace, tight core', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=YSxHifyI6s8' },
                { name: 'Dumbbell Alternating Snatches', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Single arm explosive power', tips: 'Pull dumbbell from ground to overhead, alternate arms rapidly', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=mTBfURv6zQg' },
                { name: 'Barbell or Dumbbell Push Press', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Upper body explosive power', tips: 'Dip knees, drive weight overhead explosively', muscleGroups: ['shoulders', 'legs'], video: 'https://www.youtube.com/watch?v=iaBVSJm78ko' },
                { name: 'Dumbbell Man Makers (Fast Pace)', duration: 4, reps: '20 sec work / 40 sec rest', description: 'Ultimate weighted HIIT movement', tips: 'Burpee + row + clean + press. Maximum intensity', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=Pf7wZvraWV0' },
                { name: 'Barbell High Pulls', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Explosive pulling power', tips: 'Pull bar to chest height, elbows high, fast tempo', muscleGroups: ['back', 'shoulders'], video: 'https://www.youtube.com/watch?v=3NFeid8fAcY' },
                { name: 'Dumbbell Devil Press', duration: 3, reps: '20 sec work / 40 sec rest', description: 'Advanced weighted burpee variation', tips: 'Burpee with dumbbells, swing to overhead in one motion', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=UJUBq0EzsZw' },
                { name: 'Kettlebell Goblet Jump Squats', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Weighted plyometric legs', tips: 'Hold kettlebell at chest, jump explosively', muscleGroups: ['legs', 'glutes'], video: 'https://www.youtube.com/watch?v=XaF0E7kmDZU' },
                { name: 'Burpees (Bodyweight)', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Classic HIIT bodyweight movement', tips: 'Maximum speed, full extension, chest to ground', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=JZQA08SlJnM' },
                { name: 'Mountain Climbers', duration: 3, reps: '40 sec work / 20 sec rest', description: 'High intensity core and cardio', tips: 'Drive knees fast, maintain plank position', muscleGroups: ['core', 'shoulders'], video: 'https://www.youtube.com/watch?v=nmwgirgXLYM' }
            ],
            
            // Upper Body Strength (Tuesday)
            strengthUpper: [
                { name: 'Barbell Bench Press', duration: 4, reps: '4 sets of 8-10 reps', description: 'Primary chest builder with barbell', tips: 'Lower bar to chest, press explosively, keep feet planted', muscleGroups: ['chest', 'triceps', 'shoulders'], video: 'https://www.youtube.com/watch?v=rT7DgCr-3pg' },
                { name: 'Dumbbell Rows', duration: 4, reps: '4 sets of 10-12 per arm', description: 'Unilateral back strength', tips: 'Support on bench, pull dumbbell to hip, squeeze shoulder blade', muscleGroups: ['back', 'biceps'], video: 'https://www.youtube.com/watch?v=roCP6wCXPqo' },
                { name: 'Barbell Overhead Press', duration: 4, reps: '4 sets of 8 reps', description: 'Shoulder mass and strength builder', tips: 'Press bar from shoulders overhead, tight core throughout', muscleGroups: ['shoulders', 'triceps'], video: 'https://www.youtube.com/watch?v=2yjwXTZQDDI' },
                { name: 'Dumbbell Incline Press', duration: 4, reps: '3 sets of 10-12 reps', description: 'Upper chest development', tips: 'Bench at 30-45¬∞, press dumbbells up and together', muscleGroups: ['chest', 'shoulders'], video: 'https://www.youtube.com/watch?v=8iPEnn-ltC8' },
                { name: 'Barbell or Dumbbell Curls', duration: 3, reps: '3 sets of 12 reps', description: 'Bicep isolation and growth', tips: 'Keep elbows stationary, full range of motion, control the negative', muscleGroups: ['biceps'], video: 'https://www.youtube.com/watch?v=ykJmrZ5v0Oo' },
                { name: 'Dumbbell Shoulder Press', duration: 4, reps: '3 sets of 10 reps', description: 'Shoulder strength and stability', tips: 'Press dumbbells overhead, palms forward or neutral grip', muscleGroups: ['shoulders'], video: 'https://www.youtube.com/watch?v=qEwKCR5JCog' },
                { name: 'Cable or Dumbbell Tricep Extensions', duration: 3, reps: '3 sets of 12-15 reps', description: 'Tricep isolation', tips: 'Keep upper arms still, extend at elbow only', muscleGroups: ['triceps'], video: 'https://www.youtube.com/watch?v=2-LAMcpzODU' },
                { name: 'Pull-ups or Lat Pulldowns', duration: 4, reps: '3 sets of 8-10 reps', description: 'Vertical pulling strength', tips: 'Pull chest to bar or bar to chest, full extension at bottom', muscleGroups: ['back', 'biceps'], video: 'https://www.youtube.com/watch?v=eGo4IYlbE5g' }
            ],
            
            // Lower Body Strength (Thursday)
            strengthLower: [
                { name: 'Barbell Back Squats', duration: 4, reps: '4 sets of 8-10 reps', description: 'King of lower body exercises', tips: 'Bar on upper back, squat to parallel or below, drive through heels', muscleGroups: ['legs', 'glutes'], video: 'https://www.youtube.com/watch?v=ultWZbUMPL8' },
                { name: 'Barbell Romanian Deadlifts', duration: 4, reps: '4 sets of 10 reps', description: 'Hamstring and glute developer', tips: 'Hip hinge, slight knee bend, lower bar to mid-shin', muscleGroups: ['hamstrings', 'glutes'], video: 'https://www.youtube.com/watch?v=6NqBZ62Nk3I' },
                { name: 'Dumbbell Walking Lunges', duration: 4, reps: '3 sets of 10 per leg', description: 'Unilateral leg strength with dumbbells', tips: 'Dumbbells at sides, long stride, knee doesn\'t pass toes', muscleGroups: ['legs', 'glutes'], video: 'https://www.youtube.com/watch?v=D7KaRcUTQeE' },
                { name: 'Leg Press Machine', duration: 4, reps: '4 sets of 12-15 reps', description: 'Quad-dominant leg builder', tips: 'Feet shoulder-width, push through full foot, controlled descent', muscleGroups: ['legs', 'glutes'], video: 'https://www.youtube.com/watch?v=IZxyjW7MPJQ' },
                { name: 'Dumbbell Bulgarian Split Squats', duration: 4, reps: '3 sets of 10 per leg', description: 'Single leg strength with dumbbells', tips: 'Back foot elevated, dumbbell in each hand, vertical torso', muscleGroups: ['legs', 'glutes'], video: 'https://www.youtube.com/watch?v=2C-uNgKwPLE' },
                { name: 'Barbell Hip Thrusts', duration: 3, reps: '3 sets of 12-15 reps', description: 'Maximum glute activation', tips: 'Upper back on bench, barbell on hips, squeeze glutes at top', muscleGroups: ['glutes', 'hamstrings'], video: 'https://www.youtube.com/watch?v=xDmFkJxPzeM' },
                { name: 'Weighted Plank or Ab Wheel', duration: 3, reps: '3 sets of 30-45 sec', description: 'Advanced core strength', tips: 'Add weight plate on back or use ab wheel with control', muscleGroups: ['core'], video: 'https://www.youtube.com/watch?v=9K2LqHMlAto' },
                { name: 'Cable or Dumbbell Woodchops', duration: 3, reps: '3 sets of 12 per side', description: 'Rotational core strength', tips: 'Rotate through torso, keep arms relatively straight', muscleGroups: ['core', 'obliques'], video: 'https://www.youtube.com/watch?v=pAplQXk3dkU' }
            ],
            
            // Cross Training (Friday - Full Body Functional)
            crosstraining: [
                { name: 'Barbell or Dumbbell Thrusters', duration: 4, reps: '12-15 reps', description: 'Full body compound movement', tips: 'Squat with weight, drive up and press overhead in one motion', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=L219ltL15zk' },
                { name: 'Kettlebell Swings', duration: 3, reps: '15-20 swings', description: 'Power endurance with kettlebell', tips: 'Hip hinge, explosive hip drive, kettlebell to shoulder height', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=YSxHifyI6s8' },
                { name: 'Dumbbell Man Makers', duration: 4, reps: '8-10 reps', description: 'Ultimate full body movement', tips: 'Burpee + renegade row + squat clean + press. Total body burner', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=Pf7wZvraWV0' },
                { name: 'Barbell Clean and Press', duration: 4, reps: '8-10 reps', description: 'Olympic lift variation for power', tips: 'Clean bar to shoulders, then press overhead. Explosive movement', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=KwYJTpQ_x5A' },
                { name: 'Dumbbell Snatches', duration: 3, reps: '10 per arm', description: 'Single arm power movement', tips: 'Explosively pull dumbbell from ground to overhead in one motion', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=mTBfURv6zQg' },
                { name: 'Sandbag or Dumbbell Carries', duration: 3, reps: '40-50 meters', description: 'Loaded carry for total body strength', tips: 'Farmer carry, overhead carry, or bear hug carry', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=3BkAxlBlqv8' },
                { name: 'Medicine Ball Slams', duration: 3, reps: '15 reps', description: 'Full body explosive power', tips: 'Reach high with med ball, slam down hard, athletic stance', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=l30OxyJKwFI' },
                { name: 'Kettlebell Turkish Get-Ups', duration: 4, reps: '5 per side', description: 'Total body strength and coordination', tips: 'Move slowly, keep kettlebell overhead, control each position', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=0bWRPC49-KI' },
                { name: 'Barbell Complexes', duration: 4, reps: '6-8 reps each movement', description: 'Multiple exercises without putting bar down', tips: 'Example: deadlift, row, clean, press, squat - all in sequence', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=p7oXcbAP8qo' },
                { name: 'Dumbbell Box Step-Ups', duration: 3, reps: '12 per leg', description: 'Weighted single leg power', tips: 'Hold dumbbells, step up explosively, drive through heel', muscleGroups: ['legs', 'glutes'], video: 'https://www.youtube.com/watch?v=dQqApCGd5Ss' }
            ],
            
            // Recovery & Stretching (Wednesday & Sunday)
            stretching: [
                { name: 'Deep Breathing & Meditation', duration: 3, description: 'Mental recovery and breath work', tips: 'Focus on slow, deep breaths. Clear your mind', video: 'https://www.youtube.com/watch?v=Jyy0ra2WcQQ' },
                { name: 'Cat-Cow Stretch', duration: 2, description: 'Spinal mobility and flexibility', tips: 'Move slowly between arched and rounded back positions', video: 'https://www.youtube.com/watch?v=kqnua4rHVVA' },
                { name: 'World\'s Greatest Stretch', duration: 3, description: 'Full body dynamic mobility', tips: 'Lunge position with rotation, hold and breathe deeply', video: 'https://www.youtube.com/watch?v=0GSe6dzHhJo' },
                { name: 'Pigeon Pose', duration: 3, description: 'Deep hip opener', tips: 'Hold each side for 90 seconds, breathe through discomfort', video: 'https://www.youtube.com/watch?v=0_zPqA65Npo' },
                { name: 'Seated Forward Fold', duration: 2, description: 'Hamstring and lower back stretch', tips: 'Reach for toes, keep back straight, hold the stretch', video: 'https://www.youtube.com/watch?v=3K6Rq_XT_F0' },
                { name: 'Thread the Needle', duration: 2, description: 'Shoulder and upper back mobility', tips: 'Thread arm under body, feel stretch in shoulder', video: 'https://www.youtube.com/watch?v=DblhRKCnUcE' },
                { name: 'Couch Stretch', duration: 3, description: 'Hip flexor deep stretch', tips: 'Back knee against wall, drive hips forward gently', video: 'https://www.youtube.com/watch?v=B0RKLLKbvfk' },
                { name: 'Chest Opener on Foam Roller', duration: 2, description: 'Thoracic spine and chest stretch', tips: 'Lie on roller, arms out wide, breathe deeply', video: 'https://www.youtube.com/watch?v=RjJ6iJ7q4Rg' },
                { name: 'Frog Stretch', duration: 3, description: 'Inner thigh and hip mobility', tips: 'Knees wide, slowly sink hips back, hold position', video: 'https://www.youtube.com/watch?v=mJFCy0TU3Us' },
                { name: 'Supine Twist', duration: 2, description: 'Spinal rotation and release', tips: 'Knees fall to one side, shoulders flat, hold each side', video: 'https://www.youtube.com/watch?v=RpFU-Z7AjP4' },
                { name: 'Standing Quad Stretch', duration: 2, description: 'Front of leg flexibility', tips: 'Pull heel to glutes, hold for 60 seconds each leg', video: 'https://www.youtube.com/watch?v=k_Jd7V9tjjo' },
                { name: 'Downward Dog', duration: 2, description: 'Full body stretch and recovery', tips: 'Press heels toward ground, straighten legs gradually', video: 'https://www.youtube.com/watch?v=h0-gDoGRMcw' },
                { name: 'Child\'s Pose', duration: 3, description: 'Restorative full body relaxation', tips: 'Sink hips to heels, reach arms forward, breathe deeply', video: 'https://www.youtube.com/watch?v=2MSDxLGN51k' },
                { name: 'Shoulder Rolls & Neck Stretches', duration: 2, description: 'Upper body tension release', tips: 'Gentle circles, hold neck stretches for 30 seconds', video: 'https://www.youtube.com/watch?v=L1rKFAZnUYM' }
            ],
            
            cooldown: [
                { name: 'Walk and Breathe', duration: 2, description: 'Active recovery to lower heart rate', tips: 'Deep breaths, slow pace, let heart rate come down', video: 'https://www.youtube.com/watch?v=Jyy0ra2WcQQ' },
                { name: 'Standing Quad Stretch', duration: 1, description: 'Front of leg flexibility', tips: 'Hold ankle, pull heel to glutes, keep knees together', video: 'https://www.youtube.com/watch?v=k_Jd7V9tjjo' },
                { name: 'Hamstring Stretch', duration: 1, description: 'Posterior chain flexibility', tips: 'Reach toward toes, keep back straight', video: 'https://www.youtube.com/watch?v=D1XvVxHhwAo' },
                { name: 'Hip Flexor Stretch', duration: 1, description: 'Hip mobility and flexibility', tips: 'Lunge position, drive hips forward gently', video: 'https://www.youtube.com/watch?v=aIVn7x96o9k' },
                { name: 'Shoulder & Chest Stretch', duration: 1, description: 'Upper body flexibility', tips: 'Hands behind back, open chest, pull shoulders back', video: 'https://www.youtube.com/watch?v=bjYH9BLt9yw' },
                { name: 'Child\'s Pose', duration: 2, description: 'Full body relaxation stretch', tips: 'Sink hips to heels, reach arms forward, breathe deeply', video: 'https://www.youtube.com/watch?v=2MSDxLGN51k' },
                { name: 'Spinal Twist', duration: 1, description: 'Back and core mobility', tips: 'Seated or lying, gentle twist to each side', video: 'https://www.youtube.com/watch?v=RpFU-Z7AjP4' }
            ],
            
            // Circuit Training - Station-based workouts
            circuit: [
                { name: 'Battle Ropes', duration: 3, reps: '45 sec work / 15 sec rest', description: 'Upper body and core conditioning', tips: 'Create waves with intensity, engage core throughout', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=u22ZHzCHeQA' },
                { name: 'Box Jumps', duration: 3, reps: '45 sec work / 15 sec rest', description: 'Explosive leg power', tips: 'Land softly, full hip extension at top', muscleGroups: ['legs'], video: 'https://www.youtube.com/watch?v=52r_Ul5k03g' },
                { name: 'Rowing Machine Intervals', duration: 3, reps: '45 sec work / 15 sec rest', description: 'Full body cardio power', tips: 'Drive with legs first, pull with back', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=4YRM3i2XQ5k' },
                { name: 'Medicine Ball Slams', duration: 3, reps: '45 sec work / 15 sec rest', description: 'Full body explosive power', tips: 'Reach high, slam down hard with control', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=l30OxyJKwFI' },
                { name: 'Jump Rope', duration: 3, reps: '60 sec work / 30 sec rest', description: 'Cardio and coordination', tips: 'Stay on balls of feet, small wrist circles', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=hCvbuEwmw4I' },
                { name: 'Assault Bike Sprints', duration: 3, reps: '30 sec sprint / 30 sec rest', description: 'Maximum effort cardio', tips: 'All-out effort, push and pull handles', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=pS4YYzh2kqY' },
                { name: 'Sled Push', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Leg and core power', tips: 'Low body position, drive through legs', muscleGroups: ['legs', 'core'], video: 'https://www.youtube.com/watch?v=Yq7EJW-LTG0' },
                { name: 'TRX Rows', duration: 3, reps: '45 sec work / 15 sec rest', description: 'Bodyweight back strength', tips: 'Body straight, pull chest to hands', muscleGroups: ['back'], video: 'https://www.youtube.com/watch?v=tAZXMyWSSgY' },
                { name: 'Farmer Carries', duration: 3, reps: '45 sec walk / 15 sec rest', description: 'Grip and core endurance', tips: 'Heavy weights, upright posture, controlled walk', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=3BkAxlBlqv8' },
                { name: 'Wall Balls', duration: 3, reps: '45 sec work / 15 sec rest', description: 'Full body power endurance', tips: 'Full squat, explosive throw to target', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=fpUD0Im327g' }
            ],
            
            // Cardio/Aerobic - Endurance and interval training
            cardio: [
                { name: 'Treadmill Sprints', duration: 4, reps: '30 sec sprint / 90 sec walk', description: 'Running speed intervals', tips: 'Maximum effort sprints, active recovery between', muscleGroups: ['legs'], video: 'https://www.youtube.com/watch?v=M0uO8X3_tEA' },
                { name: 'Rowing Intervals', duration: 4, reps: '500m hard / 2 min easy', description: 'Full body cardio intervals', tips: 'Drive with legs, maintain form when tired', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=4YRM3i2XQ5k' },
                { name: 'Assault Bike HIIT', duration: 4, reps: '20 sec max / 40 sec easy', description: 'Upper and lower body cardio', tips: 'All-out on work intervals, pedal easy on rest', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=pS4YYzh2kqY' },
                { name: 'Stair Climbing', duration: 5, reps: 'Continuous', description: 'Lower body cardio endurance', tips: 'Maintain steady pace, use full foot', muscleGroups: ['legs'], video: 'https://www.youtube.com/watch?v=0ba8rIjbJxw' },
                { name: 'Jump Rope Intervals', duration: 3, reps: '60 sec on / 30 sec off', description: 'Cardio and coordination', tips: 'Stay light on feet, maintain rhythm', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=hCvbuEwmw4I' },
                { name: 'Cycling Intervals', duration: 5, reps: '2 min hard / 2 min easy', description: 'Leg endurance and power', tips: 'High resistance on hard intervals, spin easy between', muscleGroups: ['legs'], video: 'https://www.youtube.com/watch?v=b4Ek43fMJlE' },
                { name: 'Burpee Ladder', duration: 4, reps: '10-9-8-7-6-5-4-3-2-1', description: 'Descending rep cardio challenge', tips: 'Pace yourself, maintain form throughout', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=JZQA08SlJnM' },
                { name: 'Swimming Intervals', duration: 5, reps: '50m fast / 50m easy', description: 'Full body low-impact cardio', tips: 'Maintain technique even when tired', muscleGroups: ['full-body'], video: 'https://www.youtube.com/watch?v=E5FtoyuE9k4' },
                { name: 'Mountain Climber Intervals', duration: 3, reps: '40 sec on / 20 sec off', description: 'Bodyweight cardio', tips: 'Fast pace, maintain plank position', muscleGroups: ['core', 'full-body'], video: 'https://www.youtube.com/watch?v=nmwgirgXLYM' }
            ]
        };

        // Seeded random number generator for consistent daily workouts
        function seededRandom(seed) {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        function getDailySeed() {
            const today = new Date();
            return today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
        }

        function shuffleArray(array, seed) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Generate single day workout based on user selection
        function generateSingleDayWorkout() {
            const workoutType = workoutPreferences.singleWorkoutType;
            if (!workoutType) {
                alert('Please select a workout type in customization');
                return;
            }
            
            const workout = generateWorkoutByType(workoutType, getDailySeed());
            displayWorkout(workout);
        }

        // Generate weekly or monthly plan
        function generatePlan() {
            const planType = workoutPreferences.planType;
            const numDays = planType === 'weekly' ? 7 : 30;
            
            // Create array of workout types based on user's mix
            const workoutPlan = [];
            for (let [type, count] of Object.entries(workoutPreferences.workoutMix)) {
                for (let i = 0; i < count; i++) {
                    workoutPlan.push(type);
                }
            }
            
            // Shuffle the plan
            const shuffled = shuffleArray(workoutPlan, getDailySeed());
            
            // Store plan
            workoutPreferences.currentPlan = {
                type: planType,
                startDate: new Date().toISOString().split('T')[0],
                workouts: shuffled.map((type, index) => ({
                    day: index,
                    type: type,
                    dayName: planType === 'weekly' ? ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][index] : `Day ${index + 1}`
                }))
            };
            
            // Save plan
            savePreferences();
            
            // Display plan calendar
            displayPlan();
        }

        // Display plan as clickable calendar/list
        function displayPlan() {
            const plan = workoutPreferences.currentPlan;
            if (!plan) return;
            
            const container = document.getElementById('workoutContainer');
            
            const typeIcons = {
                'hiit': 'üî•',
                'upper-strength': 'üí™',
                'lower-strength': 'ü¶µ',
                'full-body-hiit': 'üî•üí™',
                'full-body-strength': 'üí™ü¶µ',
                'cross-training': '‚ö°',
                'circuit': 'üîÑ',
                'cardio': 'üèÉ',
                'recovery': 'üßò'
            };
            
            const typeNames = {
                'hiit': 'HIIT',
                'upper-strength': 'Upper Body',
                'lower-strength': 'Lower Body',
                'full-body-hiit': 'Full Body HIIT',
                'full-body-strength': 'Full Body Strength',
                'cross-training': 'Cross Training',
                'circuit': 'Circuit Training',
                'cardio': 'Cardio',
                'recovery': 'Recovery'
            };
            
            let html = `
                <div class="workout-summary">
                    <h2 style="margin-bottom: 1.5rem;">${plan.type === 'weekly' ? 'üìÖ Your Weekly Plan' : 'üìÖ Your Monthly Plan'}</h2>
                    <p style="margin-bottom: 2rem; color: rgba(255, 255, 255, 0.8);">Click on any day to see the full workout</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(${plan.type === 'weekly' ? '130px' : '100px'}, 1fr)); gap: 1rem;">
                        ${plan.workouts.map((workout, index) => `
                            <div onclick="showDayWorkout(${index})" style="
                                background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(247, 201, 72, 0.2));
                                border: 2px solid var(--energy-orange);
                                border-radius: 12px;
                                padding: 1rem;
                                cursor: pointer;
                                transition: all 0.3s;
                                text-align: center;
                            " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(255, 107, 53, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">${typeIcons[workout.type]}</div>
                                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.3rem;">${workout.dayName}</div>
                                <div style="font-size: 0.8rem; color: var(--electric-yellow);">${typeNames[workout.type]}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="document.getElementById('workoutContainer').classList.add('hidden')" style="margin-top: 2rem; background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Close Plan</button>
                </div>
            `;
            
            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        // Show specific day's workout from plan
        window.showDayWorkout = function(dayIndex) {
            const plan = workoutPreferences.currentPlan;
            if (!plan) return;
            
            const dayWorkout = plan.workouts[dayIndex];
            const seed = getDailySeed() + dayIndex; // Different seed per day
            
            const workout = generateWorkoutByType(dayWorkout.type, seed);
            workout.dayName = dayWorkout.dayName;
            workout.workoutType = dayWorkout.type.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            displayWorkout(workout);
        }

        // Generate workout by type
        function generateWorkoutByType(type, seed) {
            const durations = adjustWorkoutDuration();
            let exercises = [];
            let workoutType = '';
            let workoutFocus = '';
            
            // Get exercises based on type
            let mainExercises = [];
            switch(type) {
                case 'hiit':
                    mainExercises = exerciseDatabase.hiit;
                    workoutType = 'HIIT';
                    workoutFocus = 'High Intensity Interval Training';
                    break;
                case 'upper-strength':
                    mainExercises = exerciseDatabase.strengthUpper;
                    workoutType = 'Strength';
                    workoutFocus = 'Upper Body Strength';
                    break;
                case 'lower-strength':
                    mainExercises = exerciseDatabase.strengthLower;
                    workoutType = 'Strength';
                    workoutFocus = 'Lower Body Strength';
                    break;
                case 'full-body-hiit':
                    // Mix HIIT with some strength exercises
                    mainExercises = [...exerciseDatabase.hiit.slice(0, 4), ...exerciseDatabase.strengthUpper.slice(0, 2), ...exerciseDatabase.strengthLower.slice(0, 2)];
                    workoutType = 'Full Body HIIT';
                    workoutFocus = 'Full Body High Intensity';
                    break;
                case 'full-body-strength':
                    // Mix upper and lower strength
                    mainExercises = [...exerciseDatabase.strengthUpper.slice(0, 4), ...exerciseDatabase.strengthLower.slice(0, 4)];
                    workoutType = 'Full Body Strength';
                    workoutFocus = 'Complete Body Strength';
                    break;
                case 'cross-training':
                    mainExercises = exerciseDatabase.crosstraining;
                    workoutType = 'Cross Training';
                    workoutFocus = 'Functional Fitness';
                    break;
                case 'circuit':
                    mainExercises = exerciseDatabase.circuit;
                    workoutType = 'Circuit Training';
                    workoutFocus = 'Circuit Stations';
                    break;
                case 'cardio':
                    mainExercises = exerciseDatabase.cardio;
                    workoutType = 'Cardio';
                    workoutFocus = 'Cardiovascular Endurance';
                    break;
                case 'recovery':
                    // Special handling for recovery
                    mainExercises = exerciseDatabase.stretching;
                    workoutType = 'Recovery';
                    workoutFocus = 'Active Recovery & Stretching';
                    break;
            }
            
            // Build workout
            let totalTime = 0;
            
            // Warmup (skip for recovery)
            if (type !== 'recovery') {
                const warmupExercises = shuffleArray(exerciseDatabase.warmup, seed);
                let warmupTime = 0;
                warmupExercises.forEach(exercise => {
                    if (warmupTime < durations.warmup) {
                        exercises.push({ ...exercise, category: 'Warm-up' });
                        totalTime += exercise.duration;
                        warmupTime += exercise.duration;
                    }
                });
            }
            
            // Main workout
            let filteredExercises = filterExercisesByPreferences(mainExercises);
            let shuffledMain = shuffleArray(filteredExercises, seed + 100);
            let mainTime = 0;
            
            shuffledMain.forEach(exercise => {
                if (mainTime < durations.main) {
                    const adjustedEx = adjustExerciseDifficulty(exercise);
                    exercises.push({ 
                        ...adjustedEx, 
                        category: type === 'recovery' ? 'Recovery Stretch' : workoutType
                    });
                    totalTime += adjustedEx.duration;
                    mainTime += adjustedEx.duration;
                }
            });
            
            // Cooldown (skip for recovery)
            if (type !== 'recovery') {
                const cooldownExercises = shuffleArray(exerciseDatabase.cooldown, seed + 200);
                let cooldownTime = 0;
                cooldownExercises.forEach(exercise => {
                    if (cooldownTime < durations.cooldown) {
                        exercises.push({ ...exercise, category: 'Cool-down' });
                        totalTime += exercise.duration;
                        cooldownTime += exercise.duration;
                    }
                });
            }
            
            return {
                exercises,
                totalTime,
                workoutType,
                workoutFocus,
                dayName: new Date().toLocaleDateString('en-US', { weekday: 'long' })
            };
        }

        function generateWorkout() {
            const seed = getDailySeed();
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Get today's scheduled workout
            const todaySchedule = weeklySchedule[dayOfWeek];
            const workoutType = todaySchedule.type;
            
            // Get adjusted durations
            const durations = adjustWorkoutDuration();
            
            let workout = [];
            let totalTime = 0;

            // Stretching days (Wednesday & Sunday) - different structure
            if (workoutType === 'Recovery & Stretching') {
                // Light warmup
                const lightWarmup = [
                    { name: 'Gentle Walking', duration: 2, description: 'Easy pace to warm up', tips: 'Start slow, gradually increase pace slightly', category: 'Warm-up' },
                    { name: 'Arm Swings', duration: 1, description: 'Dynamic shoulder mobility', tips: 'Gentle swinging motions, loosen shoulders', category: 'Warm-up' }
                ];
                lightWarmup.forEach(ex => {
                    workout.push(ex);
                    totalTime += ex.duration;
                });

                // Main stretching session
                const stretchingExercises = shuffleArray(exerciseDatabase.stretching, seed);
                let stretchTime = 0;
                const stretchDuration = durations.main;
                stretchingExercises.forEach(exercise => {
                    if (stretchTime < stretchDuration) {
                        workout.push({ ...exercise, category: 'Recovery Stretch' });
                        totalTime += exercise.duration;
                        stretchTime += exercise.duration;
                    }
                });

                // Relaxation cooldown
                workout.push({
                    name: 'Savasana / Final Relaxation',
                    duration: durations.cooldown,
                    description: 'Complete body relaxation',
                    tips: 'Lie flat, close eyes, focus on breathing and letting go of tension',
                    category: 'Cool-down'
                });
                totalTime += durations.cooldown;

                return {
                    exercises: workout,
                    totalTime,
                    workoutType,
                    workoutFocus: todaySchedule.focus,
                    dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                    weekInfo: getWeekInfo(dayOfWeek)
                };
            }

            // Regular workout days - Warmup
            const warmupExercises = shuffleArray(exerciseDatabase.warmup, seed);
            let warmupTime = 0;
            warmupExercises.forEach(exercise => {
                if (warmupTime < durations.warmup) {
                    workout.push({ ...exercise, category: 'Warm-up' });
                    totalTime += exercise.duration;
                    warmupTime += exercise.duration;
                }
            });

            // Main workout - based on day of week
            let mainWorkout = [];
            let mainTime = 0;
            
            if (workoutType === 'HIIT') {
                // Monday & Saturday - HIIT Full Body
                let hiitExercises = shuffleArray(exerciseDatabase.hiit, seed + 1);
                hiitExercises = filterExercisesByPreferences(hiitExercises);
                const numExercises = durations.main <= 15 ? 4 : durations.main >= 35 ? 8 : 6;
                const selectedExercises = hiitExercises.slice(0, numExercises);
                
                // Do rounds based on duration
                const rounds = durations.main <= 15 ? 3 : 4;
                for (let round = 1; round <= rounds; round++) {
                    selectedExercises.forEach((exercise) => {
                        if (mainTime < durations.main) {
                            const adjustedExercise = adjustExerciseDifficulty(exercise);
                            mainWorkout.push({ 
                                ...adjustedExercise, 
                                category: `HIIT - Round ${round}`,
                                roundInfo: `Round ${round} of ${rounds}`
                            });
                            mainTime += adjustedExercise.duration;
                        }
                    });
                }
            } else if (workoutType === 'Strength' && dayOfWeek === 2) {
                // Tuesday - Upper Body Strength
                let upperExercises = shuffleArray(exerciseDatabase.strengthUpper, seed + 2);
                upperExercises = filterExercisesByPreferences(upperExercises);
                upperExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Upper Body Strength' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            } else if (workoutType === 'Strength' && dayOfWeek === 4) {
                // Thursday - Lower Body & Core Strength
                let lowerExercises = shuffleArray(exerciseDatabase.strengthLower, seed + 3);
                lowerExercises = filterExercisesByPreferences(lowerExercises);
                lowerExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Lower Body & Core' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            } else if (workoutType === 'Cross Training') {
                // Friday - Cross Training
                let crossExercises = shuffleArray(exerciseDatabase.crosstraining, seed + 4);
                crossExercises = filterExercisesByPreferences(crossExercises);
                crossExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Cross Training' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            }

            workout = workout.concat(mainWorkout);
            totalTime += mainTime;

            // Cooldown
            const cooldownExercises = shuffleArray(exerciseDatabase.cooldown, seed + 5);
            let cooldownTime = 0;
            cooldownExercises.forEach(exercise => {
                if (cooldownTime < durations.cooldown) {
                    workout.push({ ...exercise, category: 'Cool-down' });
                    totalTime += exercise.duration;
                    cooldownTime += exercise.duration;
                }
            });

            return { 
                exercises: workout, 
                totalTime,
                workoutType,
                workoutFocus: todaySchedule.focus,
                dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                weekInfo: getWeekInfo(dayOfWeek)
            };
        }

        function getWeekInfo(currentDay) {
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return daysOfWeek.map((day, index) => ({
                day,
                type: weeklySchedule[index].type,
                isCurrent: index === currentDay,
                focus: weeklySchedule[index].focus
            }));
        }

        function displayWorkout(workout) {
            const container = document.getElementById('workoutContainer');
            
            // Get workout type badge color
            const typeColors = {
                'HIIT': 'var(--energy-orange)',
                'Strength': 'var(--vibrant-cyan)',
                'Cross Training': 'var(--electric-yellow)',
                'Recovery & Stretching': '#9B59B6'
            };

            // Create weekly schedule display
            const weekScheduleHtml = `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.08em; margin-bottom: 1rem; color: var(--electric-yellow);">Weekly Training Schedule</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem;">
                        ${workout.weekInfo.map(dayInfo => `
                            <div style="
                                background: ${dayInfo.isCurrent ? 'linear-gradient(135deg, var(--energy-orange), #FF8C42)' : 'rgba(255, 255, 255, 0.03)'};
                                padding: 0.75rem 0.5rem;
                                border-radius: 8px;
                                text-align: center;
                                border: ${dayInfo.isCurrent ? '2px solid var(--electric-yellow)' : '1px solid rgba(255, 255, 255, 0.1)'};
                                ${dayInfo.isCurrent ? 'box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);' : ''}
                            ">
                                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.3rem; ${dayInfo.isCurrent ? 'color: white;' : 'color: rgba(255, 255, 255, 0.9);'}">${dayInfo.day}</div>
                                <div style="font-size: 0.65rem; ${dayInfo.isCurrent ? 'color: rgba(255, 255, 255, 0.95);' : 'color: rgba(255, 255, 255, 0.5);'} text-transform: uppercase; letter-spacing: 0.05em;">
                                    ${dayInfo.type === 'Recovery & Stretching' ? 'üßò Recovery' : 
                                      dayInfo.type === 'HIIT' ? 'üî• HIIT' : 
                                      dayInfo.type === 'Strength' ? 'üí™ Strength' : 
                                      '‚ö° Cross'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            let html = `
                ${weekScheduleHtml}
                <div class="workout-summary">
                    <div style="display: inline-block; background: ${typeColors[workout.workoutType]}; color: var(--deep-charcoal); padding: 0.5rem 1.5rem; border-radius: 50px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem;">
                        ${workout.dayName} - ${workout.workoutType}
                    </div>
                    <h2>${workout.workoutFocus}</h2>
                    
                    <!-- Preferences Display -->
                    <div style="background: rgba(156, 39, 176, 0.15); padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid rgba(156, 39, 176, 0.3);">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">‚öôÔ∏è</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px;">${workoutPreferences.duration} min</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; text-transform: capitalize;">${workoutPreferences.difficulty}</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; text-transform: capitalize;">${workoutPreferences.equipment.replace('-', ' ')}</span>
                            ${workoutPreferences.injuries.length > 0 ? `<span style="font-size: 0.85rem; background: rgba(255, 107, 53, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px;">‚ö†Ô∏è ${workoutPreferences.injuries.length} modification${workoutPreferences.injuries.length > 1 ? 's' : ''}</span>` : ''}
                            <button onclick="showPreferencesModal()" style="margin-left: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 0.4rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.85rem;">Change</button>
                        </div>
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Time</div>
                            <div class="summary-value">${workout.totalTime} MIN</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Exercises</div>
                            <div class="summary-value">${workout.exercises.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Focus</div>
                            <div class="summary-value" style="font-size: 1.1rem; text-transform: uppercase;">
                                ${workout.workoutType === 'Recovery & Stretching' ? 'Recovery' : workout.workoutType}
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Intensity</div>
                            <div class="summary-value" style="font-size: 1.5rem;">
                                ${workout.workoutType === 'HIIT' ? 'üî•üî•üî•' : 
                                  workout.workoutType === 'Strength' ? 'üí™üí™' : 
                                  workout.workoutType === 'Cross Training' ? '‚ö°‚ö°‚ö°' : 
                                  'üßò‚Äç‚ôÄÔ∏è'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            workout.exercises.forEach((exercise, index) => {
                const repsInfo = exercise.reps ? `
                    <div style="background: rgba(247, 201, 72, 0.15); padding: 0.75rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(247, 201, 72, 0.3);">
                        <div style="font-weight: 700; color: var(--electric-yellow); margin-bottom: 0.3rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em;">Target</div>
                        <div style="color: rgba(255, 255, 255, 0.9);">${exercise.reps}</div>
                    </div>
                ` : '';

                const roundInfo = exercise.roundInfo ? `
                    <div style="display: inline-block; background: rgba(255, 107, 53, 0.2); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; color: var(--energy-orange);">
                        ${exercise.roundInfo}
                    </div>
                ` : '';

                // Video demonstration button
                const videoButton = exercise.video ? `
                    <a href="${exercise.video}" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #FF0000, #CC0000); color: white; text-decoration: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 700; font-size: 0.9rem; margin-top: 1rem; box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3); transition: all 0.3s ease;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        Watch Form Video
                    </a>
                ` : '';

                // Performance tracking for non-stretching exercises
                const performanceTracking = exercise.category !== 'Recovery Stretch' && exercise.category !== 'Warm-up' && exercise.category !== 'Cool-down' ? `
                    <div style="background: rgba(0, 217, 255, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(0, 217, 255, 0.3);">
                        <div style="font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 0.75rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em;">üìà Track Performance</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Reps/Time</label>
                                <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="reps" placeholder="e.g., 15" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Weight/Level</label>
                                <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="weight" placeholder="e.g., 20lbs" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Notes</label>
                            <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="notes" placeholder="How did it feel?" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                        </div>
                        <button onclick="savePerformance('${exercise.name}')" style="margin-top: 0.75rem; background: var(--vibrant-cyan); color: var(--deep-charcoal); border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 700; font-size: 0.85rem; cursor: pointer; width: 100%; text-transform: uppercase; letter-spacing: 0.05em;">Save</button>
                        <div id="history-${exercise.name.replace(/\s+/g, '-')}" style="margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);"></div>
                    </div>
                ` : '';

                html += `
                    <div class="exercise-block" style="animation-delay: ${index * 0.05}s">
                        <div class="exercise-header">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--electric-yellow); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">
                                    ${exercise.category} ${roundInfo}
                                </div>
                                <div class="exercise-name">${exercise.name}</div>
                            </div>
                            <div class="exercise-duration">${exercise.duration} MIN</div>
                        </div>
                        <div class="exercise-description">${exercise.description}</div>
                        ${repsInfo}
                        ${videoButton}
                        <div class="exercise-tips">
                            <div class="tips-title">üí° Pro Tip</div>
                            <div>${exercise.tips}</div>
                        </div>
                        ${performanceTracking}
                        <div class="timer-bar"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.classList.remove('hidden');
            container.style.opacity = '0';
            
            setTimeout(() => {
                container.style.animation = 'fadeInUp 0.8s ease-out forwards';
                
                // Add complete workout button
                const completeBtn = document.createElement('div');
                completeBtn.style.cssText = 'text-align: center; margin-top: 2rem;';
                completeBtn.innerHTML = `
                    <button onclick="markWorkoutComplete()" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 1.25rem 3rem; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4); font-family: 'Archivo', sans-serif;">
                        <span style="position: relative; z-index: 1;">‚úì Mark Workout Complete</span>
                    </button>
                `;
                container.appendChild(completeBtn);
            }, 100);
        }

        // Save exercise performance
        window.savePerformance = async function(exerciseName) {
            const inputs = document.querySelectorAll(`[data-exercise="${exerciseName}"]`);
            const perfData = {
                date: new Date().toISOString(),
                reps: '',
                weight: '',
                notes: ''
            };
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                perfData[field] = input.value;
            });
            
            if (perfData.reps || perfData.weight || perfData.notes) {
                await saveExercisePerformance(exerciseName, perfData);
                
                // Show confirmation
                const historyDiv = document.getElementById(`history-${exerciseName.replace(/\s+/g, '-')}`);
                if (historyDiv) {
                    historyDiv.innerHTML = '‚úì Saved! Keep crushing it!';
                    historyDiv.style.color = 'var(--electric-yellow)';
                    setTimeout(() => {
                        loadExerciseHistory(exerciseName);
                    }, 1500);
                }
            }
        }

        // Load exercise history
        async function loadExerciseHistory(exerciseName) {
            const history = await getExerciseHistory(exerciseName, 3);
            const historyDiv = document.getElementById(`history-${exerciseName.replace(/\s+/g, '-')}`);
            if (historyDiv && history.length > 0) {
                const lastEntry = history[0];
                historyDiv.innerHTML = `Last: ${lastEntry.reps || 'N/A'} ${lastEntry.weight ? `@ ${lastEntry.weight}` : ''}`;
                historyDiv.style.color = 'rgba(255, 255, 255, 0.6)';
            }
        }

        // Mark workout complete
        window.markWorkoutComplete = async function() {
            const workoutData = currentWorkout;
            const saved = await saveWorkoutCompletion(workoutData);
            
            if (saved) {
                alert('üéâ Awesome work! Workout marked as complete. Keep building that streak!');
                // Refresh stats if visible
                const statsContainer = document.getElementById('statsContainer');
                if (!statsContainer.classList.contains('hidden')) {
                    displayStats();
                }
            }
        }

        // Display stats and history
        async function displayStats() {
            const container = document.getElementById('statsContainer');
            const stats = await getStats();
            const history = await getWorkoutHistory(30);

            const workoutTypeBreakdown = Object.entries(stats.workoutTypes)
                .map(([type, count]) => `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--vibrant-cyan);">${count}</div>
                        <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.3rem;">${type}</div>
                    </div>
                `).join('');

            const recentWorkouts = history.slice(0, 10).map(w => {
                const date = new Date(w.date);
                const typeEmoji = w.workoutType === 'HIIT' ? 'üî•' : 
                                 w.workoutType === 'Strength' ? 'üí™' : 
                                 w.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
                return `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--energy-orange); margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--pure-white);">${typeEmoji} ${w.workoutType}</div>
                                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-top: 0.2rem;">${w.dayName} - ${w.totalTime} minutes</div>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--electric-yellow);">
                                ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            let html = `
                <div style="animation: fadeInUp 0.8s ease-out;">
                    <div class="workout-summary">
                        <h2>Your Progress & Stats</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Total Workouts</div>
                                <div class="summary-value">${stats.totalWorkouts}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Last 7 Days</div>
                                <div class="summary-value">${stats.last7Days}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Total Minutes</div>
                                <div class="summary-value">${stats.totalMinutes}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Current Streak</div>
                                <div class="summary-value" style="color: var(--electric-yellow);">üî• ${calculateStreak(history)}</div>
                            </div>
                        </div>
                    </div>

                    ${stats.totalWorkouts > 0 ? `
                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Workout Type Breakdown</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                ${workoutTypeBreakdown}
                            </div>
                        </div>

                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Recent Workouts</h3>
                            ${recentWorkouts}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                            <p style="font-size: 1.2rem; margin-bottom: 1rem;">No workouts recorded yet!</p>
                            <p>Complete your first workout to start tracking your progress.</p>
                        </div>
                    `}

                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="hideStats()" style="background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; font-family: 'Archivo', sans-serif;">
                            Back to Workout
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // Hide workout and social containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
        }

        function calculateStreak(history) {
            if (history.length === 0) return 0;
            
            let streak = 0;
            const sortedHistory = history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let i = 0; i < sortedHistory.length; i++) {
                const workoutDate = new Date(sortedHistory[i].date);
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                
                // Check if workout is from expected date (or within same day)
                if (workoutDate.toDateString() === expectedDate.toDateString()) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        window.hideStats = function() {
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        // Social Feed Functions
        async function displaySocialFeed() {
            const container = document.getElementById('socialContainer');
            const friends = await getFriendProfiles();
            const activity = await getFriendsActivity(20);

            let html = `
                <div style="animation: fadeInUp 0.8s ease-out;">
                    <div class="workout-summary">
                        <h2>Friends & Community</h2>
                        <div style="margin-top: 1.5rem;">
                            <label style="display: block; font-size: 0.9rem; color: var(--electric-yellow); margin-bottom: 0.5rem; font-weight: 600;">Add Friend by Email</label>
                            <div style="display: flex; gap: 0.75rem;">
                                <input type="email" id="friendUsernameInput" placeholder="Enter their Google email" style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1rem;">
                                <button onclick="addFriendHandler()" style="background: var(--energy-orange); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer; white-space: nowrap;">Add Friend</button>
                            </div>
                        </div>
                    </div>

                    ${friends.length > 0 ? `
                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Your Friends (${friends.length})</h3>
                            <div style="display: grid; gap: 1rem;">
                                ${await Promise.all(friends.map(async friend => {
                                    const stats = await getFriendStats(friend.id);
                                    return `
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                                                <div>
                                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--pure-white); margin-bottom: 0.3rem;">
                                                        ${friend.displayName}
                                                    </div>
                                                    <div style="color: var(--vibrant-cyan); font-size: 0.9rem;">${friend.email}</div>
                                                </div>
                                                ${stats ? `
                                                    <div style="text-align: right;">
                                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--electric-yellow);">${stats.totalWorkouts}</div>
                                                        <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">workouts</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${stats ? `
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                                    <div>
                                                        <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.2rem;">Total Minutes</div>
                                                        <div style="font-weight: 700; color: var(--vibrant-cyan);">${stats.totalMinutes}</div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.2rem;">Last Workout</div>
                                                        <div style="font-weight: 600; color: rgba(255, 255, 255, 0.9); font-size: 0.85rem;">
                                                            ${stats.lastWorkout ? new Date(stats.lastWorkout).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A'}
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                })).then(items => items.join(''))}
                            </div>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 2rem; margin-top: 2rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 1.1rem;">No friends yet!</p>
                            <p style="color: rgba(255, 255, 255, 0.5); margin-top: 0.5rem;">Add friends to see their progress and stay motivated together.</p>
                        </div>
                    `}

                    ${activity.length > 0 ? `
                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Recent Activity Feed</h3>
                            ${activity.map(act => {
                                const date = new Date(act.date);
                                const typeEmoji = act.workoutType === 'HIIT' ? 'üî•' : 
                                                 act.workoutType === 'Strength' ? 'üí™' : 
                                                 act.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
                                const timeAgo = getTimeAgo(date);
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--energy-orange); margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
                                            <div>
                                                <div style="font-weight: 700; color: var(--pure-white); margin-bottom: 0.3rem;">
                                                    ${act.displayName}
                                                </div>
                                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">${timeAgo}</div>
                                            </div>
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.5rem;">${typeEmoji}</span>
                                                <div>
                                                    <div style="font-weight: 700; color: var(--electric-yellow);">Completed ${act.workoutType}</div>
                                                    <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">${act.dayName} ‚Ä¢ ${act.totalTime} minutes</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : friends.length > 0 ? `
                        <div style="text-align: center; padding: 2rem; margin-top: 2rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                            <p style="color: rgba(255, 255, 255, 0.6);">No recent activity from friends yet.</p>
                        </div>
                    ` : ''}

                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="hideSocial()" style="background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; font-family: 'Archivo', sans-serif;">
                            Back to Workout
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // Hide other containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        window.addFriendHandler = async function() {
            const friendEmail = document.getElementById('friendUsernameInput').value.trim();
            if (!friendEmail) {
                alert('Please enter an email address');
                return;
            }
            
            const success = await addFriend(friendEmail);
            if (success) {
                alert(`Successfully added ${friendEmail} as a friend!`);
                displaySocialFeed(); // Refresh
            } else {
                alert('User not found or already friends. Make sure they\'ve signed in at least once!');
            }
        }

        window.hideSocial = function() {
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        let currentWorkout = null;

        // Generate workout button
        document.getElementById('generateBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            
            const container = document.getElementById('workoutContainer');
            const statsContainer = document.getElementById('statsContainer');
            const socialContainer = document.getElementById('socialContainer');
            
            // Hide stats and social if showing
            statsContainer.classList.add('hidden');
            socialContainer.classList.add('hidden');
            
            // Show loading
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="color: var(--electric-yellow); font-weight: 600; letter-spacing: 0.1em;">GENERATING YOUR WORKOUT...</p>
                </div>
            `;
            container.classList.remove('hidden');
            
            // Simulate loading for effect
            setTimeout(() => {
                // Route based on plan type
                if (workoutPreferences.planType === 'single') {
                    if (!workoutPreferences.singleWorkoutType) {
                        // First time, show customization
                        alert('Please customize your workout first!');
                        showPreferencesModal();
                        return;
                    }
                    generateSingleDayWorkout();
                } else if (workoutPreferences.planType === 'weekly' || workoutPreferences.planType === 'monthly') {
                    // Check if plan exists
                    if (workoutPreferences.currentPlan) {
                        displayPlan();
                    } else {
                        alert('Please customize your workout plan first!');
                        showPreferencesModal();
                    }
                } else {
                    // Default: use old system
                    const workout = generateWorkout();
                    currentWorkout = workout; // Store for completion tracking
                    displayWorkout(workout);
                    
                    // Load exercise histories
                    setTimeout(() => {
                        workout.exercises.forEach(exercise => {
                            if (exercise.category !== 'Recovery Stretch' && 
                                exercise.category !== 'Warm-up' && 
                                exercise.category !== 'Cool-down') {
                                loadExerciseHistory(exercise.name);
                        }
                    });
                }, 500);
            }, 1500);
        });

        // View stats button
        document.getElementById('viewStatsBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displayStats();
        });

        // Customize workout button
        document.getElementById('customizeBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            showPreferencesModal();
        });

        // View social feed button
        document.getElementById('viewSocialBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displaySocialFeed();
        });

        // Auto-initialize on page load
        window.addEventListener('load', async function() {
            await initializeUser();
            await loadPreferences();
            
            if (currentUser) {
                // Show user profile badge
                document.getElementById('userProfileBadge').style.display = 'block';
                document.getElementById('displayNameSpan').textContent = currentUser.displayName;
                document.getElementById('usernameSpan').textContent = currentUser.username;
                
                // Auto-generate workout
                setTimeout(() => {
                    document.getElementById('generateBtn').click();
                }, 500);
            }
        });
    </script>
</body>
</html>
