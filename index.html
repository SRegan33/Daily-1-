<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>35 MINUTE DAILY WORKOUT</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=Archivo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --energy-orange: #FF6B35;
            --electric-yellow: #F7C948;
            --deep-charcoal: #0F0F14;
            --slate: #1A1A24;
            --card-bg: #1E1E2E;
            --vibrant-cyan: #00D9FF;
            --pure-white: #FFFFFF;
            --text-secondary: #94A3B8;
            --border-color: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Archivo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--deep-charcoal);
            color: var(--pure-white);
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.6;
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.02;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 217, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        @media (min-width: 768px) {
            .container {
                padding: 3rem 2rem;
            }
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            letter-spacing: 0.03em;
            background: linear-gradient(135deg, var(--energy-orange), var(--electric-yellow));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.75rem;
            line-height: 1.1;
            font-weight: 700;
        }

        .tagline {
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 600;
        }

        .date-display {
            display: inline-block;
            background: var(--card-bg);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: 0.02em;
            color: var(--text-secondary);
        }

        .generate-btn {
            background: linear-gradient(135deg, var(--energy-orange), #FF8C42);
            color: var(--pure-white);
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-family: 'Inter', 'Archivo', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.6);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .workout-container {
            margin-top: 2rem;
            opacity: 0;
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .workout-summary {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .workout-summary h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 0.05em;
            color: var(--electric-yellow);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .summary-item {
            text-align: center;
            padding: 1.25rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .summary-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .summary-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--vibrant-cyan);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.02em;
        }

        .exercise-block {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.25rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .exercise-block::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--energy-orange), var(--electric-yellow));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .exercise-block:hover::before {
            opacity: 1;
        }

        .exercise-block:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
            gap: 1rem;
        }

        .exercise-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.03em;
            color: var(--pure-white);
            font-weight: 700;
            line-height: 1.2;
        }

        .exercise-duration {
            background: linear-gradient(135deg, var(--energy-orange), #FF8C42);
            padding: 0.5rem 1.25rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }

        .exercise-description {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .exercise-tips {
            background: rgba(0, 217, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            margin-top: 1rem;
        }

        .tips-title {
            font-weight: 700;
            color: var(--vibrant-cyan);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
        }

        .timer-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--energy-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulseKudos {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 3rem;
            }

            .exercise-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <!-- Auth Screen (Google Sign-In) -->
    <div id="authScreen" class="container">
        <header style="text-align: center; padding: 3rem 0 2rem 0; position: relative;">
            <div style="display: inline-block; position: relative;">
                <div style="font-family: 'Bebas Neue', sans-serif; font-size: clamp(2.5rem, 8vw, 4rem); background: linear-gradient(135deg, var(--energy-orange), var(--electric-yellow)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 0.05em; margin-bottom: 0.5rem; font-weight: 700;">
                    CAMP HOPE
                </div>
                <div style="font-size: 0.9rem; color: var(--text-secondary); letter-spacing: 0.2em; text-transform: uppercase; font-weight: 600; margin-bottom: 2rem;">
                    Fitness Program ‚Ä¢ Est. 1995
                </div>
            </div>
            <div style="max-width: 500px; margin: 0 auto; padding: 1.25rem 1.5rem; background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 12px; backdrop-filter: blur(10px);">
                <div style="font-size: 0.9rem; color: var(--text-secondary); font-style: italic; margin-bottom: 0.25rem;">
                    "Lunch has been cancelled due to lack of hustle."
                </div>
                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.4); font-weight: 500;">
                    ‚Äî Tony Perkis
                </div>
            </div>
        </header>
        
        <div style="max-width: 480px; margin: 0 auto; text-align: center;">
            <div class="workout-summary">
                <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--electric-yellow); margin-bottom: 1rem; letter-spacing: 0.03em; font-weight: 700;">
                    I'M FEELING SKINNY, TONY!
                </h2>
                <p style="margin: 1.5rem 0; line-height: 1.7; color: var(--text-secondary); font-size: 0.95rem;">
                    Welcome to Camp Hope! Sign in to track your progress, get fit, and remember: 
                    <span style="color: var(--energy-orange); font-weight: 700;">you're not just a camper, you're a champion!</span>
                </p>
                <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 320px; margin: 2rem auto;">
                    <button onclick="signInWithGoogle()" style="background: white; color: #444; border: none; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; font-family: 'Archivo', sans-serif; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%;">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                    <button onclick="signInWithApple()" style="background: black; color: white; border: none; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; font-family: 'Archivo', sans-serif; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                        </svg>
                        Sign in with Apple
                    </button>
                </div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(255, 107, 53, 0.05); border-radius: 12px; border: 1px solid rgba(255, 107, 53, 0.2);">
                    <div style="font-size: 0.85rem; color: var(--electric-yellow); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                        üèïÔ∏è Camp Hope Promise
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                        No more Mr. Chubby Guy! We're gonna have fun, get fit, and show that scale who's boss!
                    </div>
                </div>
                <p style="margin-top: 1.5rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.3); font-weight: 500;">
                    Your journey is securely tracked with Firebase
                </p>
            </div>
        </div>
    </div>

    <!-- App Screen (Main Application) -->
    <div id="appScreen" class="container" style="display: none;">
        <header style="margin-bottom: 2.5rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h1>CAMP HOPE</h1>
                <p class="tagline">Fitness Program ‚Ä¢ Est. 1995</p>
            </div>
            <div class="date-display" id="dateDisplay" style="margin: 1.5rem auto;"></div>
            <div id="userProfileBadge" style="display: none; text-align: center; margin-top: 1.5rem;">
                <div style="display: inline-flex; align-items: center; gap: 1rem; background: var(--card-bg); padding: 0.75rem 1.5rem; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);">
                    <img id="userAvatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--vibrant-cyan);" src="" alt="User">
                    <div style="text-align: left;">
                        <div style="font-weight: 600; color: var(--pure-white); font-size: 0.95rem;"><span id="displayNameSpan"></span></div>
                        <button onclick="signOutUser()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; padding: 0; margin-top: 0.2rem; font-weight: 500; transition: color 0.2s;" onmouseover="this.style.color='var(--vibrant-cyan)'" onmouseout="this.style.color='var(--text-secondary)'">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <div style="text-align: center; margin-bottom: 2rem;">
            <button class="generate-btn" id="generateBtn" style="margin-bottom: 1.5rem;">
                <span style="position: relative; z-index: 1;">Generate Today's Workout</span>
            </button>
            <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; max-width: 700px; margin: 0 auto;">
                <button class="generate-btn" id="customizeBtn" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); box-shadow: 0 4px 16px rgba(156, 39, 176, 0.3); padding: 0.875rem 1.75rem; font-size: 0.9rem; flex: 1; min-width: 150px;">
                    <span style="position: relative; z-index: 1;">‚öôÔ∏è Customize</span>
                </button>
                <button class="generate-btn" id="viewStatsBtn" style="background: linear-gradient(135deg, var(--vibrant-cyan), #00B8D4); box-shadow: 0 4px 16px rgba(0, 217, 255, 0.3); padding: 0.875rem 1.75rem; font-size: 0.9rem; flex: 1; min-width: 150px;">
                    <span style="position: relative; z-index: 1;">üìä Progress</span>
                </button>
                <button class="generate-btn" id="viewLeaderboardBtn" style="background: linear-gradient(135deg, #FF6B35, #F7C948); box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3); padding: 0.875rem 1.75rem; font-size: 0.9rem; flex: 1; min-width: 150px;">
                    <span style="position: relative; z-index: 1;">üèÜ Rankings</span>
                </button>
                <button class="generate-btn" id="viewSocialBtn" style="background: linear-gradient(135deg, var(--electric-yellow), #F4A300); box-shadow: 0 4px 16px rgba(247, 201, 72, 0.3); padding: 0.875rem 1.75rem; font-size: 0.9rem; flex: 1; min-width: 150px;">
                    <span style="position: relative; z-index: 1;">üë• Friends</span>
                </button>
                <button class="generate-btn" id="viewProfileBtn" style="background: linear-gradient(135deg, #E91E63, #C2185B); box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3); padding: 0.875rem 1.75rem; font-size: 0.9rem; flex: 1; min-width: 150px;">
                    <span style="position: relative; z-index: 1;">üì∏ My Profile</span>
                </button>
            </div>
        </div>

        <div id="leaderboardContainer" class="hidden"></div>
        <div id="socialContainer" class="hidden"></div>
        <div id="statsContainer" class="hidden"></div>
        <div id="profileContainer" class="hidden"></div>
        <div id="workoutContainer" class="hidden"></div>

        <footer>
            <p><strong>Your Weekly Training Plan:</strong></p>
            <p style="margin-top: 0.5rem; line-height: 1.8;">
                Mon: HIIT üî• | Tue: Upper Body üí™ | Wed: Recovery üßò | Thu: Lower Body & Core üí™ | Fri: Cross Training ‚ö° | Sat: HIIT üî• | Sun: Recovery üßò
            </p>
            <p style="margin-top: 1rem; font-size: 0.85rem;">Consistent workouts. Smart recovery. Maximum results.</p>
            <p style="margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.5);">
                <strong>Equipment needed:</strong> Barbell, dumbbells, kettlebell, bench, and basic gym setup. Most workouts require weights for optimal results.
            </p>
        </footer>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, OAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, limit as firestoreLimit, updateDoc, arrayUnion, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyANOaf5ePwf26-NTBDra6qugOJCaiSELTk",
            authDomain: "camp-hope-2ca32.firebaseapp.com",
            projectId: "camp-hope-2ca32",
            storageBucket: "camp-hope-2ca32.firebasestorage.app",
            messagingSenderId: "543842577310",
            appId: "1:543842577310:web:3ac478061d1de5430d048f",
            measurementId: "G-NJV0K3DK72"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Display today's date
        const dateDisplay = document.getElementById('dateDisplay');
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateDisplay.textContent = today.toLocaleDateString('en-US', options);

        // User Profile Management with Firebase Auth
        let currentUser = null;

        // Firebase Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUser = {
                    id: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    username: user.email.split('@')[0]
                };
                
                // Initialize user profile in Firestore
                await initializeUserProfile(user);
                
                // Load preferences
                await loadPreferences();
                
                // Show app
                showAppInterface();
                
                // Auto-generate workout
                setTimeout(() => {
                    document.getElementById('generateBtn').click();
                }, 500);
            } else {
                // User is signed out
                currentUser = null;
                showAuthInterface();
            }
        });

        async function initializeUserProfile(user) {
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
                // Create new user profile
                await setDoc(userRef, {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    createdAt: new Date().toISOString(),
                    friends: []
                });
            }
        }

        function showAuthInterface() {
            const appScreen = document.getElementById('appScreen');
            const authScreen = document.getElementById('authScreen');
            
            if (appScreen) appScreen.style.display = 'none';
            if (authScreen) authScreen.style.display = 'block';
        }

        function showAppInterface() {
            const appScreen = document.getElementById('appScreen');
            const authScreen = document.getElementById('authScreen');
            
            if (authScreen) authScreen.style.display = 'none';
            if (appScreen) appScreen.style.display = 'block';
            
            // Update user profile display
            const userBadge = document.getElementById('userProfileBadge');
            const displayNameSpan = document.getElementById('displayNameSpan');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userBadge) userBadge.style.display = 'block';
            if (displayNameSpan) displayNameSpan.textContent = currentUser.displayName;
            if (userAvatar) userAvatar.src = currentUser.photoURL;
        }

        // Google Sign In
        async function signInWithGoogle() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Error signing in:', error);
                alert('Error signing in. Please try again.');
            }
        }

        // Apple Sign In
        async function signInWithApple() {
            try {
                const appleProvider = new OAuthProvider('apple.com');
                await signInWithPopup(auth, appleProvider);
            } catch (error) {
                console.error('Error signing in with Apple:', error);
                alert('Error signing in with Apple. Please try again.');
            }
        }

        // Sign Out
        async function signOutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Make auth functions available globally
        window.signInWithGoogle = signInWithGoogle;
        window.signInWithApple = signInWithApple;
        window.signOutUser = signOutUser;

        // Remove old profile setup function - replaced by Firebase Auth
        function showProfileSetup() {
            // Redirect to Google Sign In
            showAuthInterface();
        }

        window.submitProfile = async function() {
            // No longer needed - using Firebase Auth
        }

        async function createProfile(username, displayName) {
            // No longer needed - using Firebase Auth  
            return true;
        }

        async function updateProfile(updates) {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.id);
            await updateDoc(userRef, updates);
        }

        // Fitness data storage functions
        // Fitness data storage with Firebase Firestore
        async function saveWorkoutCompletion(workoutData) {
            if (!currentUser) {
                console.error('No user - cannot save workout');
                return false;
            }
            
            try {
                const workoutId = `${currentUser.id}_${getTodayDateKey()}`;
                const workoutRef = doc(db, 'workouts', workoutId);
                const completionData = {
                    id: workoutId,
                    userId: currentUser.id,
                    username: currentUser.username,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL || '',
                    date: new Date().toISOString(),
                    workoutType: workoutData.workoutType,
                    dayName: workoutData.dayName,
                    totalTime: workoutData.totalTime,
                    exercisesCompleted: workoutData.exercises.length,
                    completed: true,
                    // Social interaction fields
                    kudos: [],
                    comments: [],
                    kudosCount: 0,
                    commentsCount: 0,
                    caption: ''
                };
                
                await setDoc(workoutRef, completionData);
                console.log('Workout completion saved:', completionData);
                return workoutId;
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Error saving workout completion. Please try again.');
                return false;
            }
        }

        async function saveExercisePerformance(exerciseName, performanceData) {
            if (!currentUser) {
                console.error('No user logged in - cannot save performance');
                return;
            }
            
            try {
                const perfRef = doc(db, 'performance', `${currentUser.id}_${exerciseName}_${getTodayDateKey()}`);
                const data = {
                    ...performanceData,
                    userId: currentUser.id,
                    username: currentUser.username,
                    exerciseName: exerciseName,
                    timestamp: new Date().toISOString()
                };
                await setDoc(perfRef, data);
                console.log('Performance saved:', exerciseName, data);
            } catch (error) {
                console.error('Error saving performance:', error);
                alert('Error saving performance data. Please try again.');
            }
        }

        async function getWorkoutHistory(limitCount = 30) {
            if (!currentUser) return [];
            
            try {
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', '==', currentUser.id),
                    orderBy('date', 'desc'),
                    firestoreLimit(limitCount)
                );
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting workout history:', error);
                return [];
            }
        }

        async function getExerciseHistory(exerciseName, limitCount = 10) {
            if (!currentUser) {
                console.log('No user - skipping history load');
                return [];
            }
            
            try {
                const perfRef = collection(db, 'performance');
                const q = query(
                    perfRef,
                    where('userId', '==', currentUser.id),
                    where('exerciseName', '==', exerciseName),
                    orderBy('timestamp', 'desc'),
                    firestoreLimit(limitCount)
                );
                const querySnapshot = await getDocs(q);
                const history = querySnapshot.docs.map(doc => doc.data());
                console.log(`Loaded ${history.length} history records for ${exerciseName}`);
                return history;
            } catch (error) {
                console.error('Error getting exercise history:', error);
                return [];
            }
        }

        // Friend Management with Firebase
        async function addFriend(friendEmail) {
            if (!currentUser) return false;
            
            try {
                // Search for user by email
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', friendEmail));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    return false;
                }
                
                const friendDoc = querySnapshot.docs[0];
                const friendData = friendDoc.data();
                
                if (friendData.uid === currentUser.id) {
                    return false; // Can't add yourself
                }
                
                // Add to friends list
                const userRef = doc(db, 'users', currentUser.id);
                await updateDoc(userRef, {
                    friends: arrayUnion(friendData.uid)
                });
                
                // Update local currentUser
                if (!currentUser.friends) currentUser.friends = [];
                if (!currentUser.friends.includes(friendData.uid)) {
                    currentUser.friends.push(friendData.uid);
                }
                
                return true;
            } catch (error) {
                console.error('Error adding friend:', error);
                return false;
            }
        }

        async function getFriendsActivity(limitCount = 20) {
            if (!currentUser) return [];
            
            try {
                // Get current user's friends list
                const userRef = doc(db, 'users', currentUser.id);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                if (friends.length === 0) return [];
                
                // Get workouts from friends (Firestore 'in' limit is 10)
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', 'in', friends.slice(0, 10)),
                    orderBy('date', 'desc'),
                    firestoreLimit(limitCount)
                );
                
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting friends activity:', error);
                return [];
            }
        }

        async function getFriendProfiles() {
            if (!currentUser) return [];
            
            try {
                const userRef = doc(db, 'users', currentUser.id);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                if (friends.length === 0) return [];
                
                const profiles = [];
                for (let friendId of friends) {
                    const friendRef = doc(db, 'users', friendId);
                    const friendSnap = await getDoc(friendRef);
                    if (friendSnap.exists()) {
                        profiles.push(friendSnap.data());
                    }
                }
                return profiles;
            } catch (error) {
                console.error('Error getting friend profiles:', error);
                return [];
            }
        }

        async function getFriendStats(friendId) {
            try {
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', '==', friendId),
                    orderBy('date', 'desc'),
                    firestoreLimit(30)
                );
                const querySnapshot = await getDocs(q);
                const workouts = querySnapshot.docs.map(doc => doc.data());
                
                return {
                    totalWorkouts: workouts.length,
                    totalMinutes: workouts.reduce((sum, w) => sum + (w.totalTime || 0), 0),
                    lastWorkout: workouts.length > 0 ? workouts[0].date : null
                };
            } catch (error) {
                return null;
            }
        }

        // ==========================================
        // SOCIAL INTERACTION FUNCTIONS (Strava-style)
        // ==========================================

        // Give kudos to a workout
        window.giveKudos = async function(workoutId) {
            if (!currentUser) return;
            
            try {
                const workoutRef = doc(db, 'workouts', workoutId);
                const workoutSnap = await getDoc(workoutRef);
                
                if (!workoutSnap.exists()) return;
                
                const workoutData = workoutSnap.data();
                const kudos = workoutData.kudos || [];
                
                // Check if already gave kudos
                const existingKudos = kudos.find(k => k.userId === currentUser.id);
                
                if (existingKudos) {
                    // Remove kudos (toggle off)
                    const newKudos = kudos.filter(k => k.userId !== currentUser.id);
                    await updateDoc(workoutRef, {
                        kudos: newKudos,
                        kudosCount: newKudos.length
                    });
                } else {
                    // Add kudos
                    const newKudo = {
                        userId: currentUser.id,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL || '',
                        timestamp: new Date().toISOString()
                    };
                    kudos.push(newKudo);
                    await updateDoc(workoutRef, {
                        kudos: kudos,
                        kudosCount: kudos.length
                    });
                    
                    // Create notification for workout owner
                    if (workoutData.userId !== currentUser.id) {
                        await createNotification(workoutData.userId, {
                            type: 'kudos',
                            fromUserId: currentUser.id,
                            fromDisplayName: currentUser.displayName,
                            fromPhotoURL: currentUser.photoURL || '',
                            workoutId: workoutId,
                            workoutType: workoutData.workoutType,
                            timestamp: new Date().toISOString(),
                            read: false
                        });
                    }
                }
                
                // Refresh the feed
                displaySocialFeed();
            } catch (error) {
                console.error('Error giving kudos:', error);
            }
        }

        // Add comment to a workout
        window.addComment = async function(workoutId) {
            const input = document.getElementById(`comment-input-${workoutId}`);
            const commentText = input?.value?.trim();
            
            if (!commentText || !currentUser) return;
            
            try {
                const workoutRef = doc(db, 'workouts', workoutId);
                const workoutSnap = await getDoc(workoutRef);
                
                if (!workoutSnap.exists()) return;
                
                const workoutData = workoutSnap.data();
                const comments = workoutData.comments || [];
                
                const newComment = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL || '',
                    text: commentText,
                    timestamp: new Date().toISOString()
                };
                
                comments.push(newComment);
                
                await updateDoc(workoutRef, {
                    comments: comments,
                    commentsCount: comments.length
                });
                
                // Create notification for workout owner
                if (workoutData.userId !== currentUser.id) {
                    await createNotification(workoutData.userId, {
                        type: 'comment',
                        fromUserId: currentUser.id,
                        fromDisplayName: currentUser.displayName,
                        fromPhotoURL: currentUser.photoURL || '',
                        workoutId: workoutId,
                        workoutType: workoutData.workoutType,
                        commentPreview: commentText.substring(0, 50),
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                }
                
                // Clear input and refresh
                input.value = '';
                displaySocialFeed();
            } catch (error) {
                console.error('Error adding comment:', error);
            }
        }

        // Delete a comment
        window.deleteComment = async function(workoutId, commentId) {
            if (!currentUser) return;
            
            try {
                const workoutRef = doc(db, 'workouts', workoutId);
                const workoutSnap = await getDoc(workoutRef);
                
                if (!workoutSnap.exists()) return;
                
                const workoutData = workoutSnap.data();
                const comments = workoutData.comments || [];
                
                // Only allow deleting own comments or if workout owner
                const comment = comments.find(c => c.id === commentId);
                if (comment && (comment.userId === currentUser.id || workoutData.userId === currentUser.id)) {
                    const newComments = comments.filter(c => c.id !== commentId);
                    await updateDoc(workoutRef, {
                        comments: newComments,
                        commentsCount: newComments.length
                    });
                    displaySocialFeed();
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
            }
        }

        // Create notification
        async function createNotification(userId, notificationData) {
            try {
                const notifId = `${userId}_${Date.now()}`;
                const notifRef = doc(db, 'notifications', notifId);
                await setDoc(notifRef, {
                    ...notificationData,
                    userId: userId,
                    id: notifId
                });
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Get notifications for current user
        async function getNotifications(limitCount = 20) {
            if (!currentUser) return [];
            
            try {
                const notifsRef = collection(db, 'notifications');
                const q = query(
                    notifsRef,
                    where('userId', '==', currentUser.id),
                    orderBy('timestamp', 'desc'),
                    firestoreLimit(limitCount)
                );
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting notifications:', error);
                return [];
            }
        }

        // Mark notification as read
        async function markNotificationRead(notifId) {
            try {
                const notifRef = doc(db, 'notifications', notifId);
                await updateDoc(notifRef, { read: true });
            } catch (error) {
                console.error('Error marking notification read:', error);
            }
        }

        // Get all activity (friends + own workouts)
        async function getAllActivity(limitCount = 30) {
            if (!currentUser) return [];
            
            try {
                // Get current user's friends list
                const userRef = doc(db, 'users', currentUser.id);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                // Include current user in activity feed
                const userIds = [...friends, currentUser.id].slice(0, 10);
                
                if (userIds.length === 0) return [];
                
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', 'in', userIds),
                    orderBy('date', 'desc'),
                    firestoreLimit(limitCount)
                );
                
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
            } catch (error) {
                console.error('Error getting all activity:', error);
                return [];
            }
        }

        // View user profile
        window.viewUserProfile = async function(userId) {
            try {
                // Get user data
                const userRef = doc(db, 'users', userId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    alert('User not found');
                    return;
                }
                
                const userData = userSnap.data();
                
                // Get user's workout stats
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', '==', userId),
                    orderBy('date', 'desc'),
                    firestoreLimit(50)
                );
                const workoutsSnap = await getDocs(q);
                const workouts = workoutsSnap.docs.map(doc => doc.data());
                
                // Get user's profile data (measurements, strength records)
                const profileRef = doc(db, 'profiles', userId);
                const profileSnap = await getDoc(profileRef);
                const profileData = profileSnap.exists() ? profileSnap.data() : {};
                
                showUserProfileModal(userData, workouts, profileData);
            } catch (error) {
                console.error('Error viewing user profile:', error);
            }
        }

        function showUserProfileModal(userData, workouts, profileData) {
            const totalWorkouts = workouts.length;
            const totalMinutes = workouts.reduce((sum, w) => sum + (w.totalTime || 0), 0);
            const totalKudosReceived = workouts.reduce((sum, w) => sum + (w.kudosCount || 0), 0);
            
            // Calculate workout type breakdown
            const workoutTypes = workouts.reduce((acc, w) => {
                acc[w.workoutType] = (acc[w.workoutType] || 0) + 1;
                return acc;
            }, {});
            
            // Get recent PRs from strength records
            const strengthRecords = profileData.strengthRecords || [];
            const recentPRs = strengthRecords.slice(0, 5);
            
            const modal = document.createElement('div');
            modal.id = 'userProfileModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 1rem;';
            modal.innerHTML = `
                <div style="max-width: 600px; margin: 2rem auto; background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border-color); overflow: hidden;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(247, 201, 72, 0.2)); padding: 2rem; text-align: center; position: relative;">
                        <button onclick="document.getElementById('userProfileModal').remove()" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.1); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">‚úï</button>
                        <img src="${userData.photoURL || ''}" alt="${userData.displayName}" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--energy-orange); margin-bottom: 1rem; object-fit: cover;">
                        <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--pure-white); letter-spacing: 0.03em;">${userData.displayName}</h2>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">@${userData.email?.split('@')[0] || 'user'}</div>
                        ${userData.uid !== currentUser.id ? `
                            <button onclick="toggleFollow('${userData.uid}')" id="followBtn-${userData.uid}" style="margin-top: 1rem; background: var(--energy-orange); color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer;">
                                ${currentUser.friends?.includes(userData.uid) ? '‚úì Following' : '+ Follow'}
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border-color);">
                        <div style="background: var(--card-bg); padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--vibrant-cyan); font-family: 'Bebas Neue', sans-serif;">${totalWorkouts}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em;">Workouts</div>
                        </div>
                        <div style="background: var(--card-bg); padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--electric-yellow); font-family: 'Bebas Neue', sans-serif;">${totalMinutes}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em;">Minutes</div>
                        </div>
                        <div style="background: var(--card-bg); padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--energy-orange); font-family: 'Bebas Neue', sans-serif;">${totalKudosReceived}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em;">Kudos</div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 1.5rem;">
                        <!-- Workout Types -->
                        ${Object.keys(workoutTypes).length > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; color: var(--vibrant-cyan); margin-bottom: 1rem; letter-spacing: 0.05em;">Workout Breakdown</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${Object.entries(workoutTypes).map(([type, count]) => {
                                        const emoji = type === 'HIIT' ? 'üî•' : type === 'Strength' ? 'üí™' : type === 'Cross Training' ? '‚ö°' : 'üßò';
                                        return `
                                            <div style="background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 20px; display: flex; align-items: center; gap: 0.5rem;">
                                                <span>${emoji}</span>
                                                <span style="font-weight: 600;">${count}</span>
                                                <span style="color: var(--text-secondary); font-size: 0.85rem;">${type}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Recent PRs -->
                        ${recentPRs.length > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; color: var(--energy-orange); margin-bottom: 1rem; letter-spacing: 0.05em;">Recent PRs üèÜ</h3>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    ${recentPRs.map(pr => `
                                        <div style="background: rgba(255, 107, 53, 0.1); padding: 0.75rem 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 600;">${pr.exercise}</span>
                                            <span style="color: var(--electric-yellow); font-weight: 700;">${pr.weight} lbs √ó ${pr.reps}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Recent Activity -->
                        <div>
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; color: var(--electric-yellow); margin-bottom: 1rem; letter-spacing: 0.05em;">Recent Activity</h3>
                            ${workouts.slice(0, 5).map(w => {
                                const emoji = w.workoutType === 'HIIT' ? 'üî•' : w.workoutType === 'Strength' ? 'üí™' : w.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
                                const date = new Date(w.date);
                                return `
                                    <div style="background: rgba(255,255,255,0.03); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="font-size: 1.25rem;">${emoji}</span>
                                            <div>
                                                <div style="font-weight: 600; font-size: 0.95rem;">${w.workoutType}</div>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${w.totalTime} min</div>
                                            </div>
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${workouts.length === 0 ? '<div style="text-align: center; padding: 1rem; color: var(--text-secondary);">No workouts yet</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Toggle follow/unfollow
        window.toggleFollow = async function(userId) {
            if (!currentUser) return;
            
            try {
                const userRef = doc(db, 'users', currentUser.id);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                const btn = document.getElementById(`followBtn-${userId}`);
                
                if (friends.includes(userId)) {
                    // Unfollow
                    const newFriends = friends.filter(f => f !== userId);
                    await updateDoc(userRef, { friends: newFriends });
                    currentUser.friends = newFriends;
                    if (btn) btn.innerHTML = '+ Follow';
                } else {
                    // Follow
                    await updateDoc(userRef, { friends: arrayUnion(userId) });
                    if (!currentUser.friends) currentUser.friends = [];
                    currentUser.friends.push(userId);
                    if (btn) btn.innerHTML = '‚úì Following';
                    
                    // Create notification
                    await createNotification(userId, {
                        type: 'follow',
                        fromUserId: currentUser.id,
                        fromDisplayName: currentUser.displayName,
                        fromPhotoURL: currentUser.photoURL || '',
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
            }
        }

        // Show who gave kudos
        window.showKudosList = function(kudos) {
            if (!kudos || kudos.length === 0) return;
            
            const modal = document.createElement('div');
            modal.id = 'kudosListModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 16px; padding: 1.5rem; max-width: 350px; width: 100%; max-height: 70vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; color: var(--energy-orange);">üëè Kudos (${kudos.length})</h3>
                        <button onclick="document.getElementById('kudosListModal').remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">‚úï</button>
                    </div>
                    ${kudos.map(k => `
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer;" onclick="document.getElementById('kudosListModal').remove(); viewUserProfile('${k.userId}')">
                            <img src="${k.photoURL || ''}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: rgba(255,255,255,0.1);">
                            <div>
                                <div style="font-weight: 600;">${k.displayName}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${getTimeAgo(new Date(k.timestamp))}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getTodayDateKey() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        async function getStats() {
            const history = await getWorkoutHistory(90);
            console.log(`getStats: Found ${history.length} workouts in history`);
            
            const totalWorkouts = history.length;
            const last7Days = history.filter(w => {
                const workoutDate = new Date(w.date);
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                return workoutDate >= sevenDaysAgo;
            }).length;
            
            const workoutTypes = history.reduce((acc, w) => {
                acc[w.workoutType] = (acc[w.workoutType] || 0) + 1;
                return acc;
            }, {});

            const stats = {
                totalWorkouts,
                last7Days,
                workoutTypes,
                totalMinutes: history.reduce((sum, w) => sum + (w.totalTime || 0), 0)
            };
            
            console.log('Stats calculated:', stats);
            return stats;
        }

        // User preferences for workout customization
        let workoutPreferences = {
            duration: 35, // 20, 35, or 45 minutes
            difficulty: 'intermediate', // beginner, intermediate, advanced
            equipment: 'full-gym', // full-gym, dumbbells-only, minimal, bodyweight
            injuries: [], // array of injury types: knee, shoulder, back, wrist, ankle
            planType: 'single', // single, weekly, monthly
            singleWorkoutType: null, // For single day: 'hiit', 'upper-strength', 'lower-strength', 'cross-training', 'recovery'
            workoutMix: { // For weekly/monthly plans - defaults to balanced week
                'hiit': 2,
                'upper-strength': 1,
                'lower-strength': 1,
                'cross-training': 1,
                'recovery': 2
            },
            currentSchedule: null // Stores the generated schedule array
        };

        // Load preferences from Firestore
        async function loadPreferences() {
            if (!currentUser) return;
            
            try {
                const prefRef = doc(db, 'preferences', currentUser.id);
                const prefSnap = await getDoc(prefRef);
                if (prefSnap.exists()) {
                    const savedPrefs = prefSnap.data();
                    // Merge saved preferences with defaults to preserve structure
                    workoutPreferences = {
                        ...workoutPreferences,
                        ...savedPrefs,
                        // Ensure workoutMix exists with defaults
                        workoutMix: {
                            ...workoutPreferences.workoutMix,
                            ...(savedPrefs.workoutMix || {})
                        }
                    };
                    console.log('Preferences loaded successfully');
                }
            } catch (error) {
                console.log('No saved preferences, using defaults');
            }
        }

        // Save preferences to Firestore
        async function savePreferences() {
            if (!currentUser) return;
            
            try {
                const prefRef = doc(db, 'preferences', currentUser.id);
                await setDoc(prefRef, workoutPreferences);
            } catch (error) {
                console.error('Error saving preferences:', error);
            }
        }

        // Show preferences modal
        function showPreferencesModal() {
            const modal = document.createElement('div');
            modal.id = 'preferencesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
                overflow-y: auto;
            `;

            modal.innerHTML = `
                <div style="background: var(--slate); border-radius: 16px; padding: 2rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--energy-orange);">
                    <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--electric-yellow); margin-bottom: 2rem; text-align: center;">Customize Your Workouts</h2>
                    
                    <!-- Plan Type Selection -->
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(255, 107, 53, 0.1); border-radius: 12px; border: 2px solid var(--energy-orange);">
                        <label style="display: block; font-size: 1.1rem; font-weight: 700; color: var(--energy-orange); margin-bottom: 1rem;">üìÖ Choose Your Plan</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <button class="plan-btn" data-plan="single" style="padding: 1rem; background: ${workoutPreferences.planType === 'single' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'single' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Single Day<br><span style="font-size: 0.8rem; opacity: 0.7;">One workout</span></button>
                            <button class="plan-btn" data-plan="weekly" style="padding: 1rem; background: ${workoutPreferences.planType === 'weekly' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'weekly' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Weekly<br><span style="font-size: 0.8rem; opacity: 0.7;">7-day plan</span></button>
                            <button class="plan-btn" data-plan="monthly" style="padding: 1rem; background: ${workoutPreferences.planType === 'monthly' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'monthly' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Monthly<br><span style="font-size: 0.8rem; opacity: 0.7;">30-day plan</span></button>
                        </div>
                        
                        <!-- Single Day Workout Type -->
                        <div id="singleDayType" style="display: ${workoutPreferences.planType === 'single' ? 'block' : 'none'};">
                            <label style="display: block; font-size: 0.95rem; font-weight: 600; color: var(--vibrant-cyan); margin-bottom: 0.75rem;">Choose today's workout:</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                                <button class="single-type-btn" data-type="hiit" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'hiit' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'hiit' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">üî• HIIT</button>
                                <button class="single-type-btn" data-type="upper-strength" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'upper-strength' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'upper-strength' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">üí™ Upper Body</button>
                                <button class="single-type-btn" data-type="lower-strength" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'lower-strength' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'lower-strength' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">ü¶µ Lower Body</button>
                                <button class="single-type-btn" data-type="cross-training" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'cross-training' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'cross-training' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">‚ö° Cross Training</button>
                                <button class="single-type-btn" data-type="recovery" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'recovery' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'recovery' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">üßò Recovery</button>
                            </div>
                        </div>
                        
                        <!-- Weekly/Monthly Mix -->
                        <div id="planMix" style="display: ${workoutPreferences.planType !== 'single' ? 'block' : 'none'};">
                            <label style="display: block; font-size: 0.95rem; font-weight: 600; color: var(--vibrant-cyan); margin-bottom: 0.75rem;">Allocate your ${workoutPreferences.planType === 'weekly' ? '7' : '30'} days:</label>
                            <div style="background: rgba(0, 217, 255, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);">Choose how many days of each type (must total ${workoutPreferences.planType === 'weekly' ? '7' : '30'})</div>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                ${['hiit', 'upper-strength', 'lower-strength', 'cross-training', 'recovery'].map(type => {
                                    const labels = {
                                        'hiit': 'üî• HIIT',
                                        'upper-strength': 'üí™ Upper Body',
                                        'lower-strength': 'ü¶µ Lower Body',
                                        'cross-training': '‚ö° Cross Training',
                                        'recovery': 'üßò Recovery'
                                    };
                                    return `
                                        <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.05); padding: 0.5rem 1rem; border-radius: 6px;">
                                            <span style="font-size: 0.85rem;">${labels[type]}</span>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <button class="mix-decrease" data-type="${type}" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: bold;">-</button>
                                                <span id="mix-${type}" style="min-width: 25px; text-align: center; font-weight: 700; color: var(--vibrant-cyan);">${workoutPreferences.workoutMix[type]}</span>
                                                <button class="mix-increase" data-type="${type}" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div id="mix-total" style="text-align: center; margin-top: 0.75rem; font-weight: 700; color: ${Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0) === (workoutPreferences.planType === 'weekly' ? 7 : 30) ? 'var(--electric-yellow)' : '#FF6B35'};">
                                Total: ${Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0)} / ${workoutPreferences.planType === 'weekly' ? '7' : '30'}
                            </div>
                            
                            <!-- Schedule Preview for Weekly -->
                            <div id="schedulePreview" style="margin-top: 1rem; padding: 1rem; background: rgba(255, 107, 53, 0.1); border-radius: 8px; border: 1px solid rgba(255, 107, 53, 0.3); display: ${workoutPreferences.planType === 'weekly' ? 'block' : 'none'};">
                                <div style="font-size: 0.85rem; font-weight: 600; color: var(--energy-orange); margin-bottom: 0.5rem;">üìÖ Your Week Preview:</div>
                                <div id="weekPreviewGrid" style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `
                                        <div style="flex: 1; min-width: 40px; text-align: center; padding: 0.4rem 0.25rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.6);">${day}</div>
                                            <div id="preview-day-${i}" style="font-size: 1rem; margin-top: 0.2rem;">-</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.5rem; text-align: center;">Schedule auto-distributes for optimal recovery</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Duration -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Workout Duration</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button class="duration-btn" data-duration="20" style="padding: 1rem; background: ${workoutPreferences.duration === 20 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 20 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">20 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Quick</span></button>
                            <button class="duration-btn" data-duration="35" style="padding: 1rem; background: ${workoutPreferences.duration === 35 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 35 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">35 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Standard</span></button>
                            <button class="duration-btn" data-duration="45" style="padding: 1rem; background: ${workoutPreferences.duration === 45 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 45 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">45 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Extended</span></button>
                        </div>
                    </div>

                    <!-- Difficulty -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Difficulty Level</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button class="difficulty-btn" data-difficulty="beginner" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'beginner' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'beginner' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Beginner<br><span style="font-size: 0.8rem; opacity: 0.7;">Lighter weights</span></button>
                            <button class="difficulty-btn" data-difficulty="intermediate" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'intermediate' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'intermediate' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Intermediate<br><span style="font-size: 0.8rem; opacity: 0.7;">Moderate</span></button>
                            <button class="difficulty-btn" data-difficulty="advanced" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'advanced' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'advanced' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Advanced<br><span style="font-size: 0.8rem; opacity: 0.7;">High intensity</span></button>
                        </div>
                    </div>

                    <!-- Equipment -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Available Equipment</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <button class="equipment-btn" data-equipment="full-gym" style="padding: 1rem; background: ${workoutPreferences.equipment === 'full-gym' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'full-gym' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Full Gym<br><span style="font-size: 0.8rem; opacity: 0.7;">All equipment</span></button>
                            <button class="equipment-btn" data-equipment="dumbbells-only" style="padding: 1rem; background: ${workoutPreferences.equipment === 'dumbbells-only' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'dumbbells-only' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Dumbbells Only<br><span style="font-size: 0.8rem; opacity: 0.7;">+ bench</span></button>
                            <button class="equipment-btn" data-equipment="minimal" style="padding: 1rem; background: ${workoutPreferences.equipment === 'minimal' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'minimal' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Minimal<br><span style="font-size: 0.8rem; opacity: 0.7;">Light weights</span></button>
                            <button class="equipment-btn" data-equipment="bodyweight" style="padding: 1rem; background: ${workoutPreferences.equipment === 'bodyweight' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'bodyweight' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Bodyweight<br><span style="font-size: 0.8rem; opacity: 0.7;">No equipment</span></button>
                        </div>
                    </div>

                    <!-- Injuries -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Injury Modifications (Select all that apply)</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="knee" ${workoutPreferences.injuries.includes('knee') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Knee Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="shoulder" ${workoutPreferences.injuries.includes('shoulder') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Shoulder Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="back" ${workoutPreferences.injuries.includes('back') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Back Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="wrist" ${workoutPreferences.injuries.includes('wrist') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Wrist Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="ankle" ${workoutPreferences.injuries.includes('ankle') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Ankle Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="elbow" ${workoutPreferences.injuries.includes('elbow') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Elbow Issues</span>
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button id="savePreferencesBtn" style="flex: 1; background: linear-gradient(135deg, var(--energy-orange), #FF8C42); color: white; border: none; padding: 1rem; font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px;">Save & Regenerate</button>
                        <button id="cancelPreferencesBtn" style="flex: 0.5; background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem; font-size: 1rem; font-weight: 600; cursor: pointer; border-radius: 8px;">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Plan type buttons
            modal.querySelectorAll('.plan-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.closest('.plan-btn');
                    const planType = target.dataset.plan;
                    workoutPreferences.planType = planType;
                    modal.querySelectorAll('.plan-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    target.style.background = 'var(--energy-orange)';
                    target.style.borderColor = 'var(--electric-yellow)';
                    
                    // Show/hide appropriate sections
                    const singleSection = document.getElementById('singleDayType');
                    const mixSection = document.getElementById('planMix');
                    const mixTotal = document.getElementById('mix-total');
                    const schedulePreview = document.getElementById('schedulePreview');
                    
                    if (planType === 'single') {
                        singleSection.style.display = 'block';
                        mixSection.style.display = 'none';
                    } else {
                        singleSection.style.display = 'none';
                        mixSection.style.display = 'block';
                        // Update total label
                        const expected = planType === 'weekly' ? 7 : 30;
                        const current = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                        mixTotal.innerHTML = `Total: ${current} / ${expected}`;
                        mixTotal.style.color = current === expected ? 'var(--electric-yellow)' : '#FF6B35';
                        
                        // Show/hide schedule preview (only for weekly)
                        if (schedulePreview) {
                            schedulePreview.style.display = planType === 'weekly' ? 'block' : 'none';
                        }
                    }
                });
            });
            
            // Single workout type buttons
            modal.querySelectorAll('.single-type-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.closest('.single-type-btn');
                    workoutPreferences.singleWorkoutType = target.dataset.type;
                    modal.querySelectorAll('.single-type-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.05)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    target.style.background = 'var(--vibrant-cyan)';
                    target.style.borderColor = 'var(--electric-yellow)';
                });
            });
            
            // Function to update schedule preview
            function updateSchedulePreview() {
                if (workoutPreferences.planType !== 'weekly') return;
                
                const schedule = buildScheduleFromMix(workoutPreferences.workoutMix, 7);
                const emojis = {
                    'hiit': 'üî•',
                    'upper-strength': 'üí™',
                    'lower-strength': 'ü¶µ',
                    'cross-training': '‚ö°',
                    'recovery': 'üßò'
                };
                
                for (let i = 0; i < 7; i++) {
                    const el = document.getElementById(`preview-day-${i}`);
                    if (el) {
                        el.textContent = emojis[schedule[i]] || 'üßò';
                    }
                }
            }
            
            // Workout mix increase/decrease buttons
            modal.querySelectorAll('.mix-increase, .mix-decrease').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.closest('.mix-increase, .mix-decrease');
                    const type = target.dataset.type;
                    const isIncrease = target.classList.contains('mix-increase');
                    const expected = workoutPreferences.planType === 'weekly' ? 7 : 30;
                    const currentTotal = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                    
                    if (isIncrease && currentTotal < expected) {
                        workoutPreferences.workoutMix[type]++;
                    } else if (!isIncrease && workoutPreferences.workoutMix[type] > 0) {
                        workoutPreferences.workoutMix[type]--;
                    }
                    
                    // Update display
                    document.getElementById(`mix-${type}`).textContent = workoutPreferences.workoutMix[type];
                    const newTotal = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                    const mixTotal = document.getElementById('mix-total');
                    mixTotal.innerHTML = `Total: ${newTotal} / ${expected}`;
                    mixTotal.style.color = newTotal === expected ? 'var(--electric-yellow)' : '#FF6B35';
                    
                    // Update schedule preview
                    updateSchedulePreview();
                });
            });
            
            // Initial schedule preview update
            updateSchedulePreview();

            // Add event listeners
            modal.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.closest('.duration-btn');
                    modal.querySelectorAll('.duration-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    target.style.background = 'var(--energy-orange)';
                    target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.duration = parseInt(target.dataset.duration);
                });
            });

            modal.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.closest('.difficulty-btn');
                    modal.querySelectorAll('.difficulty-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    target.style.background = 'var(--energy-orange)';
                    target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.difficulty = target.dataset.difficulty;
                });
            });

            modal.querySelectorAll('.equipment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.closest('.equipment-btn');
                    modal.querySelectorAll('.equipment-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    target.style.background = 'var(--energy-orange)';
                    target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.equipment = target.dataset.equipment;
                });
            });

            modal.querySelectorAll('.injury-check').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    workoutPreferences.injuries = Array.from(modal.querySelectorAll('.injury-check:checked')).map(cb => cb.value);
                });
            });

            document.getElementById('savePreferencesBtn').addEventListener('click', async () => {
                // Validate based on plan type
                if (workoutPreferences.planType === 'single') {
                    if (!workoutPreferences.singleWorkoutType) {
                        alert('Please select a workout type for today!');
                        return;
                    }
                } else {
                    // Weekly or monthly
                    const expected = workoutPreferences.planType === 'weekly' ? 7 : 30;
                    const total = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                    if (total !== expected) {
                        alert(`Please allocate exactly ${expected} days. Currently: ${total}`);
                        return;
                    }
                }
                
                await savePreferences();
                modal.remove();
                document.getElementById('generateBtn').click();
            });

            document.getElementById('cancelPreferencesBtn').addEventListener('click', () => {
                modal.remove();
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        window.showPreferencesModal = showPreferencesModal;

        // Filter exercises based on preferences
        function filterExercisesByPreferences(exercises) {
            return exercises.filter(exercise => {
                // Equipment filtering
                if (workoutPreferences.equipment === 'bodyweight') {
                    // Only bodyweight exercises
                    const bodyweightKeywords = ['bodyweight', 'push-up', 'pull-up', 'plank', 'burpee', 'mountain climber', 'jump', 'squat', 'lunge'];
                    const isBodyweight = bodyweightKeywords.some(keyword => 
                        exercise.name.toLowerCase().includes(keyword) || 
                        !exercise.name.toLowerCase().includes('barbell') && 
                        !exercise.name.toLowerCase().includes('dumbbell') && 
                        !exercise.name.toLowerCase().includes('kettlebell')
                    );
                    if (!isBodyweight) return false;
                }
                
                if (workoutPreferences.equipment === 'dumbbells-only') {
                    // Replace barbell with dumbbell variants
                    if (exercise.name.toLowerCase().includes('barbell')) {
                        exercise.name = exercise.name.replace('Barbell', 'Dumbbell');
                        exercise.description = exercise.description.replace('barbell', 'dumbbell');
                    }
                    if (exercise.name.toLowerCase().includes('kettlebell') && 
                        !exercise.name.includes('Swing')) {
                        return false; // Skip kettlebell-specific moves except swings
                    }
                }
                
                if (workoutPreferences.equipment === 'minimal') {
                    // No heavy barbells or machines
                    if (exercise.name.toLowerCase().includes('barbell') || 
                        exercise.name.toLowerCase().includes('leg press') ||
                        exercise.name.toLowerCase().includes('cable')) {
                        return false;
                    }
                }
                
                // Injury modifications
                if (workoutPreferences.injuries.includes('knee')) {
                    if (exercise.name.toLowerCase().includes('jump') || 
                        exercise.name.toLowerCase().includes('squat') ||
                        exercise.name.toLowerCase().includes('lunge')) {
                        exercise.tips += ' | MODIFICATION: Reduce depth, no jumping, or substitute with leg press';
                    }
                }
                
                if (workoutPreferences.injuries.includes('shoulder')) {
                    if (exercise.name.toLowerCase().includes('overhead') || 
                        exercise.name.toLowerCase().includes('press') ||
                        exercise.name.toLowerCase().includes('shoulder')) {
                        exercise.tips += ' | MODIFICATION: Reduce range of motion or substitute with lower angle press';
                    }
                }
                
                if (workoutPreferences.injuries.includes('back')) {
                    if (exercise.name.toLowerCase().includes('deadlift') || 
                        exercise.name.toLowerCase().includes('row') ||
                        exercise.name.toLowerCase().includes('good morning')) {
                        exercise.tips += ' | MODIFICATION: Keep weight light, focus on form, or substitute with machine variant';
                    }
                }
                
                if (workoutPreferences.injuries.includes('wrist')) {
                    if (exercise.name.toLowerCase().includes('push-up') || 
                        exercise.name.toLowerCase().includes('plank') ||
                        exercise.name.toLowerCase().includes('burpee')) {
                        exercise.tips += ' | MODIFICATION: Use push-up handles or perform on knuckles';
                    }
                }
                
                return true;
            });
        }

        // Adjust workout duration based on preferences
        function adjustWorkoutDuration() {
            const baseDuration = workoutPreferences.duration;
            
            if (baseDuration === 20) {
                return { warmup: 3, main: 15, cooldown: 2 };
            } else if (baseDuration === 45) {
                return { warmup: 7, main: 35, cooldown: 3 };
            } else {
                return { warmup: 5, main: 26, cooldown: 4 }; // 35 min default
            }
        }

        // Adjust reps/sets based on difficulty
        function adjustExerciseDifficulty(exercise) {
            const ex = { ...exercise };
            
            if (workoutPreferences.difficulty === 'beginner') {
                if (ex.reps) {
                    ex.reps = ex.reps.replace(/\d+-\d+/g, (match) => {
                        const [min, max] = match.split('-').map(Number);
                        return `${Math.max(1, min - 2)}-${max - 2}`;
                    });
                    ex.reps = ex.reps.replace(/\d+ sets/g, (match) => {
                        const sets = parseInt(match);
                        return `${Math.max(2, sets - 1)} sets`;
                    });
                }
                ex.description += ' (Beginner: lighter weight, focus on form)';
            } else if (workoutPreferences.difficulty === 'advanced') {
                if (ex.reps) {
                    ex.reps = ex.reps.replace(/\d+-\d+/g, (match) => {
                        const [min, max] = match.split('-').map(Number);
                        return `${min + 2}-${max + 3}`;
                    });
                    ex.reps = ex.reps.replace(/\d+ sets/g, (match) => {
                        const sets = parseInt(match);
                        return `${sets + 1} sets`;
                    });
                }
                ex.description += ' (Advanced: heavier weight, maximum intensity)';
            }
            
            return ex;
        }

        // Weekly workout schedule - cohesive program to avoid overtraining
        const weeklySchedule = {
            0: { // Sunday
                type: 'Recovery & Stretching',
                focus: 'Full body mobility and flexibility',
                intensity: 'Low'
            },
            1: { // Monday
                type: 'HIIT',
                focus: 'Full body high intensity',
                intensity: 'High',
                muscleGroups: ['full-body']
            },
            2: { // Tuesday
                type: 'Strength',
                focus: 'Upper body push & pull',
                intensity: 'Medium-High',
                muscleGroups: ['chest', 'back', 'shoulders', 'arms']
            },
            3: { // Wednesday
                type: 'Recovery & Stretching',
                focus: 'Active recovery and deep stretching',
                intensity: 'Low'
            },
            4: { // Thursday
                type: 'Strength',
                focus: 'Lower body & core',
                intensity: 'Medium-High',
                muscleGroups: ['legs', 'glutes', 'core']
            },
            5: { // Friday
                type: 'Cross Training',
                focus: 'Functional fitness & conditioning',
                intensity: 'Medium-High',
                muscleGroups: ['full-body']
            },
            6: { // Saturday
                type: 'HIIT',
                focus: 'Metabolic conditioning',
                intensity: 'High',
                muscleGroups: ['full-body']
            }
        };
        
        const exerciseDatabase = {
            warmup: [
                { name: 'Jumping Jacks', duration: 2, description: 'Full body dynamic warm-up', tips: 'Keep a steady rhythm and land softly on your feet' , video: 'https://www.youtube.com/watch?v=iSSAk4XCsRA' },
                { name: 'Arm Circles & Shoulder Rolls', duration: 2, description: 'Dynamic shoulder mobility', tips: 'Make large circles, both forward and backward' , video: 'https://www.youtube.com/watch?v=L1rKFAZnUYM' },
                { name: 'Leg Swings', duration: 1, description: 'Hip mobility and activation', tips: 'Swing each leg forward/back and side to side' , video: 'https://www.youtube.com/watch?v=4aoFzJSrNzE' },
                { name: 'Inchworms', duration: 2, description: 'Full body mobility', tips: 'Walk hands out to plank, walk feet to hands' , video: 'https://www.youtube.com/watch?v=CJwImFNvGhg' },
                { name: 'Bodyweight Squats', duration: 2, description: 'Lower body activation', tips: 'Full range of motion, controlled tempo' }
            ],
            
            // HIIT Exercises (Monday & Saturday - Full Body)
            hiit: [
                { name: 'Dumbbell Burpee Clean and Press', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Full body explosive HIIT with dumbbells', tips: 'Burpee with dumbbells, clean to shoulders, press overhead', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=YaXPRqUwItQ' , video: 'https://www.youtube.com/watch?v=6JYPJ3T5MsY' },
                { name: 'Barbell Thrusters', duration: 3, reps: '30 sec work / 30 sec rest', description: 'High intensity squat to press', tips: 'Explosive squat, drive barbell overhead without pause', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=L219ltL15zk' },
                { name: 'Dumbbell Squat Jumps', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Weighted explosive lower body power', tips: 'Hold light dumbbells at sides, land softly, explode up', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=W5bvS2zdH-c' },
                { name: 'Kettlebell Swings (HIIT Pace)', duration: 3, reps: '40 sec work / 20 sec rest', description: 'High intensity hip power', tips: 'Explosive hip snap, maximum pace, tight core', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=YSxHifyI6s8' },
                { name: 'Dumbbell Alternating Snatches', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Single arm explosive power', tips: 'Pull dumbbell from ground to overhead, alternate arms rapidly', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=T6KbfD0eHCU' },
                { name: 'Barbell or Dumbbell Push Press', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Upper body explosive power', tips: 'Dip knees, drive weight overhead explosively', muscleGroups: ['shoulders', 'legs'] , video: 'https://www.youtube.com/watch?v=iaBVSJm78ko' },
                { name: 'Dumbbell Man Makers (Fast Pace)', duration: 4, reps: '20 sec work / 40 sec rest', description: 'Ultimate weighted HIIT movement', tips: 'Burpee + row + clean + press. Maximum intensity', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=bdT_EJu2wFU' },
                { name: 'Barbell High Pulls', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Explosive pulling power', tips: 'Pull bar to chest height, elbows high, fast tempo', muscleGroups: ['back', 'shoulders'] , video: 'https://www.youtube.com/watch?v=LfT_HyPUqGI' },
                { name: 'Dumbbell Devil Press', duration: 3, reps: '20 sec work / 40 sec rest', description: 'Advanced weighted burpee variation', tips: 'Burpee with dumbbells, swing to overhead in one motion', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=czLhvRaWPlk' },
                { name: 'Kettlebell Goblet Jump Squats', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Weighted plyometric legs', tips: 'Hold kettlebell at chest, jump explosively', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=U91qsRtNtFE' },
                { name: 'Burpees (Bodyweight)', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Classic HIIT bodyweight movement', tips: 'Maximum speed, full extension, chest to ground', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=JZQA08SlJnM' },
                { name: 'Mountain Climbers', duration: 3, reps: '40 sec work / 20 sec rest', description: 'High intensity core and cardio', tips: 'Drive knees fast, maintain plank position', muscleGroups: ['core', 'shoulders'] }
            ],
            
            // Upper Body Strength (Tuesday)
            strengthUpper: [
                { name: 'Barbell Bench Press', duration: 4, reps: '4 sets of 8-10 reps', description: 'Primary chest builder with barbell', tips: 'Lower bar to chest, press explosively, keep feet planted', muscleGroups: ['chest', 'triceps', 'shoulders'] , video: 'https://www.youtube.com/watch?v=nmwgirgXLYM' , video: 'https://www.youtube.com/watch?v=rT7DgCr-3pg' },
                { name: 'Dumbbell Rows', duration: 4, reps: '4 sets of 10-12 per arm', description: 'Unilateral back strength', tips: 'Support on bench, pull dumbbell to hip, squeeze shoulder blade', muscleGroups: ['back', 'biceps'] , video: 'https://www.youtube.com/watch?v=pYcpY20QaE8' },
                { name: 'Barbell Overhead Press', duration: 4, reps: '4 sets of 8 reps', description: 'Shoulder mass and strength builder', tips: 'Press bar from shoulders overhead, tight core throughout', muscleGroups: ['shoulders', 'triceps'] , video: 'https://www.youtube.com/watch?v=_RlRDWO2jfg' },
                { name: 'Dumbbell Incline Press', duration: 4, reps: '3 sets of 10-12 reps', description: 'Upper chest development', tips: 'Bench at 30-45¬∞, press dumbbells up and together', muscleGroups: ['chest', 'shoulders'] , video: 'https://www.youtube.com/watch?v=8iPEnn-ltC8' },
                { name: 'Barbell or Dumbbell Curls', duration: 3, reps: '3 sets of 12 reps', description: 'Bicep isolation and growth', tips: 'Keep elbows stationary, full range of motion, control the negative', muscleGroups: ['biceps'] , video: 'https://www.youtube.com/watch?v=ykJmrZ5v0Oo' },
                { name: 'Dumbbell Shoulder Press', duration: 4, reps: '3 sets of 10 reps', description: 'Shoulder strength and stability', tips: 'Press dumbbells overhead, palms forward or neutral grip', muscleGroups: ['shoulders'] , video: 'https://www.youtube.com/watch?v=qEwKCR5JCog' },
                { name: 'Cable or Dumbbell Tricep Extensions', duration: 3, reps: '3 sets of 12-15 reps', description: 'Tricep isolation', tips: 'Keep upper arms still, extend at elbow only', muscleGroups: ['triceps'] },
                { name: 'Pull-ups or Lat Pulldowns', duration: 4, reps: '3 sets of 8-10 reps', description: 'Vertical pulling strength', tips: 'Pull chest to bar or bar to chest, full extension at bottom', muscleGroups: ['back', 'biceps'] }
            ],
            
            // Lower Body Strength (Thursday)
            strengthLower: [
                { name: 'Barbell Back Squats', duration: 4, reps: '4 sets of 8-10 reps', description: 'King of lower body exercises', tips: 'Bar on upper back, squat to parallel or below, drive through heels', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=eGo4IYlbE5g' , video: 'https://www.youtube.com/watch?v=ultWZbUMPL8' },
                { name: 'Barbell Romanian Deadlifts', duration: 4, reps: '4 sets of 10 reps', description: 'Hamstring and glute developer', tips: 'Hip hinge, slight knee bend, lower bar to mid-shin', muscleGroups: ['hamstrings', 'glutes'] },
                { name: 'Dumbbell Walking Lunges', duration: 4, reps: '3 sets of 10 per leg', description: 'Unilateral leg strength with dumbbells', tips: 'Dumbbells at sides, long stride, knee doesn\'t pass toes', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=D7KaRcUTQeE' },
                { name: 'Leg Press Machine', duration: 4, reps: '4 sets of 12-15 reps', description: 'Quad-dominant leg builder', tips: 'Feet shoulder-width, push through full foot, controlled descent', muscleGroups: ['legs', 'glutes'] },
                { name: 'Dumbbell Bulgarian Split Squats', duration: 4, reps: '3 sets of 10 per leg', description: 'Single leg strength with dumbbells', tips: 'Back foot elevated, dumbbell in each hand, vertical torso', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=2C-uNgKwPLE' },
                { name: 'Barbell Hip Thrusts', duration: 3, reps: '3 sets of 12-15 reps', description: 'Maximum glute activation', tips: 'Upper back on bench, barbell on hips, squeeze glutes at top', muscleGroups: ['glutes', 'hamstrings'] },
                { name: 'Weighted Plank or Ab Wheel', duration: 3, reps: '3 sets of 30-45 sec', description: 'Advanced core strength', tips: 'Add weight plate on back or use ab wheel with control', muscleGroups: ['core'] },
                { name: 'Cable or Dumbbell Woodchops', duration: 3, reps: '3 sets of 12 per side', description: 'Rotational core strength', tips: 'Rotate through torso, keep arms relatively straight', muscleGroups: ['core', 'obliques'] }
            ],
            
            // Cross Training (Friday - Full Body Functional)
            crosstraining: [
                { name: 'Barbell or Dumbbell Thrusters', duration: 4, reps: '12-15 reps', description: 'Full body compound movement', tips: 'Squat with weight, drive up and press overhead in one motion', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=pAplQXk3dkU' },
                { name: 'Kettlebell Swings', duration: 3, reps: '15-20 swings', description: 'Power endurance with kettlebell', tips: 'Hip hinge, explosive hip drive, kettlebell to shoulder height', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=YSxHifyI6s8' },
                { name: 'Dumbbell Man Makers', duration: 4, reps: '8-10 reps', description: 'Ultimate full body movement', tips: 'Burpee + renegade row + squat clean + press. Total body burner', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=bdT_EJu2wFU' },
                { name: 'Barbell Clean and Press', duration: 4, reps: '8-10 reps', description: 'Olympic lift variation for power', tips: 'Clean bar to shoulders, then press overhead. Explosive movement', muscleGroups: ['full-body'] },
                { name: 'Dumbbell Snatches', duration: 3, reps: '10 per arm', description: 'Single arm power movement', tips: 'Explosively pull dumbbell from ground to overhead in one motion', muscleGroups: ['full-body'] },
                { name: 'Sandbag or Dumbbell Carries', duration: 3, reps: '40-50 meters', description: 'Loaded carry for total body strength', tips: 'Farmer carry, overhead carry, or bear hug carry', muscleGroups: ['full-body'] },
                { name: 'Medicine Ball Slams', duration: 3, reps: '15 reps', description: 'Full body explosive power', tips: 'Reach high with med ball, slam down hard, athletic stance', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=l30OxyJKwFI' },
                { name: 'Kettlebell Turkish Get-Ups', duration: 4, reps: '5 per side', description: 'Total body strength and coordination', tips: 'Move slowly, keep kettlebell overhead, control each position', muscleGroups: ['full-body'] },
                { name: 'Barbell Complexes', duration: 4, reps: '6-8 reps each movement', description: 'Multiple exercises without putting bar down', tips: 'Example: deadlift, row, clean, press, squat - all in sequence', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=CQm_8Baxz2c' },
                { name: 'Dumbbell Box Step-Ups', duration: 3, reps: '12 per leg', description: 'Weighted single leg power', tips: 'Hold dumbbells, step up explosively, drive through heel', muscleGroups: ['legs', 'glutes'] }
            ],
            
            // Recovery & Stretching (Wednesday & Sunday)
            stretching: [
                { name: 'Deep Breathing & Meditation', duration: 3, description: 'Mental recovery and breath work', tips: 'Focus on slow, deep breaths. Clear your mind' },
                { name: 'Cat-Cow Stretch', duration: 2, description: 'Spinal mobility and flexibility', tips: 'Move slowly between arched and rounded back positions' , video: 'https://www.youtube.com/watch?v=kqnua4rHVVA' },
                { name: 'World\'s Greatest Stretch', duration: 3, description: 'Full body dynamic mobility', tips: 'Lunge position with rotation, hold and breathe deeply' },
                { name: 'Pigeon Pose', duration: 3, description: 'Deep hip opener', tips: 'Hold each side for 90 seconds, breathe through discomfort' , video: 'https://www.youtube.com/watch?v=0_zTKaEHeu8' },
                { name: 'Seated Forward Fold', duration: 2, description: 'Hamstring and lower back stretch', tips: 'Reach for toes, keep back straight, hold the stretch' },
                { name: 'Thread the Needle', duration: 2, description: 'Shoulder and upper back mobility', tips: 'Thread arm under body, feel stretch in shoulder' },
                { name: 'Couch Stretch', duration: 3, description: 'Hip flexor deep stretch', tips: 'Back knee against wall, drive hips forward gently' , video: 'https://www.youtube.com/watch?v=vLYuV3RQ0_E' },
                { name: 'Chest Opener on Foam Roller', duration: 2, description: 'Thoracic spine and chest stretch', tips: 'Lie on roller, arms out wide, breathe deeply' },
                { name: 'Frog Stretch', duration: 3, description: 'Inner thigh and hip mobility', tips: 'Knees wide, slowly sink hips back, hold position' , video: 'https://www.youtube.com/watch?v=Hs4slWVvGkk' },
                { name: 'Supine Twist', duration: 2, description: 'Spinal rotation and release', tips: 'Knees fall to one side, shoulders flat, hold each side' , video: 'https://www.youtube.com/watch?v=Gj4NChDr1GA' },
                { name: 'Standing Quad Stretch', duration: 2, description: 'Front of leg flexibility', tips: 'Pull heel to glutes, hold for 60 seconds each leg' , video: 'https://www.youtube.com/watch?v=k_Jd7V9tjjo' },
                { name: 'Downward Dog', duration: 2, description: 'Full body stretch and recovery', tips: 'Press heels toward ground, straighten legs gradually' , video: 'https://www.youtube.com/watch?v=h0-gDoGRMcw' },
                { name: 'Child\'s Pose', duration: 3, description: 'Restorative full body relaxation', tips: 'Sink hips to heels, reach arms forward, breathe deeply' },
                { name: 'Shoulder Rolls & Neck Stretches', duration: 2, description: 'Upper body tension release', tips: 'Gentle circles, hold neck stretches for 30 seconds' }
            ],
            
            cooldown: [
                { name: 'Walk and Breathe', duration: 2, description: 'Active recovery to lower heart rate', tips: 'Deep breaths, slow pace, let heart rate come down' , video: 'https://www.youtube.com/watch?v=L1rKFAZnUYM' , video: 'https://www.youtube.com/watch?v=Jyy0ra2WcQQ' },
                { name: 'Standing Quad Stretch', duration: 1, description: 'Front of leg flexibility', tips: 'Hold ankle, pull heel to glutes, keep knees together' , video: 'https://www.youtube.com/watch?v=k_Jd7V9tjjo' },
                { name: 'Hamstring Stretch', duration: 1, description: 'Posterior chain flexibility', tips: 'Reach toward toes, keep back straight' , video: 'https://www.youtube.com/watch?v=D1XvVxHhwAo' },
                { name: 'Hip Flexor Stretch', duration: 1, description: 'Hip mobility and flexibility', tips: 'Lunge position, drive hips forward gently' , video: 'https://www.youtube.com/watch?v=aIVn7x96o9k' },
                { name: 'Shoulder & Chest Stretch', duration: 1, description: 'Upper body flexibility', tips: 'Hands behind back, open chest, pull shoulders back' , video: 'https://www.youtube.com/watch?v=bjYH9BLt9yw' },
                { name: 'Child\'s Pose', duration: 2, description: 'Full body relaxation stretch', tips: 'Sink hips to heels, reach arms forward, breathe deeply' },
                { name: 'Spinal Twist', duration: 1, description: 'Back and core mobility', tips: 'Seated or lying, gentle twist to each side' }
            ]
        };

        // Seeded random number generator for consistent daily workouts
        function seededRandom(seed) {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        function getDailySeed() {
            const today = new Date();
            return today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
        }

        function shuffleArray(array, seed) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Build a schedule array from the user's workout mix
        function buildScheduleFromMix(mix, totalDays) {
            const schedule = [];
            const types = ['hiit', 'upper-strength', 'lower-strength', 'cross-training', 'recovery'];
            
            // Add each type the specified number of times
            types.forEach(type => {
                const count = mix[type] || 0;
                for (let i = 0; i < count; i++) {
                    schedule.push(type);
                }
            });
            
            // If schedule is shorter than totalDays, fill with recovery
            while (schedule.length < totalDays) {
                schedule.push('recovery');
            }
            
            // Simple distribution: just return the schedule as-is
            // The order will be: hiit days, upper days, lower days, cross days, recovery days
            // This is predictable and won't cause any issues
            return schedule.slice(0, totalDays);
        }

        function generateWorkout() {
            const seed = getDailySeed();
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayOfMonth = today.getDate(); // 1-31
            
            // Determine workout type based on plan type
            let workoutType;
            let workoutFocus;
            let actualDayOfWeek = dayOfWeek;
            
            const typeMapping = {
                'hiit': { type: 'HIIT', focus: 'Full body high intensity' },
                'upper-strength': { type: 'Strength', focus: 'Upper body push & pull', dayOverride: 2 },
                'lower-strength': { type: 'Strength', focus: 'Lower body & core', dayOverride: 4 },
                'cross-training': { type: 'Cross Training', focus: 'Functional fitness & conditioning' },
                'recovery': { type: 'Recovery & Stretching', focus: 'Full body mobility and flexibility' }
            };
            
            if (workoutPreferences.planType === 'single' && workoutPreferences.singleWorkoutType) {
                // Single day - use selected type
                const selectedType = typeMapping[workoutPreferences.singleWorkoutType];
                workoutType = selectedType.type;
                workoutFocus = selectedType.focus;
                if (selectedType.dayOverride) {
                    actualDayOfWeek = selectedType.dayOverride;
                }
            } else if (workoutPreferences.planType === 'weekly' || workoutPreferences.planType === 'monthly') {
                // Weekly or monthly plan - use the user's custom mix
                const mix = workoutPreferences.workoutMix;
                const totalDays = workoutPreferences.planType === 'weekly' ? 7 : 30;
                
                // Check if mix has any values
                const mixTotal = Object.values(mix).reduce((a,b) => a+b, 0);
                
                if (mixTotal === totalDays) {
                    // Build a schedule based on the mix
                    const schedule = buildScheduleFromMix(mix, totalDays);
                    
                    // Get today's position in the plan
                    const planDay = workoutPreferences.planType === 'weekly' ? dayOfWeek : (dayOfMonth - 1) % 30;
                    const todayType = schedule[planDay] || 'recovery';
                    
                    const selectedType = typeMapping[todayType];
                    workoutType = selectedType.type;
                    workoutFocus = selectedType.focus;
                    if (selectedType.dayOverride) {
                        actualDayOfWeek = selectedType.dayOverride;
                    }
                    
                    // Store the schedule for display
                    workoutPreferences.currentSchedule = schedule;
                } else {
                    // Mix not complete, use default
                    const defaultSchedule = weeklySchedule[dayOfWeek];
                    workoutType = defaultSchedule.type;
                    workoutFocus = defaultSchedule.focus;
                }
            } else {
                // Fallback to default schedule (planType is 'single' but no type selected, or unknown planType)
                const defaultSchedule = weeklySchedule[dayOfWeek];
                workoutType = defaultSchedule.type;
                workoutFocus = defaultSchedule.focus;
            }
            
            // Get adjusted durations
            const durations = adjustWorkoutDuration();
            
            let workout = [];
            let totalTime = 0;

            // Stretching days - different structure
            if (workoutType === 'Recovery & Stretching') {
                // Light warmup
                const lightWarmup = [
                    { name: 'Gentle Walking', duration: 2, description: 'Easy pace to warm up', tips: 'Start slow, gradually increase pace slightly', category: 'Warm-up' , video: 'https://www.youtube.com/watch?v=RpFU-Z7AjP4' },
                    { name: 'Arm Swings', duration: 1, description: 'Dynamic shoulder mobility', tips: 'Gentle swinging motions, loosen shoulders', category: 'Warm-up' }
                ];
                lightWarmup.forEach(ex => {
                    workout.push(ex);
                    totalTime += ex.duration;
                });

                // Main stretching session
                const stretchingExercises = shuffleArray(exerciseDatabase.stretching, seed);
                let stretchTime = 0;
                const stretchDuration = durations.main;
                stretchingExercises.forEach(exercise => {
                    if (stretchTime < stretchDuration) {
                        workout.push({ ...exercise, category: 'Recovery Stretch' });
                        totalTime += exercise.duration;
                        stretchTime += exercise.duration;
                    }
                });

                // Relaxation cooldown
                workout.push({
                    name: 'Savasana / Final Relaxation',
                    duration: durations.cooldown,
                    description: 'Complete body relaxation',
                    tips: 'Lie flat, close eyes, focus on breathing and letting go of tension',
                    category: 'Cool-down'
                });
                totalTime += durations.cooldown;

                return {
                    exercises: workout,
                    totalTime,
                    workoutType,
                    workoutFocus,
                    dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                    weekInfo: getWeekInfo(dayOfWeek)
                };
            }

            // Regular workout days - Warmup
            const warmupExercises = shuffleArray(exerciseDatabase.warmup, seed);
            let warmupTime = 0;
            warmupExercises.forEach(exercise => {
                if (warmupTime < durations.warmup) {
                    workout.push({ ...exercise, category: 'Warm-up' });
                    totalTime += exercise.duration;
                    warmupTime += exercise.duration;
                }
            });

            // Main workout - based on day of week
            let mainWorkout = [];
            let mainTime = 0;
            
            if (workoutType === 'HIIT') {
                // HIIT Full Body
                let hiitExercises = shuffleArray(exerciseDatabase.hiit, seed + 1);
                hiitExercises = filterExercisesByPreferences(hiitExercises);
                const numExercises = durations.main <= 15 ? 4 : durations.main >= 35 ? 8 : 6;
                const selectedExercises = hiitExercises.slice(0, numExercises);
                
                // Do rounds based on duration
                const rounds = durations.main <= 15 ? 3 : 4;
                for (let round = 1; round <= rounds; round++) {
                    selectedExercises.forEach((exercise) => {
                        if (mainTime < durations.main) {
                            const adjustedExercise = adjustExerciseDifficulty(exercise);
                            mainWorkout.push({ 
                                ...adjustedExercise, 
                                category: `HIIT - Round ${round}`,
                                roundInfo: `Round ${round} of ${rounds}`
                            });
                            mainTime += adjustedExercise.duration;
                        }
                    });
                }
            } else if (workoutType === 'Strength' && (actualDayOfWeek === 2 || workoutFocus.includes('Upper'))) {
                // Upper Body Strength
                let upperExercises = shuffleArray(exerciseDatabase.strengthUpper, seed + 2);
                upperExercises = filterExercisesByPreferences(upperExercises);
                upperExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Upper Body Strength' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            } else if (workoutType === 'Strength' && (actualDayOfWeek === 4 || workoutFocus.includes('Lower'))) {
                // Lower Body & Core Strength
                let lowerExercises = shuffleArray(exerciseDatabase.strengthLower, seed + 3);
                lowerExercises = filterExercisesByPreferences(lowerExercises);
                lowerExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Lower Body & Core' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            } else if (workoutType === 'Strength') {
                // Generic Strength - alternate between upper and lower based on seed
                const isUpper = seed % 2 === 0;
                let exercises = shuffleArray(isUpper ? exerciseDatabase.strengthUpper : exerciseDatabase.strengthLower, seed + 2);
                exercises = filterExercisesByPreferences(exercises);
                exercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: isUpper ? 'Upper Body Strength' : 'Lower Body & Core' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            } else if (workoutType === 'Cross Training') {
                // Friday - Cross Training
                let crossExercises = shuffleArray(exerciseDatabase.crosstraining, seed + 4);
                crossExercises = filterExercisesByPreferences(crossExercises);
                crossExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Cross Training' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            }

            workout = workout.concat(mainWorkout);
            totalTime += mainTime;

            // Cooldown
            const cooldownExercises = shuffleArray(exerciseDatabase.cooldown, seed + 5);
            let cooldownTime = 0;
            cooldownExercises.forEach(exercise => {
                if (cooldownTime < durations.cooldown) {
                    workout.push({ ...exercise, category: 'Cool-down' });
                    totalTime += exercise.duration;
                    cooldownTime += exercise.duration;
                }
            });

            return { 
                exercises: workout, 
                totalTime,
                workoutType,
                workoutFocus: workoutFocus,
                dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                weekInfo: getWeekInfo(dayOfWeek)
            };
        }

        function getWeekInfo(currentDay) {
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            const typeMapping = {
                'hiit': { type: 'HIIT', focus: 'Full body high intensity' },
                'upper-strength': { type: 'Strength', focus: 'Upper body push & pull' },
                'lower-strength': { type: 'Strength', focus: 'Lower body & core' },
                'cross-training': { type: 'Cross Training', focus: 'Functional fitness' },
                'recovery': { type: 'Recovery & Stretching', focus: 'Mobility and flexibility' }
            };
            
            // Use custom schedule if available
            if (workoutPreferences.planType === 'weekly' && workoutPreferences.currentSchedule) {
                return daysOfWeek.map((day, index) => {
                    const scheduleType = workoutPreferences.currentSchedule[index] || 'recovery';
                    const mapped = typeMapping[scheduleType];
                    return {
                        day,
                        type: mapped.type,
                        isCurrent: index === currentDay,
                        focus: mapped.focus
                    };
                });
            }
            
            // Fallback to default schedule
            return daysOfWeek.map((day, index) => ({
                day,
                type: weeklySchedule[index].type,
                isCurrent: index === currentDay,
                focus: weeklySchedule[index].focus
            }));
        }

        function displayWorkout(workout) {
            const container = document.getElementById('workoutContainer');
            
            // Get workout type badge color
            const typeColors = {
                'HIIT': 'var(--energy-orange)',
                'Strength': 'var(--vibrant-cyan)',
                'Cross Training': 'var(--electric-yellow)',
                'Recovery & Stretching': '#9B59B6'
            };

            // Create weekly schedule display
            const weekScheduleHtml = `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.08em; margin-bottom: 1rem; color: var(--electric-yellow);">Weekly Training Schedule</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem;">
                        ${workout.weekInfo.map(dayInfo => `
                            <div style="
                                background: ${dayInfo.isCurrent ? 'linear-gradient(135deg, var(--energy-orange), #FF8C42)' : 'rgba(255, 255, 255, 0.03)'};
                                padding: 0.75rem 0.5rem;
                                border-radius: 8px;
                                text-align: center;
                                border: ${dayInfo.isCurrent ? '2px solid var(--electric-yellow)' : '1px solid rgba(255, 255, 255, 0.1)'};
                                ${dayInfo.isCurrent ? 'box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);' : ''}
                            ">
                                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.3rem; ${dayInfo.isCurrent ? 'color: white;' : 'color: rgba(255, 255, 255, 0.9);'}">${dayInfo.day}</div>
                                <div style="font-size: 0.65rem; ${dayInfo.isCurrent ? 'color: rgba(255, 255, 255, 0.95);' : 'color: rgba(255, 255, 255, 0.5);'} text-transform: uppercase; letter-spacing: 0.05em;">
                                    ${dayInfo.type === 'Recovery & Stretching' ? 'üßò Recovery' : 
                                      dayInfo.type === 'HIIT' ? 'üî• HIIT' : 
                                      dayInfo.type === 'Strength' ? 'üí™ Strength' : 
                                      '‚ö° Cross'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            let html = `
                ${weekScheduleHtml}
                <div class="workout-summary">
                    <div style="display: inline-block; background: ${typeColors[workout.workoutType]}; color: var(--deep-charcoal); padding: 0.5rem 1.5rem; border-radius: 50px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem;">
                        ${workout.dayName} - ${workout.workoutType}
                    </div>
                    <h2>${workout.workoutFocus}</h2>
                    
                    <!-- Preferences Display -->
                    <div style="background: rgba(156, 39, 176, 0.15); padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid rgba(156, 39, 176, 0.3);">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">‚öôÔ∏è</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px;">${workoutPreferences.duration} min</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; text-transform: capitalize;">${workoutPreferences.difficulty}</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; text-transform: capitalize;">${workoutPreferences.equipment.replace('-', ' ')}</span>
                            ${workoutPreferences.injuries.length > 0 ? `<span style="font-size: 0.85rem; background: rgba(255, 107, 53, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px;">‚ö†Ô∏è ${workoutPreferences.injuries.length} modification${workoutPreferences.injuries.length > 1 ? 's' : ''}</span>` : ''}
                            <button onclick="showPreferencesModal()" style="margin-left: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 0.4rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.85rem;">Change</button>
                        </div>
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Time</div>
                            <div class="summary-value">${workout.totalTime} MIN</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Exercises</div>
                            <div class="summary-value">${workout.exercises.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Focus</div>
                            <div class="summary-value" style="font-size: 1.1rem; text-transform: uppercase;">
                                ${workout.workoutType === 'Recovery & Stretching' ? 'Recovery' : workout.workoutType}
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Intensity</div>
                            <div class="summary-value" style="font-size: 1.5rem;">
                                ${workout.workoutType === 'HIIT' ? 'üî•üî•üî•' : 
                                  workout.workoutType === 'Strength' ? 'üí™üí™' : 
                                  workout.workoutType === 'Cross Training' ? '‚ö°‚ö°‚ö°' : 
                                  'üßò‚Äç‚ôÄÔ∏è'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Detect if workout has repetitive rounds
            const hasRounds = workout.exercises.some(ex => ex.roundInfo);
            let exercisesToDisplay = workout.exercises;
            let totalRounds = 1;
            
            if (hasRounds) {
                // Check if rounds are repetitive (same exercises in each round)
                const roundMatch = workout.exercises[0]?.roundInfo?.match(/Round (\d+) of (\d+)/);
                if (roundMatch) {
                    totalRounds = parseInt(roundMatch[2]);
                    
                    // Get exercises from first round only (skip warmup/cooldown)
                    const firstRoundExercises = [];
                    let foundFirstRound = false;
                    
                    for (let ex of workout.exercises) {
                        if (ex.roundInfo) {
                            if (ex.roundInfo.includes('Round 1')) {
                                firstRoundExercises.push(ex);
                                foundFirstRound = true;
                            } else if (foundFirstRound && ex.roundInfo.includes('Round 2')) {
                                break; // Stop when we hit round 2
                            }
                        }
                    }
                    
                    // Check if pattern repeats
                    const exercisesPerRound = firstRoundExercises.length;
                    let isRepetitive = false;
                    
                    if (exercisesPerRound > 0) {
                        // Count how many exercises have roundInfo
                        const roundedExercises = workout.exercises.filter(ex => ex.roundInfo);
                        
                        if (roundedExercises.length === exercisesPerRound * totalRounds) {
                            // Assume repetitive unless we find a difference
                            isRepetitive = true;
                            
                            // Compare exercises across rounds
                            for (let i = 0; i < exercisesPerRound; i++) {
                                const firstExercise = roundedExercises[i];
                                for (let round = 1; round < totalRounds; round++) {
                                    const compareExercise = roundedExercises[i + (round * exercisesPerRound)];
                                    if (!compareExercise || 
                                        firstExercise.name !== compareExercise.name || 
                                        firstExercise.duration !== compareExercise.duration) {
                                        isRepetitive = false;
                                        break;
                                    }
                                }
                                if (!isRepetitive) break;
                            }
                        }
                    }
                    
                    if (isRepetitive) {
                        // Build new exercise list: warmup + first round + cooldown
                        const consolidatedExercises = [];
                        
                        // Add warmup (exercises without roundInfo before first round)
                        for (let ex of workout.exercises) {
                            if (!ex.roundInfo) {
                                consolidatedExercises.push(ex);
                            } else {
                                break; // Stop when we hit first round exercise
                            }
                        }
                        
                        // Add first round exercises only
                        consolidatedExercises.push(...firstRoundExercises);
                        
                        // Add cooldown (exercises without roundInfo after all rounds)
                        const cooldownExercises = [];
                        let afterAllRounds = false;
                        for (let ex of workout.exercises) {
                            if (ex.roundInfo && ex.roundInfo.includes(`Round ${totalRounds}`)) {
                                afterAllRounds = true;
                            } else if (afterAllRounds && !ex.roundInfo) {
                                cooldownExercises.push(ex);
                            }
                        }
                        consolidatedExercises.push(...cooldownExercises);
                        
                        exercisesToDisplay = consolidatedExercises;
                        console.log('Consolidated rounds:', totalRounds, 'exercises per round:', exercisesPerRound);
                    }
                }
            }

            let shownRepeatBanner = false;
            exercisesToDisplay.forEach((exercise, index) => {
                // Show REPEAT banner before first round exercise (if repetitive rounds exist)
                if (!shownRepeatBanner && exercise.roundInfo && exercise.roundInfo.includes('Round 1') && totalRounds > 1) {
                    shownRepeatBanner = true;
                    html += `
                        <div style="
                            background: var(--card-bg);
                            padding: 2rem;
                            border-radius: 20px;
                            margin: 1.5rem 0;
                            border: 1px solid var(--border-color);
                            text-align: center;
                            position: relative;
                            overflow: hidden;
                            box-shadow: 0 4px 24px rgba(255, 107, 53, 0.2);
                        ">
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255, 107, 53, 0.08), rgba(247, 201, 72, 0.08)); pointer-events: none;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="display: inline-flex; align-items: center; gap: 0.75rem; background: linear-gradient(135deg, var(--energy-orange), #FF8C42); padding: 0.75rem 2rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3);">
                                    <span style="font-size: 1.5rem;">üîÅ</span>
                                    <span style="font-size: 1.25rem; font-weight: 700; color: white; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em;">
                                        REPEAT ${totalRounds} TIMES
                                    </span>
                                    <span style="font-size: 1.5rem;">üîÅ</span>
                                </div>
                                <div style="font-size: 0.95rem; color: var(--text-secondary); margin-top: 0.75rem; font-weight: 500;">
                                    Complete the circuit below ${totalRounds} times total
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                const repsInfo = exercise.reps ? `
                    <div style="background: rgba(247, 201, 72, 0.15); padding: 0.75rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(247, 201, 72, 0.3);">
                        <div style="font-weight: 700; color: var(--electric-yellow); margin-bottom: 0.3rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em;">Target</div>
                        <div style="color: rgba(255, 255, 255, 0.9);">${exercise.reps}</div>
                    </div>
                ` : '';

                // Performance tracking for non-stretching exercises
                const performanceTracking = exercise.category !== 'Recovery Stretch' && exercise.category !== 'Warm-up' && exercise.category !== 'Cool-down' ? `
                    <div style="background: rgba(0, 217, 255, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(0, 217, 255, 0.3);">
                        <div style="font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 0.75rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em;">üìà Track Performance</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Reps/Time</label>
                                <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="reps" placeholder="e.g., 15" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Weight/Level</label>
                                <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="weight" placeholder="e.g., 20lbs" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Notes</label>
                            <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="notes" placeholder="How did it feel?" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                        </div>
                        <button onclick="savePerformance('${exercise.name}')" style="margin-top: 0.75rem; background: var(--vibrant-cyan); color: var(--deep-charcoal); border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 700; font-size: 0.85rem; cursor: pointer; width: 100%; text-transform: uppercase; letter-spacing: 0.05em;">Save</button>
                        <div id="history-${exercise.name.replace(/\s+/g, '-')}" style="margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);"></div>
                    </div>
                ` : '';

                html += `
                    <div class="exercise-block" style="animation-delay: ${index * 0.05}s">
                        <div class="exercise-header">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--electric-yellow); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">
                                    ${exercise.category}
                                </div>
                                <div class="exercise-name">${exercise.name}</div>
                            </div>
                            <div class="exercise-duration">${exercise.duration} MIN</div>
                        </div>
                        <div class="exercise-description">${exercise.description}</div>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(exercise.name + ' proper form video')}" target="_blank" style="
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                            background: linear-gradient(135deg, #4285F4, #34A853);
                            color: white;
                            padding: 0.6rem 1.2rem;
                            border-radius: 8px;
                            text-decoration: none;
                            font-weight: 600;
                            font-size: 0.85rem;
                            margin: 1rem 0;
                            transition: all 0.3s;
                            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(66, 133, 244, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(66, 133, 244, 0.3)'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                            Search Form Video
                        </a>
                        ${repsInfo}
                        <div class="exercise-tips">
                            <div class="tips-title">üí° Pro Tip</div>
                            <div>${exercise.tips}</div>
                        </div>
                        ${performanceTracking}
                        <div class="timer-bar"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.classList.remove('hidden');
            container.style.opacity = '0';
            
            setTimeout(() => {
                container.style.animation = 'fadeInUp 0.8s ease-out forwards';
                
                // Add complete workout button
                const completeBtn = document.createElement('div');
                completeBtn.style.cssText = 'text-align: center; margin-top: 2rem;';
                completeBtn.innerHTML = `
                    <button onclick="markWorkoutComplete()" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 1.25rem 3rem; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4); font-family: 'Archivo', sans-serif;">
                        <span style="position: relative; z-index: 1;">‚úì Mark Workout Complete</span>
                    </button>
                `;
                container.appendChild(completeBtn);
            }, 100);
        }

        // Save exercise performance
        window.savePerformance = async function(exerciseName) {
            const inputs = document.querySelectorAll(`[data-exercise="${exerciseName}"]`);
            const perfData = {
                date: new Date().toISOString(),
                reps: '',
                weight: '',
                notes: ''
            };
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                perfData[field] = input.value;
            });
            
            if (perfData.reps || perfData.weight || perfData.notes) {
                await saveExercisePerformance(exerciseName, perfData);
                
                // Show confirmation
                const historyDiv = document.getElementById(`history-${exerciseName.replace(/\s+/g, '-')}`);
                if (historyDiv) {
                    historyDiv.innerHTML = '‚úì Saved! Keep crushing it!';
                    historyDiv.style.color = 'var(--electric-yellow)';
                    setTimeout(() => {
                        loadExerciseHistory(exerciseName);
                    }, 1500);
                }
            }
        }

        // Load exercise history
        async function loadExerciseHistory(exerciseName) {
            const history = await getExerciseHistory(exerciseName, 3);
            const historyDiv = document.getElementById(`history-${exerciseName.replace(/\s+/g, '-')}`);
            if (historyDiv && history.length > 0) {
                const lastEntry = history[0];
                historyDiv.innerHTML = `Last: ${lastEntry.reps || 'N/A'} ${lastEntry.weight ? `@ ${lastEntry.weight}` : ''}`;
                historyDiv.style.color = 'rgba(255, 255, 255, 0.6)';
            }
        }

        // Mark workout complete
        window.markWorkoutComplete = async function() {
            const workoutData = currentWorkout;
            const workoutId = await saveWorkoutCompletion(workoutData);
            
            if (workoutId) {
                // Show share modal
                showWorkoutShareModal(workoutId, workoutData);
            }
        }

        // Show modal to share workout with caption
        function showWorkoutShareModal(workoutId, workoutData) {
            const typeEmoji = workoutData.workoutType === 'HIIT' ? 'üî•' : 
                             workoutData.workoutType === 'Strength' ? 'üí™' : 
                             workoutData.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
            
            const modal = document.createElement('div');
            modal.id = 'shareModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem; animation: fadeIn 0.3s;';
            modal.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 20px; padding: 2rem; max-width: 500px; width: 100%; border: 2px solid var(--energy-orange); box-shadow: 0 20px 60px rgba(255, 107, 53, 0.3);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 4rem; margin-bottom: 0.5rem;">üéâ</div>
                        <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--electric-yellow); letter-spacing: 0.05em;">WORKOUT COMPLETE!</h2>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-size: 2.5rem;">${typeEmoji}</span>
                            <div>
                                <div style="font-weight: 700; color: var(--pure-white); font-size: 1.2rem;">${workoutData.workoutType}</div>
                                <div style="color: rgba(255,255,255,0.6);">${workoutData.dayName} ‚Ä¢ ${workoutData.totalTime} minutes ‚Ä¢ ${workoutData.exercises.length} exercises</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: var(--vibrant-cyan); margin-bottom: 0.5rem;">Share how you're feeling! (optional)</label>
                        <textarea id="workoutCaption" placeholder="Crushed it today! üí™ Feeling stronger every day..." style="width: 100%; padding: 0.875rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 1rem; resize: vertical; min-height: 80px; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="shareWorkout('${workoutId}')" style="flex: 1; background: linear-gradient(135deg, var(--energy-orange), #FF8C42); color: white; border: none; padding: 1rem; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em;">
                            üöÄ Share to Feed
                        </button>
                        <button onclick="skipShare('${workoutId}')" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            Skip
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        window.shareWorkout = async function(workoutId) {
            const caption = document.getElementById('workoutCaption')?.value || '';
            
            try {
                const workoutRef = doc(db, 'workouts', workoutId);
                await updateDoc(workoutRef, {
                    caption: caption,
                    sharedAt: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error updating caption:', error);
            }
            
            closeShareModal();
            showSuccessToast('Workout shared! Your friends can now cheer you on! üéâ');
        }

        window.skipShare = function(workoutId) {
            closeShareModal();
            showSuccessToast('Workout saved! Keep up the great work! üí™');
        }

        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) modal.remove();
        }

        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; z-index: 10001; box-shadow: 0 8px 30px rgba(76, 175, 80, 0.4); animation: slideUp 0.4s, fadeOut 0.4s 2.6s;';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Display stats and history
        async function displayStats() {
            const container = document.getElementById('statsContainer');
            const stats = await getStats();
            const history = await getWorkoutHistory(30);

            const workoutTypeBreakdown = Object.entries(stats.workoutTypes)
                .map(([type, count]) => `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--vibrant-cyan);">${count}</div>
                        <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.3rem;">${type}</div>
                    </div>
                `).join('');

            const recentWorkouts = history.slice(0, 10).map(w => {
                const date = new Date(w.date);
                const typeEmoji = w.workoutType === 'HIIT' ? 'üî•' : 
                                 w.workoutType === 'Strength' ? 'üí™' : 
                                 w.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
                return `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--energy-orange); margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--pure-white);">${typeEmoji} ${w.workoutType}</div>
                                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-top: 0.2rem;">${w.dayName} - ${w.totalTime} minutes</div>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--electric-yellow);">
                                ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            let html = `
                <div style="animation: fadeInUp 0.8s ease-out;">
                    <div class="workout-summary">
                        <h2>Your Progress & Stats</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Total Workouts</div>
                                <div class="summary-value">${stats.totalWorkouts}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Last 7 Days</div>
                                <div class="summary-value">${stats.last7Days}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Total Minutes</div>
                                <div class="summary-value">${stats.totalMinutes}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Current Streak</div>
                                <div class="summary-value" style="color: var(--electric-yellow);">üî• ${calculateStreak(history)}</div>
                            </div>
                        </div>
                    </div>

                    ${stats.totalWorkouts > 0 ? `
                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Workout Type Breakdown</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                ${workoutTypeBreakdown}
                            </div>
                        </div>

                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Recent Workouts</h3>
                            ${recentWorkouts}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                            <p style="font-size: 1.2rem; margin-bottom: 1rem;">No workouts recorded yet!</p>
                            <p>Complete your first workout to start tracking your progress.</p>
                        </div>
                    `}

                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="hideStats()" style="background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; font-family: 'Archivo', sans-serif;">
                            Back to Workout
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // Hide workout and social containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.add('hidden');
        }

        function calculateStreak(history) {
            if (history.length === 0) return 0;
            
            let streak = 0;
            const sortedHistory = history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let i = 0; i < sortedHistory.length; i++) {
                const workoutDate = new Date(sortedHistory[i].date);
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                
                // Check if workout is from expected date (or within same day)
                if (workoutDate.toDateString() === expectedDate.toDateString()) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        window.hideStats = function() {
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        // Leaderboard Functions
        async function getLeaderboardData(period = 'all-time') {
            try {
                const workoutsRef = collection(db, 'workouts');
                let q;
                
                if (period === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    q = query(
                        workoutsRef,
                        where('date', '>=', weekAgo.toISOString()),
                        orderBy('date', 'desc')
                    );
                } else if (period === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setDate(monthAgo.getDate() - 30);
                    q = query(
                        workoutsRef,
                        where('date', '>=', monthAgo.toISOString()),
                        orderBy('date', 'desc')
                    );
                } else {
                    // All time
                    q = query(workoutsRef, orderBy('date', 'desc'));
                }
                
                const querySnapshot = await getDocs(q);
                const workouts = querySnapshot.docs.map(doc => doc.data());
                
                // Aggregate by user
                const userStats = {};
                workouts.forEach(workout => {
                    if (!userStats[workout.userId]) {
                        userStats[workout.userId] = {
                            userId: workout.userId,
                            displayName: workout.displayName || workout.username || 'Anonymous Camper',
                            photoURL: workout.photoURL || '',
                            totalWorkouts: 0,
                            totalMinutes: 0,
                            workoutTypes: {}
                        };
                    }
                    
                    userStats[workout.userId].totalWorkouts++;
                    userStats[workout.userId].totalMinutes += workout.totalTime || 0;
                    
                    const type = workout.workoutType || 'Other';
                    userStats[workout.userId].workoutTypes[type] = 
                        (userStats[workout.userId].workoutTypes[type] || 0) + 1;
                });
                
                // Convert to array and sort by total workouts
                const leaderboard = Object.values(userStats)
                    .sort((a, b) => b.totalWorkouts - a.totalWorkouts)
                    .slice(0, 50); // Top 50
                
                console.log(`Leaderboard (${period}):`, leaderboard);
                return leaderboard;
            } catch (error) {
                console.error('Error getting leaderboard:', error);
                return [];
            }
        }

        async function displayLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            
            // Hide other containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.add('hidden');
            container.classList.remove('hidden');
            
            // Default to all-time leaderboard
            let currentPeriod = 'all-time';
            
            async function renderLeaderboard(period) {
                currentPeriod = period;
                const leaderboard = await getLeaderboardData(period);
                
                // Find current user's rank
                const currentUserRank = leaderboard.findIndex(u => u.userId === currentUser.id) + 1;
                
                const periodLabels = {
                    'week': 'This Week',
                    'month': 'This Month',
                    'all-time': 'All Time'
                };
                
                let html = `
                    <div style="animation: fadeInUp 0.8s ease-out;">
                        <div class="workout-summary">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                                <h2 style="margin: 0;">üèÜ Camp Hope Leaderboard</h2>
                                <button onclick="hideLeaderboard()" style="background: rgba(255, 255, 255, 0.1); border: 2px solid var(--energy-orange); color: white; padding: 0.5rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ‚Üê Back to Workout
                                </button>
                            </div>
                            
                            <!-- Period Selector -->
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; justify-content: center; flex-wrap: wrap;">
                                <button class="period-btn" data-period="week" style="padding: 0.75rem 1.5rem; background: ${period === 'week' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${period === 'week' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    üìÖ This Week
                                </button>
                                <button class="period-btn" data-period="month" style="padding: 0.75rem 1.5rem; background: ${period === 'month' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${period === 'month' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    üìÜ This Month
                                </button>
                                <button class="period-btn" data-period="all-time" style="padding: 0.75rem 1.5rem; background: ${period === 'all-time' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${period === 'all-time' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    üèÖ All Time
                                </button>
                            </div>
                            
                            ${currentUserRank > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(247, 201, 72, 0.2)); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid var(--energy-orange);">
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--electric-yellow); margin-bottom: 0.5rem;">
                                        Your Rank: #${currentUserRank} üéØ
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
                                        ${leaderboard[currentUserRank - 1].totalWorkouts} workouts ‚Ä¢ ${leaderboard[currentUserRank - 1].totalMinutes} minutes
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1.5rem; text-align: center;">
                                ${periodLabels[period]} Rankings
                            </div>
                `;
                
                if (leaderboard.length === 0) {
                    html += `
                        <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üèïÔ∏è</div>
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No campers on the board yet!</div>
                            <div style="font-size: 0.9rem;">Be the first to complete a workout and claim the top spot!</div>
                        </div>
                    `;
                } else {
                    leaderboard.forEach((user, index) => {
                        const rank = index + 1;
                        const isCurrentUser = user.userId === currentUser.id;
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                        
                        // Get most common workout type
                        const topType = Object.entries(user.workoutTypes)
                            .sort((a, b) => b[1] - a[1])[0];
                        const typeEmoji = topType ? (
                            topType[0].includes('HIIT') ? 'üî•' :
                            topType[0].includes('Strength') ? 'üí™' :
                            topType[0].includes('Cross') ? '‚ö°' : 'üßò'
                        ) : 'üí™';
                        
                        html += `
                            <div style="
                                background: ${isCurrentUser ? 'linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(0, 184, 212, 0.2))' : 'rgba(255, 255, 255, 0.05)'};
                                padding: 1.25rem;
                                border-radius: 12px;
                                margin-bottom: 1rem;
                                border: 2px solid ${isCurrentUser ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.1)'};
                                transition: all 0.3s;
                            " onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform=''">
                                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                    <div style="
                                        font-size: 1.5rem;
                                        font-weight: 700;
                                        min-width: 50px;
                                        text-align: center;
                                        color: ${rank <= 3 ? 'var(--electric-yellow)' : 'var(--vibrant-cyan)'};
                                    ">
                                        ${medal}
                                    </div>
                                    ${user.photoURL ? `
                                        <img src="${user.photoURL}" alt="${user.displayName}" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid ${isCurrentUser ? 'var(--vibrant-cyan)' : 'var(--energy-orange)'};">
                                    ` : `
                                        <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--energy-orange); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.5rem;">
                                            ${user.displayName.charAt(0).toUpperCase()}
                                        </div>
                                    `}
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 700; font-size: 1.1rem; color: ${isCurrentUser ? 'var(--vibrant-cyan)' : 'var(--pure-white)'};">
                                            ${user.displayName} ${isCurrentUser ? '(You!)' : ''}
                                        </div>
                                        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                                <span style="color: var(--electric-yellow); font-weight: 600;">${user.totalWorkouts}</span> workouts
                                            </div>
                                            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                                <span style="color: var(--energy-orange); font-weight: 600;">${user.totalMinutes}</span> minutes
                                            </div>
                                            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                                ${typeEmoji} ${topType ? topType[0] : 'Mixed'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Add period button event listeners
                container.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        renderLeaderboard(btn.dataset.period);
                    });
                });
            }
            
            // Initial render
            renderLeaderboard(currentPeriod);
        }

        window.hideLeaderboard = function() {
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        // Social Feed Functions
        async function displaySocialFeed() {
            const container = document.getElementById('socialContainer');
            const friends = await getFriendProfiles();
            const activity = await getAllActivity(30);
            const notifications = await getNotifications(10);
            const unreadCount = notifications.filter(n => !n.read).length;

            // Generate activity cards with kudos and comments
            const activityCards = activity.map(act => {
                const date = new Date(act.date);
                const typeEmoji = act.workoutType === 'HIIT' ? 'üî•' : 
                                 act.workoutType === 'Strength' ? 'üí™' : 
                                 act.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
                const timeAgo = getTimeAgo(date);
                const workoutId = act.id || act.docId || `${act.userId}_${act.date?.split('T')[0]}`;
                const kudos = act.kudos || [];
                const comments = act.comments || [];
                const hasGivenKudos = kudos.some(k => k.userId === currentUser.id);
                const isOwnWorkout = act.userId === currentUser.id;
                
                // Generate kudos avatars (show first 5)
                const kudosAvatars = kudos.slice(0, 5).map(k => 
                    `<img src="${k.photoURL || ''}" title="${k.displayName}" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--card-bg); margin-left: -8px; object-fit: cover; background: rgba(255,255,255,0.1);">`
                ).join('');
                
                // Generate comments HTML
                const commentsHtml = comments.slice(0, 3).map(c => {
                    const commentTimeAgo = getTimeAgo(new Date(c.timestamp));
                    const canDelete = c.userId === currentUser.id || isOwnWorkout;
                    return `
                        <div style="display: flex; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <img src="${c.photoURL || ''}" style="width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; cursor: pointer; object-fit: cover; background: rgba(255,255,255,0.1);" onclick="viewUserProfile('${c.userId}')">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
                                    <div>
                                        <span style="font-weight: 600; color: var(--pure-white); cursor: pointer;" onclick="viewUserProfile('${c.userId}')">${c.displayName}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem; margin-left: 0.5rem;">${commentTimeAgo}</span>
                                    </div>
                                    ${canDelete ? `<button onclick="deleteComment('${workoutId}', '${c.id}')" style="background: none; border: none; color: rgba(255,255,255,0.3); cursor: pointer; font-size: 0.75rem; padding: 0.2rem;">‚úï</button>` : ''}
                                </div>
                                <div style="color: rgba(255,255,255,0.85); font-size: 0.9rem; margin-top: 0.2rem; word-wrap: break-word;">${c.text}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div style="background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 1.25rem; overflow: hidden;">
                        <!-- Header -->
                        <div style="padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.875rem;">
                            <img src="${act.photoURL || ''}" style="width: 48px; height: 48px; border-radius: 50%; cursor: pointer; object-fit: cover; background: rgba(255,255,255,0.1);" onclick="viewUserProfile('${act.userId}')">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: var(--pure-white); cursor: pointer;" onclick="viewUserProfile('${act.userId}')">${act.displayName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">${timeAgo}</div>
                            </div>
                            ${isOwnWorkout ? '<div style="background: rgba(255,107,53,0.2); padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.75rem; color: var(--energy-orange); font-weight: 600;">YOU</div>' : ''}
                        </div>
                        
                        <!-- Workout Card -->
                        <div style="padding: 0 1.25rem;">
                            <div style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(247,201,72,0.05)); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(255,107,53,0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--energy-orange), var(--electric-yellow)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">
                                        ${typeEmoji}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; color: var(--pure-white); font-size: 1.1rem;">${act.workoutType} Workout</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.2rem;">
                                            ${act.dayName} ‚Ä¢ ${act.totalTime} minutes ‚Ä¢ ${act.exercisesCompleted || 0} exercises
                                        </div>
                                    </div>
                                </div>
                                ${act.caption ? `
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                        <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.5;">"${act.caption}"</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Social Stats Bar -->
                        <div style="padding: 0.75rem 1.25rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            ${kudos.length > 0 ? `
                                <div style="display: flex; align-items: center; cursor: pointer;" onclick='showKudosList(${JSON.stringify(kudos).replace(/'/g, "\\'")})'>
                                    <div style="display: flex; margin-right: 0.5rem; padding-left: 8px;">
                                        ${kudosAvatars}
                                    </div>
                                    <span style="color: var(--text-secondary); font-size: 0.85rem;">${kudos.length} kudos</span>
                                </div>
                            ` : ''}
                            ${comments.length > 0 ? `
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">${comments.length} comment${comments.length !== 1 ? 's' : ''}</span>
                            ` : ''}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="padding: 0.5rem 1.25rem; display: flex; gap: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <button onclick="giveKudos('${workoutId}')" style="flex: 1; background: ${hasGivenKudos ? 'rgba(255, 107, 53, 0.2)' : 'rgba(255,255,255,0.05)'}; border: ${hasGivenKudos ? '2px solid var(--energy-orange)' : '1px solid rgba(255,255,255,0.1)'}; color: ${hasGivenKudos ? 'var(--energy-orange)' : 'rgba(255,255,255,0.8)'}; padding: 0.75rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;">
                                <span style="font-size: 1.2rem;">${hasGivenKudos ? 'üëè' : 'üëã'}</span>
                                <span>${hasGivenKudos ? 'Kudos Given!' : 'Give Kudos'}</span>
                            </button>
                            <button onclick="document.getElementById('comment-input-${workoutId}').focus()" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); padding: 0.75rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üí¨</span>
                                <span>Comment</span>
                            </button>
                        </div>
                        
                        <!-- Comments Section -->
                        ${comments.length > 0 ? `
                            <div style="padding: 0 1.25rem;">
                                ${commentsHtml}
                                ${comments.length > 3 ? `
                                    <button onclick="showAllComments('${workoutId}')" style="width: 100%; background: none; border: none; color: var(--vibrant-cyan); padding: 0.75rem; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                        View all ${comments.length} comments
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Add Comment Input -->
                        <div style="padding: 1rem 1.25rem; display: flex; gap: 0.75rem; align-items: center;">
                            <img src="${currentUser.photoURL || ''}" style="width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; object-fit: cover; background: rgba(255,255,255,0.1);">
                            <div style="flex: 1; display: flex; gap: 0.5rem;">
                                <input type="text" id="comment-input-${workoutId}" placeholder="Add a comment..." style="flex: 1; padding: 0.6rem 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; color: white; font-size: 0.9rem;" onkeypress="if(event.key==='Enter')addComment('${workoutId}')">
                                <button onclick="addComment('${workoutId}')" style="background: var(--vibrant-cyan); color: var(--deep-charcoal); border: none; padding: 0.6rem 1rem; border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 0.85rem;">Post</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            let html = `
                <div style="animation: fadeInUp 0.8s ease-out;">
                    <!-- Header with Notifications -->
                    <div class="workout-summary" style="background: linear-gradient(135deg, rgba(247, 201, 72, 0.1), rgba(255, 107, 53, 0.1)); border: 2px solid rgba(247, 201, 72, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0;">üë• Activity Feed</h2>
                                <p style="color: var(--text-secondary); margin-top: 0.25rem; font-size: 0.9rem;">See what your friends are up to</p>
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                                <button onclick="showNotifications()" style="position: relative; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    üîî Notifications
                                    ${unreadCount > 0 ? `<span style="background: var(--energy-orange); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px; font-weight: 700;">${unreadCount}</span>` : ''}
                                </button>
                                <button onclick="hideSocial()" style="background: rgba(255, 255, 255, 0.1); border: 2px solid var(--energy-orange); color: white; padding: 0.6rem 1.25rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ‚Üê Back
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 0.5rem; margin: 1.5rem 0; overflow-x: auto; padding-bottom: 0.5rem;">
                        <button onclick="switchFeedTab('feed')" id="tab-feed" class="feed-tab active" style="background: var(--energy-orange); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                            üì∞ Feed
                        </button>
                        <button onclick="switchFeedTab('friends')" id="tab-friends" class="feed-tab" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                            üë• Friends (${friends.length})
                        </button>
                        <button onclick="switchFeedTab('discover')" id="tab-discover" class="feed-tab" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                            üîç Find Friends
                        </button>
                    </div>

                    <!-- Feed Tab Content -->
                    <div id="feed-content" class="tab-content">
                        ${activity.length > 0 ? activityCards : `
                            <div style="text-align: center; padding: 3rem; background: rgba(255,255,255,0.03); border-radius: 16px;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üèÉ‚Äç‚ôÇÔ∏è</div>
                                <div style="font-size: 1.2rem; font-weight: 600; color: var(--pure-white); margin-bottom: 0.5rem;">No activity yet!</div>
                                <div style="color: var(--text-secondary);">Complete a workout or add friends to see activity here.</div>
                            </div>
                        `}
                    </div>

                    <!-- Friends Tab Content -->
                    <div id="friends-content" class="tab-content" style="display: none;">
                        ${friends.length > 0 ? `
                            <div style="display: grid; gap: 1rem;">
                                ${await Promise.all(friends.map(async friend => {
                                    const stats = await getFriendStats(friend.uid || friend.id);
                                    return `
                                        <div style="background: var(--card-bg); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s;" onclick="viewUserProfile('${friend.uid || friend.id}')" onmouseover="this.style.borderColor='var(--energy-orange)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <img src="${friend.photoURL || ''}" style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; background: rgba(255,255,255,0.1);">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 700; color: var(--pure-white); font-size: 1.1rem;">${friend.displayName}</div>
                                                    <div style="color: var(--text-secondary); font-size: 0.85rem;">@${friend.email?.split('@')[0] || 'user'}</div>
                                                </div>
                                                ${stats ? `
                                                    <div style="text-align: right;">
                                                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--vibrant-cyan);">${stats.totalWorkouts}</div>
                                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">workouts</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${stats?.lastWorkout ? `
                                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; color: var(--text-secondary);">
                                                    Last active: ${new Date(stats.lastWorkout).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                })).then(items => items.join(''))}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 3rem; background: rgba(255,255,255,0.03); border-radius: 16px;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üëã</div>
                                <div style="font-size: 1.2rem; font-weight: 600; color: var(--pure-white); margin-bottom: 0.5rem;">No friends yet!</div>
                                <div style="color: var(--text-secondary);">Add friends to stay motivated together.</div>
                            </div>
                        `}
                    </div>

                    <!-- Discover Tab Content -->
                    <div id="discover-content" class="tab-content" style="display: none;">
                        <div class="workout-summary">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; color: var(--electric-yellow); margin-bottom: 1rem;">Add Friend by Email</h3>
                            <div style="display: flex; gap: 0.75rem;">
                                <input type="email" id="friendUsernameInput" placeholder="Enter their Google email" style="flex: 1; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.08); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: white; font-size: 1rem;">
                                <button onclick="addFriendHandler()" style="background: linear-gradient(135deg, var(--energy-orange), #FF8C42); color: white; border: none; padding: 0.875rem 1.75rem; border-radius: 10px; font-weight: 700; cursor: pointer; white-space: nowrap;">
                                    + Add Friend
                                </button>
                            </div>
                            <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,217,255,0.1); border-radius: 8px; border: 1px solid rgba(0,217,255,0.2);">
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    üí° <strong style="color: var(--vibrant-cyan);">Tip:</strong> Friends need to have signed in at least once before you can add them. Share the app with them first!
                                </div>
                            </div>
                        </div>
                        
                        <!-- Invite Section -->
                        <div class="workout-summary" style="margin-top: 1.5rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; color: var(--vibrant-cyan); margin-bottom: 1rem;">üì§ Invite Friends to Camp Hope</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Share this app with friends to workout together!</p>
                            <button onclick="shareApp()" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white; border: none; padding: 0.875rem 1.75rem; border-radius: 10px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                üì± Share App Link
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // Hide other containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.add('hidden');
        }

        // Tab switching for social feed
        window.switchFeedTab = function(tab) {
            // Update tab buttons
            document.querySelectorAll('.feed-tab').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.border = '1px solid rgba(255,255,255,0.2)';
            });
            const activeTab = document.getElementById(`tab-${tab}`);
            if (activeTab) {
                activeTab.style.background = 'var(--energy-orange)';
                activeTab.style.border = 'none';
            }
            
            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            const activeContent = document.getElementById(`${tab}-content`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }

        // Show notifications panel
        window.showNotifications = async function() {
            const notifications = await getNotifications(20);
            
            const modal = document.createElement('div');
            modal.id = 'notificationsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10001; display: flex; align-items: flex-start; justify-content: center; padding: 2rem 1rem; overflow-y: auto;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const notificationItems = notifications.length > 0 ? notifications.map(n => {
                const timeAgo = getTimeAgo(new Date(n.timestamp));
                const isUnread = !n.read;
                let icon, message;
                
                if (n.type === 'kudos') {
                    icon = 'üëè';
                    message = `<strong>${n.fromDisplayName}</strong> gave kudos to your ${n.workoutType} workout`;
                } else if (n.type === 'comment') {
                    icon = 'üí¨';
                    message = `<strong>${n.fromDisplayName}</strong> commented: "${n.commentPreview}..."`;
                } else if (n.type === 'follow') {
                    icon = 'üëã';
                    message = `<strong>${n.fromDisplayName}</strong> started following you`;
                } else {
                    icon = 'üîî';
                    message = 'New notification';
                }
                
                return `
                    <div style="display: flex; gap: 0.75rem; padding: 1rem; background: ${isUnread ? 'rgba(255,107,53,0.1)' : 'transparent'}; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border-left: ${isUnread ? '3px solid var(--energy-orange)' : '3px solid transparent'};" onclick="handleNotificationClick('${n.id}', '${n.fromUserId}')">
                        <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;">
                            ${icon}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.95rem; color: var(--pure-white);">${message}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('') : `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîî</div>
                    <div>No notifications yet</div>
                </div>
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 16px; max-width: 450px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--electric-yellow); margin: 0;">üîî Notifications</h3>
                        <button onclick="document.getElementById('notificationsModal').remove()" style="background: none; border: none; color: white; font-size: 1.3rem; cursor: pointer;">‚úï</button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 0.5rem;">
                        ${notificationItems}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        window.handleNotificationClick = async function(notifId, fromUserId) {
            await markNotificationRead(notifId);
            document.getElementById('notificationsModal')?.remove();
            viewUserProfile(fromUserId);
        }

        // Share app function
        window.shareApp = function() {
            const shareUrl = window.location.href;
            const shareText = "Join me on Camp Hope Fitness! üí™üî• Track workouts, compete with friends, and crush your fitness goals together!";
            
            if (navigator.share) {
                navigator.share({
                    title: 'Camp Hope Fitness',
                    text: shareText,
                    url: shareUrl
                }).catch(console.error);
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(`${shareText}\n\n${shareUrl}`).then(() => {
                    showSuccessToast('Link copied to clipboard! üìã');
                }).catch(() => {
                    alert(`Share this link with friends:\n\n${shareUrl}`);
                });
            }
        }

        // Show all comments for a workout
        window.showAllComments = async function(workoutId) {
            try {
                const workoutRef = doc(db, 'workouts', workoutId);
                const workoutSnap = await getDoc(workoutRef);
                
                if (!workoutSnap.exists()) return;
                
                const workoutData = workoutSnap.data();
                const comments = workoutData.comments || [];
                
                const modal = document.createElement('div');
                modal.id = 'allCommentsModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div style="background: var(--card-bg); border-radius: 16px; max-width: 500px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; color: var(--vibrant-cyan); margin: 0;">üí¨ Comments (${comments.length})</h3>
                            <button onclick="document.getElementById('allCommentsModal').remove()" style="background: none; border: none; color: white; font-size: 1.3rem; cursor: pointer;">‚úï</button>
                        </div>
                        <div style="flex: 1; overflow-y: auto; padding: 1rem;">
                            ${comments.map(c => {
                                const timeAgo = getTimeAgo(new Date(c.timestamp));
                                return `
                                    <div style="display: flex; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        <img src="${c.photoURL || ''}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; cursor: pointer; object-fit: cover; background: rgba(255,255,255,0.1);" onclick="document.getElementById('allCommentsModal').remove(); viewUserProfile('${c.userId}')">
                                        <div style="flex: 1;">
                                            <div>
                                                <span style="font-weight: 600; color: var(--pure-white);">${c.displayName}</span>
                                                <span style="color: var(--text-secondary); font-size: 0.8rem; margin-left: 0.5rem;">${timeAgo}</span>
                                            </div>
                                            <div style="color: rgba(255,255,255,0.85); font-size: 0.95rem; margin-top: 0.3rem; line-height: 1.4;">${c.text}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error showing comments:', error);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        window.addFriendHandler = async function() {
            const friendEmail = document.getElementById('friendUsernameInput').value.trim();
            if (!friendEmail) {
                alert('Please enter an email address');
                return;
            }
            
            const success = await addFriend(friendEmail);
            if (success) {
                alert(`Successfully added ${friendEmail} as a friend!`);
                displaySocialFeed(); // Refresh
            } else {
                alert('User not found or already friends. Make sure they\'ve signed in at least once!');
            }
        }

        window.hideSocial = function() {
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        let currentWorkout = null;

        // Generate workout button
        document.getElementById('generateBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            
            const container = document.getElementById('workoutContainer');
            const statsContainer = document.getElementById('statsContainer');
            const socialContainer = document.getElementById('socialContainer');
            const profileContainer = document.getElementById('profileContainer');
            const leaderboardContainer = document.getElementById('leaderboardContainer');
            
            // Hide stats, social, profile, and leaderboard if showing
            statsContainer.classList.add('hidden');
            socialContainer.classList.add('hidden');
            profileContainer.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');
            
            // Show loading
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="color: var(--electric-yellow); font-weight: 600; letter-spacing: 0.1em;">GENERATING YOUR WORKOUT...</p>
                </div>
            `;
            container.classList.remove('hidden');
            
            // Simulate loading for effect
            setTimeout(() => {
                const workout = generateWorkout();
                currentWorkout = workout; // Store for completion tracking
                displayWorkout(workout);
                
                // Load exercise histories
                setTimeout(() => {
                    workout.exercises.forEach(exercise => {
                        if (exercise.category !== 'Recovery Stretch' && 
                            exercise.category !== 'Warm-up' && 
                            exercise.category !== 'Cool-down') {
                            loadExerciseHistory(exercise.name);
                        }
                    });
                }, 500);
            }, 1500);
        });

        // View stats button
        document.getElementById('viewStatsBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displayStats();
        });

        // View leaderboard button
        document.getElementById('viewLeaderboardBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displayLeaderboard();
        });

        // Customize workout button
        document.getElementById('customizeBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            showPreferencesModal();
        });

        // View social feed button
        document.getElementById('viewSocialBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displaySocialFeed();
        });

        // View profile button
        document.getElementById('viewProfileBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displayProfile();
        });

        // ==========================================
        // PROFILE PAGE FUNCTIONALITY
        // ==========================================

        // Get user profile data from Firestore
        async function getProfileData() {
            if (!currentUser) return null;
            
            try {
                const profileRef = doc(db, 'profiles', currentUser.id);
                const profileSnap = await getDoc(profileRef);
                
                if (profileSnap.exists()) {
                    return profileSnap.data();
                }
                return {
                    measurements: [],
                    photos: [],
                    strengthRecords: [],
                    goals: {
                        targetWeight: '',
                        targetBodyFat: '',
                        notes: ''
                    }
                };
            } catch (error) {
                console.error('Error getting profile data:', error);
                return null;
            }
        }

        // Save profile data to Firestore
        async function saveProfileData(profileData) {
            if (!currentUser) return false;
            
            try {
                const profileRef = doc(db, 'profiles', currentUser.id);
                await setDoc(profileRef, {
                    ...profileData,
                    userId: currentUser.id,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                return true;
            } catch (error) {
                console.error('Error saving profile data:', error);
                return false;
            }
        }

        // Add new measurement entry
        window.addMeasurement = async function() {
            const profileData = await getProfileData() || { measurements: [] };
            
            const newMeasurement = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                weight: document.getElementById('measureWeight')?.value || '',
                bodyFat: document.getElementById('measureBodyFat')?.value || '',
                chest: document.getElementById('measureChest')?.value || '',
                waist: document.getElementById('measureWaist')?.value || '',
                hips: document.getElementById('measureHips')?.value || '',
                bicepLeft: document.getElementById('measureBicepLeft')?.value || '',
                bicepRight: document.getElementById('measureBicepRight')?.value || '',
                thighLeft: document.getElementById('measureThighLeft')?.value || '',
                thighRight: document.getElementById('measureThighRight')?.value || '',
                neck: document.getElementById('measureNeck')?.value || '',
                shoulders: document.getElementById('measureShoulders')?.value || ''
            };
            
            // Check if at least one value was entered
            const hasValue = Object.values(newMeasurement).some((v, i) => i > 1 && v !== '');
            if (!hasValue) {
                alert('Please enter at least one measurement');
                return;
            }
            
            profileData.measurements = profileData.measurements || [];
            profileData.measurements.unshift(newMeasurement);
            
            await saveProfileData(profileData);
            displayProfile();
        }

        // Delete measurement
        window.deleteMeasurement = async function(measurementId) {
            if (!confirm('Delete this measurement entry?')) return;
            
            const profileData = await getProfileData();
            if (profileData && profileData.measurements) {
                profileData.measurements = profileData.measurements.filter(m => m.id !== measurementId);
                await saveProfileData(profileData);
                displayProfile();
            }
        }

        // Add strength record
        window.addStrengthRecord = async function() {
            const profileData = await getProfileData() || { strengthRecords: [] };
            
            const exercise = document.getElementById('strengthExercise')?.value?.trim();
            const weight = document.getElementById('strengthWeight')?.value?.trim();
            const reps = document.getElementById('strengthReps')?.value?.trim();
            
            if (!exercise || !weight) {
                alert('Please enter exercise name and weight');
                return;
            }
            
            const newRecord = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                exercise: exercise,
                weight: weight,
                reps: reps || '1',
                notes: document.getElementById('strengthNotes')?.value || ''
            };
            
            profileData.strengthRecords = profileData.strengthRecords || [];
            profileData.strengthRecords.unshift(newRecord);
            
            await saveProfileData(profileData);
            displayProfile();
        }

        // Delete strength record
        window.deleteStrengthRecord = async function(recordId) {
            if (!confirm('Delete this strength record?')) return;
            
            const profileData = await getProfileData();
            if (profileData && profileData.strengthRecords) {
                profileData.strengthRecords = profileData.strengthRecords.filter(r => r.id !== recordId);
                await saveProfileData(profileData);
                displayProfile();
            }
        }

        // Handle photo upload
        window.handlePhotoUpload = async function(input, photoType) {
            const file = input.files[0];
            if (!file) return;
            
            // Check file size (max 2MB for base64 storage)
            if (file.size > 2 * 1024 * 1024) {
                alert('Photo must be less than 2MB. Please resize or compress the image.');
                return;
            }
            
            // Convert to base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const profileData = await getProfileData() || { photos: [] };
                
                const newPhoto = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    type: photoType, // 'before' or 'after' or 'progress'
                    data: e.target.result,
                    notes: ''
                };
                
                profileData.photos = profileData.photos || [];
                profileData.photos.unshift(newPhoto);
                
                await saveProfileData(profileData);
                displayProfile();
            };
            reader.readAsDataURL(file);
        }

        // Delete photo
        window.deletePhoto = async function(photoId) {
            if (!confirm('Delete this photo?')) return;
            
            const profileData = await getProfileData();
            if (profileData && profileData.photos) {
                profileData.photos = profileData.photos.filter(p => p.id !== photoId);
                await saveProfileData(profileData);
                displayProfile();
            }
        }

        // Save goals
        window.saveGoals = async function() {
            const profileData = await getProfileData() || {};
            
            profileData.goals = {
                targetWeight: document.getElementById('goalWeight')?.value || '',
                targetBodyFat: document.getElementById('goalBodyFat')?.value || '',
                notes: document.getElementById('goalNotes')?.value || ''
            };
            
            await saveProfileData(profileData);
            alert('Goals saved!');
        }

        // Generate strength progression chart data
        function getStrengthChartData(records, exerciseName) {
            const exerciseRecords = records
                .filter(r => r.exercise.toLowerCase() === exerciseName.toLowerCase())
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-12); // Last 12 entries
            
            return exerciseRecords;
        }

        // Get unique exercises from records
        function getUniqueExercises(records) {
            const exercises = new Set();
            records.forEach(r => exercises.add(r.exercise));
            return Array.from(exercises);
        }

        // Render mini chart for an exercise
        function renderMiniChart(records, exerciseName) {
            const data = getStrengthChartData(records, exerciseName);
            if (data.length < 2) return '<div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; text-align: center; padding: 1rem;">Need more entries for chart</div>';
            
            const weights = data.map(d => parseFloat(d.weight) || 0);
            const maxWeight = Math.max(...weights);
            const minWeight = Math.min(...weights);
            const range = maxWeight - minWeight || 1;
            
            const chartWidth = 280;
            const chartHeight = 80;
            const padding = 10;
            
            const points = data.map((d, i) => {
                const x = padding + (i / (data.length - 1)) * (chartWidth - padding * 2);
                const y = chartHeight - padding - ((parseFloat(d.weight) - minWeight) / range) * (chartHeight - padding * 2);
                return `${x},${y}`;
            }).join(' ');
            
            const firstWeight = weights[0];
            const lastWeight = weights[weights.length - 1];
            const change = lastWeight - firstWeight;
            const changePercent = ((change / firstWeight) * 100).toFixed(1);
            const changeColor = change >= 0 ? '#4CAF50' : '#FF5252';
            
            return `
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem;">
                    <svg width="${chartWidth}" height="${chartHeight}" style="display: block; margin: 0 auto;">
                        <defs>
                            <linearGradient id="chartGrad-${exerciseName.replace(/\s+/g, '')}" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--vibrant-cyan);stop-opacity:0.3" />
                                <stop offset="100%" style="stop-color:var(--vibrant-cyan);stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        <polyline
                            fill="none"
                            stroke="var(--vibrant-cyan)"
                            stroke-width="2"
                            points="${points}"
                        />
                        ${data.map((d, i) => {
                            const x = padding + (i / (data.length - 1)) * (chartWidth - padding * 2);
                            const y = chartHeight - padding - ((parseFloat(d.weight) - minWeight) / range) * (chartHeight - padding * 2);
                            return `<circle cx="${x}" cy="${y}" r="4" fill="var(--vibrant-cyan)" />`;
                        }).join('')}
                    </svg>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem;">
                        <span style="color: rgba(255,255,255,0.6);">${firstWeight} lbs</span>
                        <span style="color: ${changeColor}; font-weight: 700;">${change >= 0 ? '+' : ''}${change} lbs (${changePercent}%)</span>
                        <span style="color: rgba(255,255,255,0.6);">${lastWeight} lbs</span>
                    </div>
                </div>
            `;
        }

        // Render measurement trend
        function renderMeasurementTrend(measurements, field, label) {
            const data = measurements
                .filter(m => m[field] && !isNaN(parseFloat(m[field])))
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-8);
            
            if (data.length < 2) return '';
            
            const firstVal = parseFloat(data[0][field]);
            const lastVal = parseFloat(data[data.length - 1][field]);
            const change = lastVal - firstVal;
            const isWeightOrWaist = field === 'weight' || field === 'waist' || field === 'bodyFat';
            const isGood = isWeightOrWaist ? change <= 0 : change >= 0;
            const changeColor = isGood ? '#4CAF50' : '#FF5252';
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span style="color: rgba(255,255,255,0.8);">${label}</span>
                    <span style="color: ${changeColor}; font-weight: 600;">${change >= 0 ? '+' : ''}${change.toFixed(1)}</span>
                </div>
            `;
        }

        // Main display profile function
        async function displayProfile() {
            const container = document.getElementById('profileContainer');
            const profileData = await getProfileData() || {
                measurements: [],
                photos: [],
                strengthRecords: [],
                goals: {}
            };
            
            const measurements = profileData.measurements || [];
            const photos = profileData.photos || [];
            const strengthRecords = profileData.strengthRecords || [];
            const goals = profileData.goals || {};
            
            // Get unique exercises for charts
            const uniqueExercises = getUniqueExercises(strengthRecords);
            
            // Latest measurements
            const latestMeasurement = measurements[0] || {};
            
            // Separate photos by type
            const beforePhotos = photos.filter(p => p.type === 'before');
            const afterPhotos = photos.filter(p => p.type === 'after');
            const progressPhotos = photos.filter(p => p.type === 'progress');
            
            let html = `
                <div style="animation: fadeInUp 0.8s ease-out;">
                    <!-- Header -->
                    <div class="workout-summary" style="background: linear-gradient(135deg, rgba(233, 30, 99, 0.15), rgba(156, 39, 176, 0.15)); border: 2px solid rgba(233, 30, 99, 0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <img src="${currentUser.photoURL || ''}" alt="${currentUser.displayName}" style="width: 64px; height: 64px; border-radius: 50%; border: 3px solid var(--energy-orange);">
                                <div>
                                    <h2 style="margin: 0; font-size: 1.8rem;">${currentUser.displayName}'s Profile</h2>
                                    <p style="color: var(--text-secondary); margin-top: 0.25rem;">Track your transformation journey</p>
                                </div>
                            </div>
                            <button onclick="hideProfile()" style="background: rgba(255, 255, 255, 0.1); border: 2px solid var(--energy-orange); color: white; padding: 0.6rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                ‚Üê Back to Workout
                            </button>
                        </div>
                    </div>

                    <!-- Goals Section -->
                    <div class="workout-summary" style="margin-top: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--electric-yellow);">
                            üéØ My Goals
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Target Weight (lbs)</label>
                                <input type="number" id="goalWeight" value="${goals.targetWeight || ''}" placeholder="e.g., 180" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 1rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Target Body Fat %</label>
                                <input type="number" id="goalBodyFat" value="${goals.targetBodyFat || ''}" placeholder="e.g., 15" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 1rem;">
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label style="display: block; font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Personal Notes & Motivation</label>
                            <textarea id="goalNotes" placeholder="Why are you doing this? What's your ultimate goal?" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 0.95rem; resize: vertical; min-height: 80px;">${goals.notes || ''}</textarea>
                        </div>
                        <button onclick="saveGoals()" style="margin-top: 1rem; background: linear-gradient(135deg, var(--energy-orange), #FF8C42); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.95rem;">
                            üíæ Save Goals
                        </button>
                    </div>

                    <!-- Body Measurements Section -->
                    <div class="workout-summary" style="margin-top: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">
                            üìè Body Measurements
                        </h3>
                        
                        <!-- Progress Summary -->
                        ${measurements.length >= 2 ? `
                            <div style="background: rgba(0, 217, 255, 0.1); padding: 1rem 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(0, 217, 255, 0.3);">
                                <div style="font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 0.75rem; font-size: 0.95rem;">üìà Progress Since First Entry</div>
                                <div>
                                    ${renderMeasurementTrend(measurements, 'weight', 'Weight')}
                                    ${renderMeasurementTrend(measurements, 'bodyFat', 'Body Fat %')}
                                    ${renderMeasurementTrend(measurements, 'waist', 'Waist')}
                                    ${renderMeasurementTrend(measurements, 'chest', 'Chest')}
                                    ${renderMeasurementTrend(measurements, 'bicepRight', 'Bicep (R)')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Add New Measurement Form -->
                        <div style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-weight: 700; color: var(--electric-yellow); margin-bottom: 1rem; font-size: 0.95rem;">‚ûï Add New Measurement</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Weight (lbs)</label>
                                    <input type="number" step="0.1" id="measureWeight" placeholder="185" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Body Fat %</label>
                                    <input type="number" step="0.1" id="measureBodyFat" placeholder="20" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Neck (in)</label>
                                    <input type="number" step="0.1" id="measureNeck" placeholder="16" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Shoulders (in)</label>
                                    <input type="number" step="0.1" id="measureShoulders" placeholder="48" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Chest (in)</label>
                                    <input type="number" step="0.1" id="measureChest" placeholder="42" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Waist (in)</label>
                                    <input type="number" step="0.1" id="measureWaist" placeholder="34" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Hips (in)</label>
                                    <input type="number" step="0.1" id="measureHips" placeholder="38" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Bicep L (in)</label>
                                    <input type="number" step="0.1" id="measureBicepLeft" placeholder="14" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Bicep R (in)</label>
                                    <input type="number" step="0.1" id="measureBicepRight" placeholder="14.5" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Thigh L (in)</label>
                                    <input type="number" step="0.1" id="measureThighLeft" placeholder="24" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Thigh R (in)</label>
                                    <input type="number" step="0.1" id="measureThighRight" placeholder="24" style="width: 100%; padding: 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 0.9rem;">
                                </div>
                            </div>
                            <button onclick="addMeasurement()" style="margin-top: 1rem; background: var(--vibrant-cyan); color: var(--deep-charcoal); border: none; padding: 0.75rem 2rem; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.95rem;">
                                üìè Save Measurement
                            </button>
                        </div>
                        
                        <!-- Measurement History -->
                        ${measurements.length > 0 ? `
                            <div style="margin-top: 1.5rem;">
                                <div style="font-weight: 700; color: rgba(255,255,255,0.9); margin-bottom: 1rem;">üìã History (${measurements.length} entries)</div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${measurements.slice(0, 10).map(m => {
                                        const date = new Date(m.date);
                                        const displayFields = [];
                                        if (m.weight) displayFields.push(`<span style="color: var(--vibrant-cyan);">Weight:</span> ${m.weight} lbs`);
                                        if (m.bodyFat) displayFields.push(`<span style="color: var(--vibrant-cyan);">BF%:</span> ${m.bodyFat}%`);
                                        if (m.chest) displayFields.push(`<span style="color: var(--vibrant-cyan);">Chest:</span> ${m.chest}"`);
                                        if (m.waist) displayFields.push(`<span style="color: var(--vibrant-cyan);">Waist:</span> ${m.waist}"`);
                                        if (m.hips) displayFields.push(`<span style="color: var(--vibrant-cyan);">Hips:</span> ${m.hips}"`);
                                        if (m.bicepLeft || m.bicepRight) displayFields.push(`<span style="color: var(--vibrant-cyan);">Biceps:</span> ${m.bicepLeft || '-'}/${m.bicepRight || '-'}"`);
                                        if (m.thighLeft || m.thighRight) displayFields.push(`<span style="color: var(--vibrant-cyan);">Thighs:</span> ${m.thighLeft || '-'}/${m.thighRight || '-'}"`);
                                        
                                        return `
                                            <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid var(--vibrant-cyan);">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                    <div style="font-weight: 600; color: var(--electric-yellow);">
                                                        ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                    </div>
                                                    <button onclick="deleteMeasurement('${m.id}')" style="background: rgba(255,82,82,0.2); border: none; color: #FF5252; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                                                </div>
                                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                                    ${displayFields.join(' ‚Ä¢ ')}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No measurements recorded yet. Start tracking above!</div>'}
                    </div>

                    <!-- Before/After Photos Section -->
                    <div class="workout-summary" style="margin-top: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: #E91E63;">
                            üì∏ Progress Photos
                        </h3>
                        
                        <!-- Upload Buttons -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div>
                                <label style="display: block; background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1)); border: 2px dashed rgba(76, 175, 80, 0.5); padding: 1.5rem; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#4CAF50'" onmouseout="this.style.borderColor='rgba(76, 175, 80, 0.5)'">
                                    <input type="file" accept="image/*" onchange="handlePhotoUpload(this, 'before')" style="display: none;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div>
                                    <div style="font-weight: 700; color: #4CAF50;">Before Photo</div>
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 0.3rem;">Starting point</div>
                                </label>
                            </div>
                            <div>
                                <label style="display: block; background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(0, 217, 255, 0.1)); border: 2px dashed rgba(0, 217, 255, 0.5); padding: 1.5rem; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='var(--vibrant-cyan)'" onmouseout="this.style.borderColor='rgba(0, 217, 255, 0.5)'">
                                    <input type="file" accept="image/*" onchange="handlePhotoUpload(this, 'progress')" style="display: none;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìà</div>
                                    <div style="font-weight: 700; color: var(--vibrant-cyan);">Progress Photo</div>
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 0.3rem;">Check-in</div>
                                </label>
                            </div>
                            <div>
                                <label style="display: block; background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(255, 107, 53, 0.1)); border: 2px dashed rgba(255, 107, 53, 0.5); padding: 1.5rem; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='var(--energy-orange)'" onmouseout="this.style.borderColor='rgba(255, 107, 53, 0.5)'">
                                    <input type="file" accept="image/*" onchange="handlePhotoUpload(this, 'after')" style="display: none;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üèÜ</div>
                                    <div style="font-weight: 700; color: var(--energy-orange);">After Photo</div>
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 0.3rem;">Goal achieved!</div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Before/After Comparison -->
                        ${beforePhotos.length > 0 || afterPhotos.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                                <div style="font-weight: 700; color: var(--electric-yellow); margin-bottom: 1rem;">üîÑ Before & After Comparison</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem; text-align: center;">BEFORE</div>
                                        ${beforePhotos.length > 0 ? `
                                            <div style="position: relative;">
                                                <img src="${beforePhotos[0].data}" style="width: 100%; border-radius: 8px; border: 2px solid #4CAF50;">
                                                <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.75rem;">
                                                    ${new Date(beforePhotos[0].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                </div>
                                            </div>
                                        ` : '<div style="background: rgba(255,255,255,0.05); padding: 3rem; border-radius: 8px; text-align: center; color: rgba(255,255,255,0.4);">No before photo yet</div>'}
                                    </div>
                                    <div>
                                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem; text-align: center;">AFTER</div>
                                        ${afterPhotos.length > 0 ? `
                                            <div style="position: relative;">
                                                <img src="${afterPhotos[0].data}" style="width: 100%; border-radius: 8px; border: 2px solid var(--energy-orange);">
                                                <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.75rem;">
                                                    ${new Date(afterPhotos[0].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                </div>
                                            </div>
                                        ` : '<div style="background: rgba(255,255,255,0.05); padding: 3rem; border-radius: 8px; text-align: center; color: rgba(255,255,255,0.4);">No after photo yet</div>'}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- All Progress Photos -->
                        ${photos.length > 0 ? `
                            <div>
                                <div style="font-weight: 700; color: rgba(255,255,255,0.9); margin-bottom: 1rem;">üìÅ All Photos (${photos.length})</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem;">
                                    ${photos.map(p => {
                                        const typeColors = { before: '#4CAF50', progress: 'var(--vibrant-cyan)', after: 'var(--energy-orange)' };
                                        const typeLabels = { before: 'BEFORE', progress: 'PROGRESS', after: 'AFTER' };
                                        return `
                                            <div style="position: relative; border-radius: 8px; overflow: hidden; border: 2px solid ${typeColors[p.type] || '#666'};">
                                                <img src="${p.data}" style="width: 100%; aspect-ratio: 1; object-fit: cover;">
                                                <div style="position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); padding: 0.5rem;">
                                                    <div style="font-size: 0.7rem; font-weight: 700; color: ${typeColors[p.type]}">${typeLabels[p.type]}</div>
                                                    <div style="font-size: 0.65rem; color: rgba(255,255,255,0.7);">${new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}</div>
                                                </div>
                                                <button onclick="deletePhoto('${p.id}')" style="position: absolute; bottom: 4px; right: 4px; background: rgba(255,82,82,0.9); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center;">‚úï</button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No photos uploaded yet. Track your visual progress above!</div>'}
                        
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                üí° <strong>Tip:</strong> Take photos in the same pose, lighting, and clothing for the best comparison. Morning photos before eating are most consistent.
                            </div>
                        </div>
                    </div>

                    <!-- Strength Progression Section -->
                    <div class="workout-summary" style="margin-top: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--energy-orange);">
                            üí™ Strength Records & PRs
                        </h3>
                        
                        <!-- Add New Record Form -->
                        <div style="background: rgba(255,107,53,0.08); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,107,53,0.2); margin-bottom: 1.5rem;">
                            <div style="font-weight: 700; color: var(--energy-orange); margin-bottom: 1rem;">üèãÔ∏è Log New PR / Strength Record</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                                <div style="grid-column: span 2;">
                                    <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Exercise Name *</label>
                                    <input type="text" id="strengthExercise" placeholder="e.g., Bench Press, Deadlift, Squat" list="commonExercises" style="width: 100%; padding: 0.7rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.95rem;">
                                    <datalist id="commonExercises">
                                        <option value="Bench Press">
                                        <option value="Deadlift">
                                        <option value="Squat">
                                        <option value="Overhead Press">
                                        <option value="Barbell Row">
                                        <option value="Pull-ups">
                                        <option value="Dumbbell Curl">
                                        <option value="Tricep Extension">
                                        <option value="Leg Press">
                                        <option value="Romanian Deadlift">
                                        <option value="Lat Pulldown">
                                        <option value="Cable Row">
                                    </datalist>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Weight (lbs) *</label>
                                    <input type="number" id="strengthWeight" placeholder="225" style="width: 100%; padding: 0.7rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.95rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Reps</label>
                                    <input type="number" id="strengthReps" placeholder="5" style="width: 100%; padding: 0.7rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.95rem;">
                                </div>
                                <div style="grid-column: span 2;">
                                    <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.3rem;">Notes</label>
                                    <input type="text" id="strengthNotes" placeholder="e.g., New PR! Form felt good" style="width: 100%; padding: 0.7rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.95rem;">
                                </div>
                            </div>
                            <button onclick="addStrengthRecord()" style="margin-top: 1rem; background: linear-gradient(135deg, var(--energy-orange), #FF8C42); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.95rem;">
                                üí™ Save Record
                            </button>
                        </div>
                        
                        <!-- Exercise Progression Charts -->
                        ${uniqueExercises.length > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <div style="font-weight: 700; color: rgba(255,255,255,0.9); margin-bottom: 1rem;">üìä Progression Charts</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                    ${uniqueExercises.slice(0, 6).map(exercise => {
                                        const records = strengthRecords.filter(r => r.exercise === exercise);
                                        const latestRecord = records[0];
                                        const maxWeight = Math.max(...records.map(r => parseFloat(r.weight) || 0));
                                        return `
                                            <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                    <div style="font-weight: 700; color: var(--electric-yellow);">${exercise}</div>
                                                    <div style="background: var(--energy-orange); padding: 0.3rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 700;">PR: ${maxWeight} lbs</div>
                                                </div>
                                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">${records.length} entries</div>
                                                ${renderMiniChart(strengthRecords, exercise)}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Recent Records -->
                        ${strengthRecords.length > 0 ? `
                            <div>
                                <div style="font-weight: 700; color: rgba(255,255,255,0.9); margin-bottom: 1rem;">üïê Recent Records</div>
                                <div style="max-height: 350px; overflow-y: auto;">
                                    ${strengthRecords.slice(0, 15).map(r => {
                                        const date = new Date(r.date);
                                        return `
                                            <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid var(--energy-orange); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                                <div>
                                                    <div style="font-weight: 700; color: var(--pure-white);">${r.exercise}</div>
                                                    <div style="font-size: 0.85rem; color: var(--vibrant-cyan); margin-top: 0.2rem;">
                                                        ${r.weight} lbs √ó ${r.reps} reps
                                                    </div>
                                                    ${r.notes ? `<div style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 0.3rem;">"${r.notes}"</div>` : ''}
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="font-size: 0.85rem; color: var(--electric-yellow);">
                                                        ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                    </div>
                                                    <button onclick="deleteStrengthRecord('${r.id}')" style="background: rgba(255,82,82,0.2); border: none; color: #FF5252; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No strength records yet. Log your first lift above!</div>'}
                    </div>

                    <!-- Back Button -->
                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="hideProfile()" style="background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; font-family: 'Archivo', sans-serif;">
                            Back to Workout
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // Hide other containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.add('hidden');
        }

        window.hideProfile = function() {
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        // Auto-initialize on page load
        window.addEventListener('load', async function() {
            await initializeUser();
            await loadPreferences();
            
            if (currentUser) {
                // Show user profile badge
                document.getElementById('userProfileBadge').style.display = 'block';
                document.getElementById('displayNameSpan').textContent = currentUser.displayName;
                document.getElementById('usernameSpan').textContent = currentUser.username;
                
                // Auto-generate workout
                setTimeout(() => {
                    document.getElementById('generateBtn').click();
                }, 500);
            }
        });
    </script>
</body>
</html>
