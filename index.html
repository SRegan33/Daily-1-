<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>35 MINUTE DAILY WORKOUT</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=Archivo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --energy-orange: #FF6B35;
            --electric-yellow: #F7C948;
            --deep-charcoal: #0F0F14;
            --slate: #1A1A24;
            --card-bg: #1E1E2E;
            --vibrant-cyan: #00D9FF;
            --pure-white: #FFFFFF;
            --text-secondary: #94A3B8;
            --border-color: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Archivo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--deep-charcoal);
            color: var(--pure-white);
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.6;
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.02;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 217, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        @media (min-width: 768px) {
            .container {
                padding: 3rem 2rem;
            }
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            letter-spacing: 0.03em;
            background: linear-gradient(135deg, var(--energy-orange), var(--electric-yellow));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.75rem;
            line-height: 1.1;
            font-weight: 700;
        }

        .tagline {
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 600;
        }

        .date-display {
            display: inline-block;
            background: var(--card-bg);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: 0.02em;
            color: var(--text-secondary);
        }

        .generate-btn {
            background: linear-gradient(135deg, var(--energy-orange), #FF8C42);
            color: var(--pure-white);
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-family: 'Inter', 'Archivo', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.6);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .workout-container {
            margin-top: 2rem;
            opacity: 0;
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .workout-summary {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .workout-summary h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 0.05em;
            color: var(--electric-yellow);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .summary-item {
            text-align: center;
            padding: 1.25rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .summary-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .summary-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--vibrant-cyan);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.02em;
        }

        .exercise-block {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.25rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .exercise-block::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--energy-orange), var(--electric-yellow));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .exercise-block:hover::before {
            opacity: 1;
        }

        .exercise-block:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
            gap: 1rem;
        }

        .exercise-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.03em;
            color: var(--pure-white);
            font-weight: 700;
            line-height: 1.2;
        }

        .exercise-duration {
            background: linear-gradient(135deg, var(--energy-orange), #FF8C42);
            padding: 0.5rem 1.25rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }

        .exercise-description {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .exercise-tips {
            background: rgba(0, 217, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            margin-top: 1rem;
        }

        .tips-title {
            font-weight: 700;
            color: var(--vibrant-cyan);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
        }

        .timer-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--energy-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 3rem;
            }

            .exercise-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <!-- Auth Screen (Google Sign-In) -->
    <div id="authScreen" class="container">
        <header style="text-align: center; padding: 2rem 0;">
            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 4rem; color: var(--energy-orange); letter-spacing: 0.1em; text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3); margin-bottom: 0.5rem;">
                CAMP HOPE
            </div>
            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; color: var(--electric-yellow); letter-spacing: 0.15em; margin-bottom: 1rem;">
                FITNESS PROGRAM
            </div>
            <div style="font-size: 1rem; color: rgba(255, 255, 255, 0.7); font-style: italic; margin-bottom: 0.5rem;">
                "Lunch has been cancelled due to lack of hustle."
            </div>
            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.5);">
                - Tony Perkis
            </div>
        </header>
        
        <div style="max-width: 500px; margin: 2rem auto; text-align: center;">
            <div class="workout-summary" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(247, 201, 72, 0.2)); border: 3px solid var(--energy-orange);">
                <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: var(--electric-yellow); margin-bottom: 1rem; letter-spacing: 0.1em;">
                    I'M FEELING SKINNY, TONY!
                </h2>
                <p style="margin: 1.5rem 0; line-height: 1.6; color: rgba(255, 255, 255, 0.9); font-size: 1.05rem;">
                    Welcome to Camp Hope! Sign in to track your progress, get fit, and remember: 
                    <span style="color: var(--energy-orange); font-weight: 700;">you're not just a camper, you're a champion!</span>
                </p>
                <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 320px; margin: 2rem auto;">
                    <button onclick="signInWithGoogle()" style="background: white; color: #444; border: none; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; font-family: 'Archivo', sans-serif; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%;">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                    <button onclick="signInWithApple()" style="background: black; color: white; border: none; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; font-family: 'Archivo', sans-serif; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                        </svg>
                        Sign in with Apple
                    </button>
                </div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 2px dashed var(--electric-yellow);">
                    <div style="font-size: 0.95rem; color: var(--electric-yellow); font-weight: 700; margin-bottom: 0.5rem;">
                        üèïÔ∏è CAMP HOPE PROMISE üèïÔ∏è
                    </div>
                    <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8); line-height: 1.5;">
                        No more Mr. Chubby Guy! We're gonna have fun, get fit, and show that scale who's boss!
                    </div>
                </div>
                <p style="margin-top: 1.5rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.5); font-style: italic;">
                    Your journey is securely tracked with Firebase
                </p>
            </div>
        </div>
    </div>

    <!-- App Screen (Main Application) -->
    <div id="appScreen" class="container" style="display: none;">
        <header>
            <h1 style="color: var(--energy-orange);">CAMP HOPE</h1>
            <p class="tagline" style="color: var(--electric-yellow);">Fitness Program - Est. 1995</p>
            <div class="date-display" id="dateDisplay"></div>
            <div id="userProfileBadge" style="display: none; margin-top: 1rem;">
                <div style="display: inline-flex; align-items: center; gap: 0.75rem; background: rgba(0, 217, 255, 0.2); padding: 0.75rem 1.5rem; border-radius: 50px; border: 2px solid var(--vibrant-cyan);">
                    <img id="userAvatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;" src="" alt="User">
                    <div style="text-align: left;">
                        <div style="font-weight: 700; color: var(--vibrant-cyan);"><span id="displayNameSpan"></span></div>
                        <button onclick="signOutUser()" style="background: none; border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; font-size: 0.85rem; padding: 0; margin-top: 0.2rem;">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <div style="text-align: center;">
            <button class="generate-btn" id="generateBtn">
                <span style="position: relative; z-index: 1;">Generate Today's Workout</span>
            </button>
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="generate-btn" id="customizeBtn" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); box-shadow: 0 10px 30px rgba(156, 39, 176, 0.4); padding: 1rem 2rem; font-size: 1rem;">
                    <span style="position: relative; z-index: 1;">‚öôÔ∏è Customize Workout</span>
                </button>
                <button class="generate-btn" id="viewStatsBtn" style="background: linear-gradient(135deg, var(--vibrant-cyan), #00B8D4); box-shadow: 0 10px 30px rgba(0, 217, 255, 0.4); padding: 1rem 2rem; font-size: 1rem;">
                    <span style="position: relative; z-index: 1;">üìä My Progress</span>
                </button>
                <button class="generate-btn" id="viewLeaderboardBtn" style="background: linear-gradient(135deg, #FF6B35, #F7C948); box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4); padding: 1rem 2rem; font-size: 1rem;">
                    <span style="position: relative; z-index: 1;">üèÜ Leaderboard</span>
                </button>
                <button class="generate-btn" id="viewSocialBtn" style="background: linear-gradient(135deg, var(--electric-yellow), #F4A300); box-shadow: 0 10px 30px rgba(247, 201, 72, 0.4); padding: 1rem 2rem; font-size: 1rem;">
                    <span style="position: relative; z-index: 1;">üë• Friends & Feed</span>
                </button>
            </div>
        </div>

        <div id="leaderboardContainer" class="hidden"></div>
        <div id="socialContainer" class="hidden"></div>
        <div id="statsContainer" class="hidden"></div>
        <div id="workoutContainer" class="hidden"></div>

        <footer>
            <p><strong>Your Weekly Training Plan:</strong></p>
            <p style="margin-top: 0.5rem; line-height: 1.8;">
                Mon: HIIT üî• | Tue: Upper Body üí™ | Wed: Recovery üßò | Thu: Lower Body & Core üí™ | Fri: Cross Training ‚ö° | Sat: HIIT üî• | Sun: Recovery üßò
            </p>
            <p style="margin-top: 1rem; font-size: 0.85rem;">Consistent workouts. Smart recovery. Maximum results.</p>
            <p style="margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.5);">
                <strong>Equipment needed:</strong> Barbell, dumbbells, kettlebell, bench, and basic gym setup. Most workouts require weights for optimal results.
            </p>
        </footer>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, OAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, limit as firestoreLimit, updateDoc, arrayUnion, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyANOaf5ePwf26-NTBDra6qugOJCaiSELTk",
            authDomain: "camp-hope-2ca32.firebaseapp.com",
            projectId: "camp-hope-2ca32",
            storageBucket: "camp-hope-2ca32.firebasestorage.app",
            messagingSenderId: "543842577310",
            appId: "1:543842577310:web:3ac478061d1de5430d048f",
            measurementId: "G-NJV0K3DK72"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Display today's date
        const dateDisplay = document.getElementById('dateDisplay');
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateDisplay.textContent = today.toLocaleDateString('en-US', options);

        // User Profile Management with Firebase Auth
        let currentUser = null;

        // Firebase Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUser = {
                    id: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    username: user.email.split('@')[0]
                };
                
                // Initialize user profile in Firestore
                await initializeUserProfile(user);
                
                // Load preferences
                await loadPreferences();
                
                // Show app
                showAppInterface();
                
                // Auto-generate workout
                setTimeout(() => {
                    document.getElementById('generateBtn').click();
                }, 500);
            } else {
                // User is signed out
                currentUser = null;
                showAuthInterface();
            }
        });

        async function initializeUserProfile(user) {
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
                // Create new user profile
                await setDoc(userRef, {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    createdAt: new Date().toISOString(),
                    friends: []
                });
            }
        }

        function showAuthInterface() {
            const appScreen = document.getElementById('appScreen');
            const authScreen = document.getElementById('authScreen');
            
            if (appScreen) appScreen.style.display = 'none';
            if (authScreen) authScreen.style.display = 'block';
        }

        function showAppInterface() {
            const appScreen = document.getElementById('appScreen');
            const authScreen = document.getElementById('authScreen');
            
            if (authScreen) authScreen.style.display = 'none';
            if (appScreen) appScreen.style.display = 'block';
            
            // Update user profile display
            const userBadge = document.getElementById('userProfileBadge');
            const displayNameSpan = document.getElementById('displayNameSpan');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userBadge) userBadge.style.display = 'block';
            if (displayNameSpan) displayNameSpan.textContent = currentUser.displayName;
            if (userAvatar) userAvatar.src = currentUser.photoURL;
        }

        // Google Sign In
        async function signInWithGoogle() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Error signing in:', error);
                alert('Error signing in. Please try again.');
            }
        }

        // Apple Sign In
        async function signInWithApple() {
            try {
                const appleProvider = new OAuthProvider('apple.com');
                await signInWithPopup(auth, appleProvider);
            } catch (error) {
                console.error('Error signing in with Apple:', error);
                alert('Error signing in with Apple. Please try again.');
            }
        }

        // Sign Out
        async function signOutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Make auth functions available globally
        window.signInWithGoogle = signInWithGoogle;
        window.signInWithApple = signInWithApple;
        window.signOutUser = signOutUser;

        // Remove old profile setup function - replaced by Firebase Auth
        function showProfileSetup() {
            // Redirect to Google Sign In
            showAuthInterface();
        }

        window.submitProfile = async function() {
            // No longer needed - using Firebase Auth
        }

        async function createProfile(username, displayName) {
            // No longer needed - using Firebase Auth  
            return true;
        }

        async function updateProfile(updates) {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.id);
            await updateDoc(userRef, updates);
        }

        // Fitness data storage functions
        // Fitness data storage with Firebase Firestore
        async function saveWorkoutCompletion(workoutData) {
            if (!currentUser) {
                console.error('No user - cannot save workout');
                return false;
            }
            
            try {
                const workoutRef = doc(db, 'workouts', `${currentUser.id}_${getTodayDateKey()}`);
                const completionData = {
                    userId: currentUser.id,
                    username: currentUser.username,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL || '',
                    date: new Date().toISOString(),
                    workoutType: workoutData.workoutType,
                    dayName: workoutData.dayName,
                    totalTime: workoutData.totalTime,
                    exercisesCompleted: workoutData.exercises.length,
                    completed: true
                };
                
                await setDoc(workoutRef, completionData);
                console.log('Workout completion saved:', completionData);
                return true;
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Error saving workout completion. Please try again.');
                return false;
            }
        }

        async function saveExercisePerformance(exerciseName, performanceData) {
            if (!currentUser) {
                console.error('No user logged in - cannot save performance');
                return;
            }
            
            try {
                const perfRef = doc(db, 'performance', `${currentUser.id}_${exerciseName}_${getTodayDateKey()}`);
                const data = {
                    ...performanceData,
                    userId: currentUser.id,
                    username: currentUser.username,
                    exerciseName: exerciseName,
                    timestamp: new Date().toISOString()
                };
                await setDoc(perfRef, data);
                console.log('Performance saved:', exerciseName, data);
            } catch (error) {
                console.error('Error saving performance:', error);
                alert('Error saving performance data. Please try again.');
            }
        }

        async function getWorkoutHistory(limitCount = 30) {
            if (!currentUser) return [];
            
            try {
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', '==', currentUser.id),
                    orderBy('date', 'desc'),
                    firestoreLimit(limitCount)
                );
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting workout history:', error);
                return [];
            }
        }

        async function getExerciseHistory(exerciseName, limitCount = 10) {
            if (!currentUser) {
                console.log('No user - skipping history load');
                return [];
            }
            
            try {
                const perfRef = collection(db, 'performance');
                const q = query(
                    perfRef,
                    where('userId', '==', currentUser.id),
                    where('exerciseName', '==', exerciseName),
                    orderBy('timestamp', 'desc'),
                    firestoreLimit(limitCount)
                );
                const querySnapshot = await getDocs(q);
                const history = querySnapshot.docs.map(doc => doc.data());
                console.log(`Loaded ${history.length} history records for ${exerciseName}`);
                return history;
            } catch (error) {
                console.error('Error getting exercise history:', error);
                return [];
            }
        }

        // Friend Management with Firebase
        async function addFriend(friendEmail) {
            if (!currentUser) return false;
            
            try {
                // Search for user by email
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', friendEmail));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    return false;
                }
                
                const friendDoc = querySnapshot.docs[0];
                const friendData = friendDoc.data();
                
                if (friendData.uid === currentUser.id) {
                    return false; // Can't add yourself
                }
                
                // Add to friends list
                const userRef = doc(db, 'users', currentUser.id);
                await updateDoc(userRef, {
                    friends: arrayUnion(friendData.uid)
                });
                
                // Update local currentUser
                if (!currentUser.friends) currentUser.friends = [];
                if (!currentUser.friends.includes(friendData.uid)) {
                    currentUser.friends.push(friendData.uid);
                }
                
                return true;
            } catch (error) {
                console.error('Error adding friend:', error);
                return false;
            }
        }

        async function getFriendsActivity(limitCount = 20) {
            if (!currentUser) return [];
            
            try {
                // Get current user's friends list
                const userRef = doc(db, 'users', currentUser.id);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                if (friends.length === 0) return [];
                
                // Get workouts from friends (Firestore 'in' limit is 10)
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', 'in', friends.slice(0, 10)),
                    orderBy('date', 'desc'),
                    firestoreLimit(limitCount)
                );
                
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error('Error getting friends activity:', error);
                return [];
            }
        }

        async function getFriendProfiles() {
            if (!currentUser) return [];
            
            try {
                const userRef = doc(db, 'users', currentUser.id);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const friends = userData.friends || [];
                
                if (friends.length === 0) return [];
                
                const profiles = [];
                for (let friendId of friends) {
                    const friendRef = doc(db, 'users', friendId);
                    const friendSnap = await getDoc(friendRef);
                    if (friendSnap.exists()) {
                        profiles.push(friendSnap.data());
                    }
                }
                return profiles;
            } catch (error) {
                console.error('Error getting friend profiles:', error);
                return [];
            }
        }

        async function getFriendStats(friendId) {
            try {
                const workoutsRef = collection(db, 'workouts');
                const q = query(
                    workoutsRef,
                    where('userId', '==', friendId),
                    orderBy('date', 'desc'),
                    firestoreLimit(30)
                );
                const querySnapshot = await getDocs(q);
                const workouts = querySnapshot.docs.map(doc => doc.data());
                
                return {
                    totalWorkouts: workouts.length,
                    totalMinutes: workouts.reduce((sum, w) => sum + (w.totalTime || 0), 0),
                    lastWorkout: workouts.length > 0 ? workouts[0].date : null
                };
            } catch (error) {
                return null;
            }
        }

        function getTodayDateKey() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        async function getStats() {
            const history = await getWorkoutHistory(90);
            console.log(`getStats: Found ${history.length} workouts in history`);
            
            const totalWorkouts = history.length;
            const last7Days = history.filter(w => {
                const workoutDate = new Date(w.date);
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                return workoutDate >= sevenDaysAgo;
            }).length;
            
            const workoutTypes = history.reduce((acc, w) => {
                acc[w.workoutType] = (acc[w.workoutType] || 0) + 1;
                return acc;
            }, {});

            const stats = {
                totalWorkouts,
                last7Days,
                workoutTypes,
                totalMinutes: history.reduce((sum, w) => sum + (w.totalTime || 0), 0)
            };
            
            console.log('Stats calculated:', stats);
            return stats;
        }

        // User preferences for workout customization
        let workoutPreferences = {
            duration: 35, // 20, 35, or 45 minutes
            difficulty: 'intermediate', // beginner, intermediate, advanced
            equipment: 'full-gym', // full-gym, dumbbells-only, minimal, bodyweight
            injuries: [], // array of injury types: knee, shoulder, back, wrist, ankle
            planType: 'single', // single, weekly, monthly
            singleWorkoutType: null, // For single day: 'hiit', 'upper-strength', 'lower-strength', 'cross-training', 'recovery'
            workoutMix: { // For weekly/monthly plans
                'hiit': 0,
                'upper-strength': 0,
                'lower-strength': 0,
                'cross-training': 0,
                'recovery': 0
            },
            currentPlan: null // Stores generated weekly/monthly plan
        };

        // Load preferences from Firestore
        async function loadPreferences() {
            if (!currentUser) return;
            
            try {
                const prefRef = doc(db, 'preferences', currentUser.id);
                const prefSnap = await getDoc(prefRef);
                if (prefSnap.exists()) {
                    const savedPrefs = prefSnap.data();
                    // Merge saved preferences with defaults to preserve structure
                    workoutPreferences = {
                        ...workoutPreferences,
                        ...savedPrefs,
                        // Ensure workoutMix exists with defaults
                        workoutMix: {
                            ...workoutPreferences.workoutMix,
                            ...(savedPrefs.workoutMix || {})
                        }
                    };
                    console.log('Preferences loaded successfully');
                }
            } catch (error) {
                console.log('No saved preferences, using defaults');
            }
        }

        // Save preferences to Firestore
        async function savePreferences() {
            if (!currentUser) return;
            
            try {
                const prefRef = doc(db, 'preferences', currentUser.id);
                await setDoc(prefRef, workoutPreferences);
            } catch (error) {
                console.error('Error saving preferences:', error);
            }
        }

        // Show preferences modal
        function showPreferencesModal() {
            const modal = document.createElement('div');
            modal.id = 'preferencesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
                overflow-y: auto;
            `;

            modal.innerHTML = `
                <div style="background: var(--slate); border-radius: 16px; padding: 2rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--energy-orange);">
                    <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--electric-yellow); margin-bottom: 2rem; text-align: center;">Customize Your Workouts</h2>
                    
                    <!-- Plan Type Selection -->
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(255, 107, 53, 0.1); border-radius: 12px; border: 2px solid var(--energy-orange);">
                        <label style="display: block; font-size: 1.1rem; font-weight: 700; color: var(--energy-orange); margin-bottom: 1rem;">üìÖ Choose Your Plan</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <button class="plan-btn" data-plan="single" style="padding: 1rem; background: ${workoutPreferences.planType === 'single' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'single' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Single Day<br><span style="font-size: 0.8rem; opacity: 0.7;">One workout</span></button>
                            <button class="plan-btn" data-plan="weekly" style="padding: 1rem; background: ${workoutPreferences.planType === 'weekly' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'weekly' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Weekly<br><span style="font-size: 0.8rem; opacity: 0.7;">7-day plan</span></button>
                            <button class="plan-btn" data-plan="monthly" style="padding: 1rem; background: ${workoutPreferences.planType === 'monthly' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.planType === 'monthly' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Monthly<br><span style="font-size: 0.8rem; opacity: 0.7;">30-day plan</span></button>
                        </div>
                        
                        <!-- Single Day Workout Type -->
                        <div id="singleDayType" style="display: ${workoutPreferences.planType === 'single' ? 'block' : 'none'};">
                            <label style="display: block; font-size: 0.95rem; font-weight: 600; color: var(--vibrant-cyan); margin-bottom: 0.75rem;">Choose today's workout:</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                                <button class="single-type-btn" data-type="hiit" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'hiit' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'hiit' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">üî• HIIT</button>
                                <button class="single-type-btn" data-type="upper-strength" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'upper-strength' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'upper-strength' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">üí™ Upper Body</button>
                                <button class="single-type-btn" data-type="lower-strength" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'lower-strength' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'lower-strength' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">ü¶µ Lower Body</button>
                                <button class="single-type-btn" data-type="cross-training" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'cross-training' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'cross-training' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">‚ö° Cross Training</button>
                                <button class="single-type-btn" data-type="recovery" style="padding: 0.75rem; background: ${workoutPreferences.singleWorkoutType === 'recovery' ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.05)'}; border: 2px solid ${workoutPreferences.singleWorkoutType === 'recovery' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem;">üßò Recovery</button>
                            </div>
                        </div>
                        
                        <!-- Weekly/Monthly Mix -->
                        <div id="planMix" style="display: ${workoutPreferences.planType !== 'single' ? 'block' : 'none'};">
                            <label style="display: block; font-size: 0.95rem; font-weight: 600; color: var(--vibrant-cyan); margin-bottom: 0.75rem;">Allocate your ${workoutPreferences.planType === 'weekly' ? '7' : '30'} days:</label>
                            <div style="background: rgba(0, 217, 255, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);">Choose how many days of each type (must total ${workoutPreferences.planType === 'weekly' ? '7' : '30'})</div>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                ${['hiit', 'upper-strength', 'lower-strength', 'cross-training', 'recovery'].map(type => {
                                    const labels = {
                                        'hiit': 'üî• HIIT',
                                        'upper-strength': 'üí™ Upper Body',
                                        'lower-strength': 'ü¶µ Lower Body',
                                        'cross-training': '‚ö° Cross Training',
                                        'recovery': 'üßò Recovery'
                                    };
                                    return `
                                        <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.05); padding: 0.5rem 1rem; border-radius: 6px;">
                                            <span style="font-size: 0.85rem;">${labels[type]}</span>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <button class="mix-decrease" data-type="${type}" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: bold;">-</button>
                                                <span id="mix-${type}" style="min-width: 25px; text-align: center; font-weight: 700; color: var(--vibrant-cyan);">${workoutPreferences.workoutMix[type]}</span>
                                                <button class="mix-increase" data-type="${type}" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div id="mix-total" style="text-align: center; margin-top: 0.75rem; font-weight: 700; color: ${Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0) === (workoutPreferences.planType === 'weekly' ? 7 : 30) ? 'var(--electric-yellow)' : '#FF6B35'};">
                                Total: ${Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0)} / ${workoutPreferences.planType === 'weekly' ? '7' : '30'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Duration -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Workout Duration</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button class="duration-btn" data-duration="20" style="padding: 1rem; background: ${workoutPreferences.duration === 20 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 20 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">20 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Quick</span></button>
                            <button class="duration-btn" data-duration="35" style="padding: 1rem; background: ${workoutPreferences.duration === 35 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 35 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">35 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Standard</span></button>
                            <button class="duration-btn" data-duration="45" style="padding: 1rem; background: ${workoutPreferences.duration === 45 ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.duration === 45 ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">45 min<br><span style="font-size: 0.8rem; opacity: 0.7;">Extended</span></button>
                        </div>
                    </div>

                    <!-- Difficulty -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Difficulty Level</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <button class="difficulty-btn" data-difficulty="beginner" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'beginner' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'beginner' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Beginner<br><span style="font-size: 0.8rem; opacity: 0.7;">Lighter weights</span></button>
                            <button class="difficulty-btn" data-difficulty="intermediate" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'intermediate' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'intermediate' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Intermediate<br><span style="font-size: 0.8rem; opacity: 0.7;">Moderate</span></button>
                            <button class="difficulty-btn" data-difficulty="advanced" style="padding: 1rem; background: ${workoutPreferences.difficulty === 'advanced' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.difficulty === 'advanced' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Advanced<br><span style="font-size: 0.8rem; opacity: 0.7;">High intensity</span></button>
                        </div>
                    </div>

                    <!-- Equipment -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Available Equipment</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <button class="equipment-btn" data-equipment="full-gym" style="padding: 1rem; background: ${workoutPreferences.equipment === 'full-gym' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'full-gym' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Full Gym<br><span style="font-size: 0.8rem; opacity: 0.7;">All equipment</span></button>
                            <button class="equipment-btn" data-equipment="dumbbells-only" style="padding: 1rem; background: ${workoutPreferences.equipment === 'dumbbells-only' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'dumbbells-only' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Dumbbells Only<br><span style="font-size: 0.8rem; opacity: 0.7;">+ bench</span></button>
                            <button class="equipment-btn" data-equipment="minimal" style="padding: 1rem; background: ${workoutPreferences.equipment === 'minimal' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'minimal' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Minimal<br><span style="font-size: 0.8rem; opacity: 0.7;">Light weights</span></button>
                            <button class="equipment-btn" data-equipment="bodyweight" style="padding: 1rem; background: ${workoutPreferences.equipment === 'bodyweight' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${workoutPreferences.equipment === 'bodyweight' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">Bodyweight<br><span style="font-size: 0.8rem; opacity: 0.7;">No equipment</span></button>
                        </div>
                    </div>

                    <!-- Injuries -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1rem;">Injury Modifications (Select all that apply)</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="knee" ${workoutPreferences.injuries.includes('knee') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Knee Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="shoulder" ${workoutPreferences.injuries.includes('shoulder') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Shoulder Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="back" ${workoutPreferences.injuries.includes('back') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Back Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="wrist" ${workoutPreferences.injuries.includes('wrist') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Wrist Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="ankle" ${workoutPreferences.injuries.includes('ankle') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Ankle Issues</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" class="injury-check" value="elbow" ${workoutPreferences.injuries.includes('elbow') ? 'checked' : ''} style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                                <span>Elbow Issues</span>
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button id="savePreferencesBtn" style="flex: 1; background: linear-gradient(135deg, var(--energy-orange), #FF8C42); color: white; border: none; padding: 1rem; font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px;">Save & Regenerate</button>
                        <button id="cancelPreferencesBtn" style="flex: 0.5; background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem; font-size: 1rem; font-weight: 600; cursor: pointer; border-radius: 8px;">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Plan type buttons
            modal.querySelectorAll('.plan-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const planType = e.target.dataset.plan;
                    workoutPreferences.planType = planType;
                    modal.querySelectorAll('.plan-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    
                    // Show/hide appropriate sections
                    const singleSection = document.getElementById('singleDayType');
                    const mixSection = document.getElementById('planMix');
                    const mixTotal = document.getElementById('mix-total');
                    
                    if (planType === 'single') {
                        singleSection.style.display = 'block';
                        mixSection.style.display = 'none';
                    } else {
                        singleSection.style.display = 'none';
                        mixSection.style.display = 'block';
                        // Update total label
                        const expected = planType === 'weekly' ? 7 : 30;
                        const current = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                        mixTotal.innerHTML = `Total: ${current} / ${expected}`;
                        mixTotal.style.color = current === expected ? 'var(--electric-yellow)' : '#FF6B35';
                    }
                });
            });
            
            // Single workout type buttons
            modal.querySelectorAll('.single-type-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    workoutPreferences.singleWorkoutType = e.target.dataset.type;
                    modal.querySelectorAll('.single-type-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.05)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--vibrant-cyan)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                });
            });
            
            // Workout mix increase/decrease buttons
            modal.querySelectorAll('.mix-increase, .mix-decrease').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    const isIncrease = e.target.classList.contains('mix-increase');
                    const expected = workoutPreferences.planType === 'weekly' ? 7 : 30;
                    const currentTotal = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                    
                    if (isIncrease && currentTotal < expected) {
                        workoutPreferences.workoutMix[type]++;
                    } else if (!isIncrease && workoutPreferences.workoutMix[type] > 0) {
                        workoutPreferences.workoutMix[type]--;
                    }
                    
                    // Update display
                    document.getElementById(`mix-${type}`).textContent = workoutPreferences.workoutMix[type];
                    const newTotal = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                    const mixTotal = document.getElementById('mix-total');
                    mixTotal.innerHTML = `Total: ${newTotal} / ${expected}`;
                    mixTotal.style.color = newTotal === expected ? 'var(--electric-yellow)' : '#FF6B35';
                });
            });

            // Add event listeners
            modal.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    modal.querySelectorAll('.duration-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.duration = parseInt(e.target.dataset.duration);
                });
            });

            modal.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    modal.querySelectorAll('.difficulty-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.difficulty = e.target.dataset.difficulty;
                });
            });

            modal.querySelectorAll('.equipment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    modal.querySelectorAll('.equipment-btn').forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    });
                    e.target.style.background = 'var(--energy-orange)';
                    e.target.style.borderColor = 'var(--electric-yellow)';
                    workoutPreferences.equipment = e.target.dataset.equipment;
                });
            });

            modal.querySelectorAll('.injury-check').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    workoutPreferences.injuries = Array.from(modal.querySelectorAll('.injury-check:checked')).map(cb => cb.value);
                });
            });

            document.getElementById('savePreferencesBtn').addEventListener('click', async () => {
                // Validate based on plan type
                if (workoutPreferences.planType === 'single') {
                    if (!workoutPreferences.singleWorkoutType) {
                        alert('Please select a workout type for today!');
                        return;
                    }
                } else {
                    // Weekly or monthly
                    const expected = workoutPreferences.planType === 'weekly' ? 7 : 30;
                    const total = Object.values(workoutPreferences.workoutMix).reduce((a,b) => a+b, 0);
                    if (total !== expected) {
                        alert(`Please allocate exactly ${expected} days. Currently: ${total}`);
                        return;
                    }
                }
                
                await savePreferences();
                modal.remove();
                document.getElementById('generateBtn').click();
            });

            document.getElementById('cancelPreferencesBtn').addEventListener('click', () => {
                modal.remove();
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        window.showPreferencesModal = showPreferencesModal;

        // Filter exercises based on preferences
        function filterExercisesByPreferences(exercises) {
            return exercises.filter(exercise => {
                // Equipment filtering
                if (workoutPreferences.equipment === 'bodyweight') {
                    // Only bodyweight exercises
                    const bodyweightKeywords = ['bodyweight', 'push-up', 'pull-up', 'plank', 'burpee', 'mountain climber', 'jump', 'squat', 'lunge'];
                    const isBodyweight = bodyweightKeywords.some(keyword => 
                        exercise.name.toLowerCase().includes(keyword) || 
                        !exercise.name.toLowerCase().includes('barbell') && 
                        !exercise.name.toLowerCase().includes('dumbbell') && 
                        !exercise.name.toLowerCase().includes('kettlebell')
                    );
                    if (!isBodyweight) return false;
                }
                
                if (workoutPreferences.equipment === 'dumbbells-only') {
                    // Replace barbell with dumbbell variants
                    if (exercise.name.toLowerCase().includes('barbell')) {
                        exercise.name = exercise.name.replace('Barbell', 'Dumbbell');
                        exercise.description = exercise.description.replace('barbell', 'dumbbell');
                    }
                    if (exercise.name.toLowerCase().includes('kettlebell') && 
                        !exercise.name.includes('Swing')) {
                        return false; // Skip kettlebell-specific moves except swings
                    }
                }
                
                if (workoutPreferences.equipment === 'minimal') {
                    // No heavy barbells or machines
                    if (exercise.name.toLowerCase().includes('barbell') || 
                        exercise.name.toLowerCase().includes('leg press') ||
                        exercise.name.toLowerCase().includes('cable')) {
                        return false;
                    }
                }
                
                // Injury modifications
                if (workoutPreferences.injuries.includes('knee')) {
                    if (exercise.name.toLowerCase().includes('jump') || 
                        exercise.name.toLowerCase().includes('squat') ||
                        exercise.name.toLowerCase().includes('lunge')) {
                        exercise.tips += ' | MODIFICATION: Reduce depth, no jumping, or substitute with leg press';
                    }
                }
                
                if (workoutPreferences.injuries.includes('shoulder')) {
                    if (exercise.name.toLowerCase().includes('overhead') || 
                        exercise.name.toLowerCase().includes('press') ||
                        exercise.name.toLowerCase().includes('shoulder')) {
                        exercise.tips += ' | MODIFICATION: Reduce range of motion or substitute with lower angle press';
                    }
                }
                
                if (workoutPreferences.injuries.includes('back')) {
                    if (exercise.name.toLowerCase().includes('deadlift') || 
                        exercise.name.toLowerCase().includes('row') ||
                        exercise.name.toLowerCase().includes('good morning')) {
                        exercise.tips += ' | MODIFICATION: Keep weight light, focus on form, or substitute with machine variant';
                    }
                }
                
                if (workoutPreferences.injuries.includes('wrist')) {
                    if (exercise.name.toLowerCase().includes('push-up') || 
                        exercise.name.toLowerCase().includes('plank') ||
                        exercise.name.toLowerCase().includes('burpee')) {
                        exercise.tips += ' | MODIFICATION: Use push-up handles or perform on knuckles';
                    }
                }
                
                return true;
            });
        }

        // Adjust workout duration based on preferences
        function adjustWorkoutDuration() {
            const baseDuration = workoutPreferences.duration;
            
            if (baseDuration === 20) {
                return { warmup: 3, main: 15, cooldown: 2 };
            } else if (baseDuration === 45) {
                return { warmup: 7, main: 35, cooldown: 3 };
            } else {
                return { warmup: 5, main: 26, cooldown: 4 }; // 35 min default
            }
        }

        // Adjust reps/sets based on difficulty
        function adjustExerciseDifficulty(exercise) {
            const ex = { ...exercise };
            
            if (workoutPreferences.difficulty === 'beginner') {
                if (ex.reps) {
                    ex.reps = ex.reps.replace(/\d+-\d+/g, (match) => {
                        const [min, max] = match.split('-').map(Number);
                        return `${Math.max(1, min - 2)}-${max - 2}`;
                    });
                    ex.reps = ex.reps.replace(/\d+ sets/g, (match) => {
                        const sets = parseInt(match);
                        return `${Math.max(2, sets - 1)} sets`;
                    });
                }
                ex.description += ' (Beginner: lighter weight, focus on form)';
            } else if (workoutPreferences.difficulty === 'advanced') {
                if (ex.reps) {
                    ex.reps = ex.reps.replace(/\d+-\d+/g, (match) => {
                        const [min, max] = match.split('-').map(Number);
                        return `${min + 2}-${max + 3}`;
                    });
                    ex.reps = ex.reps.replace(/\d+ sets/g, (match) => {
                        const sets = parseInt(match);
                        return `${sets + 1} sets`;
                    });
                }
                ex.description += ' (Advanced: heavier weight, maximum intensity)';
            }
            
            return ex;
        }

        // Weekly workout schedule - cohesive program to avoid overtraining
        const weeklySchedule = {
            0: { // Sunday
                type: 'Recovery & Stretching',
                focus: 'Full body mobility and flexibility',
                intensity: 'Low'
            },
            1: { // Monday
                type: 'HIIT',
                focus: 'Full body high intensity',
                intensity: 'High',
                muscleGroups: ['full-body']
            },
            2: { // Tuesday
                type: 'Strength',
                focus: 'Upper body push & pull',
                intensity: 'Medium-High',
                muscleGroups: ['chest', 'back', 'shoulders', 'arms']
            },
            3: { // Wednesday
                type: 'Recovery & Stretching',
                focus: 'Active recovery and deep stretching',
                intensity: 'Low'
            },
            4: { // Thursday
                type: 'Strength',
                focus: 'Lower body & core',
                intensity: 'Medium-High',
                muscleGroups: ['legs', 'glutes', 'core']
            },
            5: { // Friday
                type: 'Cross Training',
                focus: 'Functional fitness & conditioning',
                intensity: 'Medium-High',
                muscleGroups: ['full-body']
            },
            6: { // Saturday
                type: 'HIIT',
                focus: 'Metabolic conditioning',
                intensity: 'High',
                muscleGroups: ['full-body']
            }
        };
        
        const exerciseDatabase = {
            warmup: [
                { name: 'Jumping Jacks', duration: 2, description: 'Full body dynamic warm-up', tips: 'Keep a steady rhythm and land softly on your feet' , video: 'https://www.youtube.com/watch?v=iSSAk4XCsRA' },
                { name: 'Arm Circles & Shoulder Rolls', duration: 2, description: 'Dynamic shoulder mobility', tips: 'Make large circles, both forward and backward' , video: 'https://www.youtube.com/watch?v=L1rKFAZnUYM' },
                { name: 'Leg Swings', duration: 1, description: 'Hip mobility and activation', tips: 'Swing each leg forward/back and side to side' , video: 'https://www.youtube.com/watch?v=4aoFzJSrNzE' },
                { name: 'Inchworms', duration: 2, description: 'Full body mobility', tips: 'Walk hands out to plank, walk feet to hands' , video: 'https://www.youtube.com/watch?v=CJwImFNvGhg' },
                { name: 'Bodyweight Squats', duration: 2, description: 'Lower body activation', tips: 'Full range of motion, controlled tempo' }
            ],
            
            // HIIT Exercises (Monday & Saturday - Full Body)
            hiit: [
                { name: 'Dumbbell Burpee Clean and Press', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Full body explosive HIIT with dumbbells', tips: 'Burpee with dumbbells, clean to shoulders, press overhead', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=YaXPRqUwItQ' , video: 'https://www.youtube.com/watch?v=6JYPJ3T5MsY' },
                { name: 'Barbell Thrusters', duration: 3, reps: '30 sec work / 30 sec rest', description: 'High intensity squat to press', tips: 'Explosive squat, drive barbell overhead without pause', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=L219ltL15zk' },
                { name: 'Dumbbell Squat Jumps', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Weighted explosive lower body power', tips: 'Hold light dumbbells at sides, land softly, explode up', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=W5bvS2zdH-c' },
                { name: 'Kettlebell Swings (HIIT Pace)', duration: 3, reps: '40 sec work / 20 sec rest', description: 'High intensity hip power', tips: 'Explosive hip snap, maximum pace, tight core', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=YSxHifyI6s8' },
                { name: 'Dumbbell Alternating Snatches', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Single arm explosive power', tips: 'Pull dumbbell from ground to overhead, alternate arms rapidly', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=T6KbfD0eHCU' },
                { name: 'Barbell or Dumbbell Push Press', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Upper body explosive power', tips: 'Dip knees, drive weight overhead explosively', muscleGroups: ['shoulders', 'legs'] , video: 'https://www.youtube.com/watch?v=iaBVSJm78ko' },
                { name: 'Dumbbell Man Makers (Fast Pace)', duration: 4, reps: '20 sec work / 40 sec rest', description: 'Ultimate weighted HIIT movement', tips: 'Burpee + row + clean + press. Maximum intensity', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=bdT_EJu2wFU' },
                { name: 'Barbell High Pulls', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Explosive pulling power', tips: 'Pull bar to chest height, elbows high, fast tempo', muscleGroups: ['back', 'shoulders'] , video: 'https://www.youtube.com/watch?v=LfT_HyPUqGI' },
                { name: 'Dumbbell Devil Press', duration: 3, reps: '20 sec work / 40 sec rest', description: 'Advanced weighted burpee variation', tips: 'Burpee with dumbbells, swing to overhead in one motion', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=czLhvRaWPlk' },
                { name: 'Kettlebell Goblet Jump Squats', duration: 3, reps: '30 sec work / 30 sec rest', description: 'Weighted plyometric legs', tips: 'Hold kettlebell at chest, jump explosively', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=U91qsRtNtFE' },
                { name: 'Burpees (Bodyweight)', duration: 3, reps: '40 sec work / 20 sec rest', description: 'Classic HIIT bodyweight movement', tips: 'Maximum speed, full extension, chest to ground', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=JZQA08SlJnM' },
                { name: 'Mountain Climbers', duration: 3, reps: '40 sec work / 20 sec rest', description: 'High intensity core and cardio', tips: 'Drive knees fast, maintain plank position', muscleGroups: ['core', 'shoulders'] }
            ],
            
            // Upper Body Strength (Tuesday)
            strengthUpper: [
                { name: 'Barbell Bench Press', duration: 4, reps: '4 sets of 8-10 reps', description: 'Primary chest builder with barbell', tips: 'Lower bar to chest, press explosively, keep feet planted', muscleGroups: ['chest', 'triceps', 'shoulders'] , video: 'https://www.youtube.com/watch?v=nmwgirgXLYM' , video: 'https://www.youtube.com/watch?v=rT7DgCr-3pg' },
                { name: 'Dumbbell Rows', duration: 4, reps: '4 sets of 10-12 per arm', description: 'Unilateral back strength', tips: 'Support on bench, pull dumbbell to hip, squeeze shoulder blade', muscleGroups: ['back', 'biceps'] , video: 'https://www.youtube.com/watch?v=pYcpY20QaE8' },
                { name: 'Barbell Overhead Press', duration: 4, reps: '4 sets of 8 reps', description: 'Shoulder mass and strength builder', tips: 'Press bar from shoulders overhead, tight core throughout', muscleGroups: ['shoulders', 'triceps'] , video: 'https://www.youtube.com/watch?v=_RlRDWO2jfg' },
                { name: 'Dumbbell Incline Press', duration: 4, reps: '3 sets of 10-12 reps', description: 'Upper chest development', tips: 'Bench at 30-45¬∞, press dumbbells up and together', muscleGroups: ['chest', 'shoulders'] , video: 'https://www.youtube.com/watch?v=8iPEnn-ltC8' },
                { name: 'Barbell or Dumbbell Curls', duration: 3, reps: '3 sets of 12 reps', description: 'Bicep isolation and growth', tips: 'Keep elbows stationary, full range of motion, control the negative', muscleGroups: ['biceps'] , video: 'https://www.youtube.com/watch?v=ykJmrZ5v0Oo' },
                { name: 'Dumbbell Shoulder Press', duration: 4, reps: '3 sets of 10 reps', description: 'Shoulder strength and stability', tips: 'Press dumbbells overhead, palms forward or neutral grip', muscleGroups: ['shoulders'] , video: 'https://www.youtube.com/watch?v=qEwKCR5JCog' },
                { name: 'Cable or Dumbbell Tricep Extensions', duration: 3, reps: '3 sets of 12-15 reps', description: 'Tricep isolation', tips: 'Keep upper arms still, extend at elbow only', muscleGroups: ['triceps'] },
                { name: 'Pull-ups or Lat Pulldowns', duration: 4, reps: '3 sets of 8-10 reps', description: 'Vertical pulling strength', tips: 'Pull chest to bar or bar to chest, full extension at bottom', muscleGroups: ['back', 'biceps'] }
            ],
            
            // Lower Body Strength (Thursday)
            strengthLower: [
                { name: 'Barbell Back Squats', duration: 4, reps: '4 sets of 8-10 reps', description: 'King of lower body exercises', tips: 'Bar on upper back, squat to parallel or below, drive through heels', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=eGo4IYlbE5g' , video: 'https://www.youtube.com/watch?v=ultWZbUMPL8' },
                { name: 'Barbell Romanian Deadlifts', duration: 4, reps: '4 sets of 10 reps', description: 'Hamstring and glute developer', tips: 'Hip hinge, slight knee bend, lower bar to mid-shin', muscleGroups: ['hamstrings', 'glutes'] },
                { name: 'Dumbbell Walking Lunges', duration: 4, reps: '3 sets of 10 per leg', description: 'Unilateral leg strength with dumbbells', tips: 'Dumbbells at sides, long stride, knee doesn\'t pass toes', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=D7KaRcUTQeE' },
                { name: 'Leg Press Machine', duration: 4, reps: '4 sets of 12-15 reps', description: 'Quad-dominant leg builder', tips: 'Feet shoulder-width, push through full foot, controlled descent', muscleGroups: ['legs', 'glutes'] },
                { name: 'Dumbbell Bulgarian Split Squats', duration: 4, reps: '3 sets of 10 per leg', description: 'Single leg strength with dumbbells', tips: 'Back foot elevated, dumbbell in each hand, vertical torso', muscleGroups: ['legs', 'glutes'] , video: 'https://www.youtube.com/watch?v=2C-uNgKwPLE' },
                { name: 'Barbell Hip Thrusts', duration: 3, reps: '3 sets of 12-15 reps', description: 'Maximum glute activation', tips: 'Upper back on bench, barbell on hips, squeeze glutes at top', muscleGroups: ['glutes', 'hamstrings'] },
                { name: 'Weighted Plank or Ab Wheel', duration: 3, reps: '3 sets of 30-45 sec', description: 'Advanced core strength', tips: 'Add weight plate on back or use ab wheel with control', muscleGroups: ['core'] },
                { name: 'Cable or Dumbbell Woodchops', duration: 3, reps: '3 sets of 12 per side', description: 'Rotational core strength', tips: 'Rotate through torso, keep arms relatively straight', muscleGroups: ['core', 'obliques'] }
            ],
            
            // Cross Training (Friday - Full Body Functional)
            crosstraining: [
                { name: 'Barbell or Dumbbell Thrusters', duration: 4, reps: '12-15 reps', description: 'Full body compound movement', tips: 'Squat with weight, drive up and press overhead in one motion', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=pAplQXk3dkU' },
                { name: 'Kettlebell Swings', duration: 3, reps: '15-20 swings', description: 'Power endurance with kettlebell', tips: 'Hip hinge, explosive hip drive, kettlebell to shoulder height', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=YSxHifyI6s8' },
                { name: 'Dumbbell Man Makers', duration: 4, reps: '8-10 reps', description: 'Ultimate full body movement', tips: 'Burpee + renegade row + squat clean + press. Total body burner', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=bdT_EJu2wFU' },
                { name: 'Barbell Clean and Press', duration: 4, reps: '8-10 reps', description: 'Olympic lift variation for power', tips: 'Clean bar to shoulders, then press overhead. Explosive movement', muscleGroups: ['full-body'] },
                { name: 'Dumbbell Snatches', duration: 3, reps: '10 per arm', description: 'Single arm power movement', tips: 'Explosively pull dumbbell from ground to overhead in one motion', muscleGroups: ['full-body'] },
                { name: 'Sandbag or Dumbbell Carries', duration: 3, reps: '40-50 meters', description: 'Loaded carry for total body strength', tips: 'Farmer carry, overhead carry, or bear hug carry', muscleGroups: ['full-body'] },
                { name: 'Medicine Ball Slams', duration: 3, reps: '15 reps', description: 'Full body explosive power', tips: 'Reach high with med ball, slam down hard, athletic stance', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=l30OxyJKwFI' },
                { name: 'Kettlebell Turkish Get-Ups', duration: 4, reps: '5 per side', description: 'Total body strength and coordination', tips: 'Move slowly, keep kettlebell overhead, control each position', muscleGroups: ['full-body'] },
                { name: 'Barbell Complexes', duration: 4, reps: '6-8 reps each movement', description: 'Multiple exercises without putting bar down', tips: 'Example: deadlift, row, clean, press, squat - all in sequence', muscleGroups: ['full-body'] , video: 'https://www.youtube.com/watch?v=CQm_8Baxz2c' },
                { name: 'Dumbbell Box Step-Ups', duration: 3, reps: '12 per leg', description: 'Weighted single leg power', tips: 'Hold dumbbells, step up explosively, drive through heel', muscleGroups: ['legs', 'glutes'] }
            ],
            
            // Recovery & Stretching (Wednesday & Sunday)
            stretching: [
                { name: 'Deep Breathing & Meditation', duration: 3, description: 'Mental recovery and breath work', tips: 'Focus on slow, deep breaths. Clear your mind' },
                { name: 'Cat-Cow Stretch', duration: 2, description: 'Spinal mobility and flexibility', tips: 'Move slowly between arched and rounded back positions' , video: 'https://www.youtube.com/watch?v=kqnua4rHVVA' },
                { name: 'World\'s Greatest Stretch', duration: 3, description: 'Full body dynamic mobility', tips: 'Lunge position with rotation, hold and breathe deeply' },
                { name: 'Pigeon Pose', duration: 3, description: 'Deep hip opener', tips: 'Hold each side for 90 seconds, breathe through discomfort' , video: 'https://www.youtube.com/watch?v=0_zTKaEHeu8' },
                { name: 'Seated Forward Fold', duration: 2, description: 'Hamstring and lower back stretch', tips: 'Reach for toes, keep back straight, hold the stretch' },
                { name: 'Thread the Needle', duration: 2, description: 'Shoulder and upper back mobility', tips: 'Thread arm under body, feel stretch in shoulder' },
                { name: 'Couch Stretch', duration: 3, description: 'Hip flexor deep stretch', tips: 'Back knee against wall, drive hips forward gently' , video: 'https://www.youtube.com/watch?v=vLYuV3RQ0_E' },
                { name: 'Chest Opener on Foam Roller', duration: 2, description: 'Thoracic spine and chest stretch', tips: 'Lie on roller, arms out wide, breathe deeply' },
                { name: 'Frog Stretch', duration: 3, description: 'Inner thigh and hip mobility', tips: 'Knees wide, slowly sink hips back, hold position' , video: 'https://www.youtube.com/watch?v=Hs4slWVvGkk' },
                { name: 'Supine Twist', duration: 2, description: 'Spinal rotation and release', tips: 'Knees fall to one side, shoulders flat, hold each side' , video: 'https://www.youtube.com/watch?v=Gj4NChDr1GA' },
                { name: 'Standing Quad Stretch', duration: 2, description: 'Front of leg flexibility', tips: 'Pull heel to glutes, hold for 60 seconds each leg' , video: 'https://www.youtube.com/watch?v=k_Jd7V9tjjo' },
                { name: 'Downward Dog', duration: 2, description: 'Full body stretch and recovery', tips: 'Press heels toward ground, straighten legs gradually' , video: 'https://www.youtube.com/watch?v=h0-gDoGRMcw' },
                { name: 'Child\'s Pose', duration: 3, description: 'Restorative full body relaxation', tips: 'Sink hips to heels, reach arms forward, breathe deeply' },
                { name: 'Shoulder Rolls & Neck Stretches', duration: 2, description: 'Upper body tension release', tips: 'Gentle circles, hold neck stretches for 30 seconds' }
            ],
            
            cooldown: [
                { name: 'Walk and Breathe', duration: 2, description: 'Active recovery to lower heart rate', tips: 'Deep breaths, slow pace, let heart rate come down' , video: 'https://www.youtube.com/watch?v=L1rKFAZnUYM' , video: 'https://www.youtube.com/watch?v=Jyy0ra2WcQQ' },
                { name: 'Standing Quad Stretch', duration: 1, description: 'Front of leg flexibility', tips: 'Hold ankle, pull heel to glutes, keep knees together' , video: 'https://www.youtube.com/watch?v=k_Jd7V9tjjo' },
                { name: 'Hamstring Stretch', duration: 1, description: 'Posterior chain flexibility', tips: 'Reach toward toes, keep back straight' , video: 'https://www.youtube.com/watch?v=D1XvVxHhwAo' },
                { name: 'Hip Flexor Stretch', duration: 1, description: 'Hip mobility and flexibility', tips: 'Lunge position, drive hips forward gently' , video: 'https://www.youtube.com/watch?v=aIVn7x96o9k' },
                { name: 'Shoulder & Chest Stretch', duration: 1, description: 'Upper body flexibility', tips: 'Hands behind back, open chest, pull shoulders back' , video: 'https://www.youtube.com/watch?v=bjYH9BLt9yw' },
                { name: 'Child\'s Pose', duration: 2, description: 'Full body relaxation stretch', tips: 'Sink hips to heels, reach arms forward, breathe deeply' },
                { name: 'Spinal Twist', duration: 1, description: 'Back and core mobility', tips: 'Seated or lying, gentle twist to each side' }
            ]
        };

        // Seeded random number generator for consistent daily workouts
        function seededRandom(seed) {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        function getDailySeed() {
            const today = new Date();
            return today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
        }

        function shuffleArray(array, seed) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function generateWorkout() {
            const seed = getDailySeed();
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Get today's scheduled workout
            const todaySchedule = weeklySchedule[dayOfWeek];
            const workoutType = todaySchedule.type;
            
            // Get adjusted durations
            const durations = adjustWorkoutDuration();
            
            let workout = [];
            let totalTime = 0;

            // Stretching days (Wednesday & Sunday) - different structure
            if (workoutType === 'Recovery & Stretching') {
                // Light warmup
                const lightWarmup = [
                    { name: 'Gentle Walking', duration: 2, description: 'Easy pace to warm up', tips: 'Start slow, gradually increase pace slightly', category: 'Warm-up' , video: 'https://www.youtube.com/watch?v=RpFU-Z7AjP4' },
                    { name: 'Arm Swings', duration: 1, description: 'Dynamic shoulder mobility', tips: 'Gentle swinging motions, loosen shoulders', category: 'Warm-up' }
                ];
                lightWarmup.forEach(ex => {
                    workout.push(ex);
                    totalTime += ex.duration;
                });

                // Main stretching session
                const stretchingExercises = shuffleArray(exerciseDatabase.stretching, seed);
                let stretchTime = 0;
                const stretchDuration = durations.main;
                stretchingExercises.forEach(exercise => {
                    if (stretchTime < stretchDuration) {
                        workout.push({ ...exercise, category: 'Recovery Stretch' });
                        totalTime += exercise.duration;
                        stretchTime += exercise.duration;
                    }
                });

                // Relaxation cooldown
                workout.push({
                    name: 'Savasana / Final Relaxation',
                    duration: durations.cooldown,
                    description: 'Complete body relaxation',
                    tips: 'Lie flat, close eyes, focus on breathing and letting go of tension',
                    category: 'Cool-down'
                });
                totalTime += durations.cooldown;

                return {
                    exercises: workout,
                    totalTime,
                    workoutType,
                    workoutFocus: todaySchedule.focus,
                    dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                    weekInfo: getWeekInfo(dayOfWeek)
                };
            }

            // Regular workout days - Warmup
            const warmupExercises = shuffleArray(exerciseDatabase.warmup, seed);
            let warmupTime = 0;
            warmupExercises.forEach(exercise => {
                if (warmupTime < durations.warmup) {
                    workout.push({ ...exercise, category: 'Warm-up' });
                    totalTime += exercise.duration;
                    warmupTime += exercise.duration;
                }
            });

            // Main workout - based on day of week
            let mainWorkout = [];
            let mainTime = 0;
            
            if (workoutType === 'HIIT') {
                // Monday & Saturday - HIIT Full Body
                let hiitExercises = shuffleArray(exerciseDatabase.hiit, seed + 1);
                hiitExercises = filterExercisesByPreferences(hiitExercises);
                const numExercises = durations.main <= 15 ? 4 : durations.main >= 35 ? 8 : 6;
                const selectedExercises = hiitExercises.slice(0, numExercises);
                
                // Do rounds based on duration
                const rounds = durations.main <= 15 ? 3 : 4;
                for (let round = 1; round <= rounds; round++) {
                    selectedExercises.forEach((exercise) => {
                        if (mainTime < durations.main) {
                            const adjustedExercise = adjustExerciseDifficulty(exercise);
                            mainWorkout.push({ 
                                ...adjustedExercise, 
                                category: `HIIT - Round ${round}`,
                                roundInfo: `Round ${round} of ${rounds}`
                            });
                            mainTime += adjustedExercise.duration;
                        }
                    });
                }
            } else if (workoutType === 'Strength' && dayOfWeek === 2) {
                // Tuesday - Upper Body Strength
                let upperExercises = shuffleArray(exerciseDatabase.strengthUpper, seed + 2);
                upperExercises = filterExercisesByPreferences(upperExercises);
                upperExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Upper Body Strength' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            } else if (workoutType === 'Strength' && dayOfWeek === 4) {
                // Thursday - Lower Body & Core Strength
                let lowerExercises = shuffleArray(exerciseDatabase.strengthLower, seed + 3);
                lowerExercises = filterExercisesByPreferences(lowerExercises);
                lowerExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Lower Body & Core' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            } else if (workoutType === 'Cross Training') {
                // Friday - Cross Training
                let crossExercises = shuffleArray(exerciseDatabase.crosstraining, seed + 4);
                crossExercises = filterExercisesByPreferences(crossExercises);
                crossExercises.forEach(exercise => {
                    if (mainTime < durations.main) {
                        const adjustedExercise = adjustExerciseDifficulty(exercise);
                        mainWorkout.push({ ...adjustedExercise, category: 'Cross Training' });
                        mainTime += adjustedExercise.duration;
                    }
                });
            }

            workout = workout.concat(mainWorkout);
            totalTime += mainTime;

            // Cooldown
            const cooldownExercises = shuffleArray(exerciseDatabase.cooldown, seed + 5);
            let cooldownTime = 0;
            cooldownExercises.forEach(exercise => {
                if (cooldownTime < durations.cooldown) {
                    workout.push({ ...exercise, category: 'Cool-down' });
                    totalTime += exercise.duration;
                    cooldownTime += exercise.duration;
                }
            });

            return { 
                exercises: workout, 
                totalTime,
                workoutType,
                workoutFocus: todaySchedule.focus,
                dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                weekInfo: getWeekInfo(dayOfWeek)
            };
        }

        function getWeekInfo(currentDay) {
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return daysOfWeek.map((day, index) => ({
                day,
                type: weeklySchedule[index].type,
                isCurrent: index === currentDay,
                focus: weeklySchedule[index].focus
            }));
        }

        function displayWorkout(workout) {
            const container = document.getElementById('workoutContainer');
            
            // Get workout type badge color
            const typeColors = {
                'HIIT': 'var(--energy-orange)',
                'Strength': 'var(--vibrant-cyan)',
                'Cross Training': 'var(--electric-yellow)',
                'Recovery & Stretching': '#9B59B6'
            };

            // Create weekly schedule display
            const weekScheduleHtml = `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.08em; margin-bottom: 1rem; color: var(--electric-yellow);">Weekly Training Schedule</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem;">
                        ${workout.weekInfo.map(dayInfo => `
                            <div style="
                                background: ${dayInfo.isCurrent ? 'linear-gradient(135deg, var(--energy-orange), #FF8C42)' : 'rgba(255, 255, 255, 0.03)'};
                                padding: 0.75rem 0.5rem;
                                border-radius: 8px;
                                text-align: center;
                                border: ${dayInfo.isCurrent ? '2px solid var(--electric-yellow)' : '1px solid rgba(255, 255, 255, 0.1)'};
                                ${dayInfo.isCurrent ? 'box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);' : ''}
                            ">
                                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.3rem; ${dayInfo.isCurrent ? 'color: white;' : 'color: rgba(255, 255, 255, 0.9);'}">${dayInfo.day}</div>
                                <div style="font-size: 0.65rem; ${dayInfo.isCurrent ? 'color: rgba(255, 255, 255, 0.95);' : 'color: rgba(255, 255, 255, 0.5);'} text-transform: uppercase; letter-spacing: 0.05em;">
                                    ${dayInfo.type === 'Recovery & Stretching' ? 'üßò Recovery' : 
                                      dayInfo.type === 'HIIT' ? 'üî• HIIT' : 
                                      dayInfo.type === 'Strength' ? 'üí™ Strength' : 
                                      '‚ö° Cross'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            let html = `
                ${weekScheduleHtml}
                <div class="workout-summary">
                    <div style="display: inline-block; background: ${typeColors[workout.workoutType]}; color: var(--deep-charcoal); padding: 0.5rem 1.5rem; border-radius: 50px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem;">
                        ${workout.dayName} - ${workout.workoutType}
                    </div>
                    <h2>${workout.workoutFocus}</h2>
                    
                    <!-- Preferences Display -->
                    <div style="background: rgba(156, 39, 176, 0.15); padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid rgba(156, 39, 176, 0.3);">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">‚öôÔ∏è</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px;">${workoutPreferences.duration} min</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; text-transform: capitalize;">${workoutPreferences.difficulty}</span>
                            <span style="font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; text-transform: capitalize;">${workoutPreferences.equipment.replace('-', ' ')}</span>
                            ${workoutPreferences.injuries.length > 0 ? `<span style="font-size: 0.85rem; background: rgba(255, 107, 53, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px;">‚ö†Ô∏è ${workoutPreferences.injuries.length} modification${workoutPreferences.injuries.length > 1 ? 's' : ''}</span>` : ''}
                            <button onclick="showPreferencesModal()" style="margin-left: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 0.4rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.85rem;">Change</button>
                        </div>
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Time</div>
                            <div class="summary-value">${workout.totalTime} MIN</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Exercises</div>
                            <div class="summary-value">${workout.exercises.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Focus</div>
                            <div class="summary-value" style="font-size: 1.1rem; text-transform: uppercase;">
                                ${workout.workoutType === 'Recovery & Stretching' ? 'Recovery' : workout.workoutType}
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Intensity</div>
                            <div class="summary-value" style="font-size: 1.5rem;">
                                ${workout.workoutType === 'HIIT' ? 'üî•üî•üî•' : 
                                  workout.workoutType === 'Strength' ? 'üí™üí™' : 
                                  workout.workoutType === 'Cross Training' ? '‚ö°‚ö°‚ö°' : 
                                  'üßò‚Äç‚ôÄÔ∏è'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Detect if workout has repetitive rounds
            const hasRounds = workout.exercises.some(ex => ex.roundInfo);
            let exercisesToDisplay = workout.exercises;
            let totalRounds = 1;
            
            if (hasRounds) {
                // Check if rounds are repetitive (same exercises in each round)
                const roundMatch = workout.exercises[0]?.roundInfo?.match(/Round (\d+) of (\d+)/);
                if (roundMatch) {
                    totalRounds = parseInt(roundMatch[2]);
                    
                    // Get exercises from first round only
                    const firstRoundExercises = [];
                    for (let ex of workout.exercises) {
                        if (ex.roundInfo && ex.roundInfo.includes('Round 1')) {
                            firstRoundExercises.push(ex);
                        } else if (ex.roundInfo && !ex.roundInfo.includes('Round 1')) {
                            break; // Stop when we hit round 2
                        }
                    }
                    
                    // Check if pattern repeats
                    const exercisesPerRound = firstRoundExercises.length;
                    let isRepetitive = true;
                    
                    if (exercisesPerRound > 0 && workout.exercises.length === exercisesPerRound * totalRounds) {
                        // Compare exercises across rounds
                        for (let i = 0; i < exercisesPerRound; i++) {
                            const firstExercise = workout.exercises[i];
                            for (let round = 1; round < totalRounds; round++) {
                                const compareExercise = workout.exercises[i + (round * exercisesPerRound)];
                                if (firstExercise.name !== compareExercise.name || 
                                    firstExercise.duration !== compareExercise.duration) {
                                    isRepetitive = false;
                                    break;
                                }
                            }
                            if (!isRepetitive) break;
                        }
                        
                        if (isRepetitive) {
                            // Use only first round exercises
                            exercisesToDisplay = firstRoundExercises;
                            
                            // Add big "REPEAT" banner at top
                            html += `
                                <div style="
                                    background: linear-gradient(135deg, rgba(255, 107, 53, 0.3), rgba(247, 201, 72, 0.3));
                                    padding: 1.5rem 2rem;
                                    border-radius: 12px;
                                    margin: 1.5rem 0;
                                    border: 3px solid var(--energy-orange);
                                    text-align: center;
                                    position: relative;
                                    overflow: hidden;
                                ">
                                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(
                                        45deg,
                                        transparent,
                                        transparent 10px,
                                        rgba(255, 255, 255, 0.03) 10px,
                                        rgba(255, 255, 255, 0.03) 20px
                                    ); pointer-events: none;"></div>
                                    <div style="position: relative; z-index: 1;">
                                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--electric-yellow); font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                                            üîÅ REPEAT ${totalRounds}X üîÅ
                                        </div>
                                        <div style="font-size: 1rem; color: rgba(255, 255, 255, 0.8); margin-top: 0.5rem; font-weight: 600;">
                                            Complete the circuit below ${totalRounds} times total
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            }

            exercisesToDisplay.forEach((exercise, index) => {
                const repsInfo = exercise.reps ? `
                    <div style="background: rgba(247, 201, 72, 0.15); padding: 0.75rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(247, 201, 72, 0.3);">
                        <div style="font-weight: 700; color: var(--electric-yellow); margin-bottom: 0.3rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em;">Target</div>
                        <div style="color: rgba(255, 255, 255, 0.9);">${exercise.reps}</div>
                    </div>
                ` : '';

                // Performance tracking for non-stretching exercises
                const performanceTracking = exercise.category !== 'Recovery Stretch' && exercise.category !== 'Warm-up' && exercise.category !== 'Cool-down' ? `
                    <div style="background: rgba(0, 217, 255, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(0, 217, 255, 0.3);">
                        <div style="font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 0.75rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em;">üìà Track Performance</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Reps/Time</label>
                                <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="reps" placeholder="e.g., 15" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Weight/Level</label>
                                <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="weight" placeholder="e.g., 20lbs" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <label style="display: block; font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.3rem;">Notes</label>
                            <input type="text" class="perf-input" data-exercise="${exercise.name}" data-field="notes" placeholder="How did it feel?" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: white; font-size: 0.9rem;">
                        </div>
                        <button onclick="savePerformance('${exercise.name}')" style="margin-top: 0.75rem; background: var(--vibrant-cyan); color: var(--deep-charcoal); border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 700; font-size: 0.85rem; cursor: pointer; width: 100%; text-transform: uppercase; letter-spacing: 0.05em;">Save</button>
                        <div id="history-${exercise.name.replace(/\s+/g, '-')}" style="margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);"></div>
                    </div>
                ` : '';

                html += `
                    <div class="exercise-block" style="animation-delay: ${index * 0.05}s">
                        <div class="exercise-header">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--electric-yellow); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">
                                    ${exercise.category}
                                </div>
                                <div class="exercise-name">${exercise.name}</div>
                            </div>
                            <div class="exercise-duration">${exercise.duration} MIN</div>
                        </div>
                        <div class="exercise-description">${exercise.description}</div>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(exercise.name + ' proper form video')}" target="_blank" style="
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                            background: linear-gradient(135deg, #4285F4, #34A853);
                            color: white;
                            padding: 0.6rem 1.2rem;
                            border-radius: 8px;
                            text-decoration: none;
                            font-weight: 600;
                            font-size: 0.85rem;
                            margin: 1rem 0;
                            transition: all 0.3s;
                            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(66, 133, 244, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(66, 133, 244, 0.3)'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                            Search Form Video
                        </a>
                        ${repsInfo}
                        <div class="exercise-tips">
                            <div class="tips-title">üí° Pro Tip</div>
                            <div>${exercise.tips}</div>
                        </div>
                        ${performanceTracking}
                        <div class="timer-bar"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.classList.remove('hidden');
            container.style.opacity = '0';
            
            setTimeout(() => {
                container.style.animation = 'fadeInUp 0.8s ease-out forwards';
                
                // Add complete workout button
                const completeBtn = document.createElement('div');
                completeBtn.style.cssText = 'text-align: center; margin-top: 2rem;';
                completeBtn.innerHTML = `
                    <button onclick="markWorkoutComplete()" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 1.25rem 3rem; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4); font-family: 'Archivo', sans-serif;">
                        <span style="position: relative; z-index: 1;">‚úì Mark Workout Complete</span>
                    </button>
                `;
                container.appendChild(completeBtn);
            }, 100);
        }

        // Save exercise performance
        window.savePerformance = async function(exerciseName) {
            const inputs = document.querySelectorAll(`[data-exercise="${exerciseName}"]`);
            const perfData = {
                date: new Date().toISOString(),
                reps: '',
                weight: '',
                notes: ''
            };
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                perfData[field] = input.value;
            });
            
            if (perfData.reps || perfData.weight || perfData.notes) {
                await saveExercisePerformance(exerciseName, perfData);
                
                // Show confirmation
                const historyDiv = document.getElementById(`history-${exerciseName.replace(/\s+/g, '-')}`);
                if (historyDiv) {
                    historyDiv.innerHTML = '‚úì Saved! Keep crushing it!';
                    historyDiv.style.color = 'var(--electric-yellow)';
                    setTimeout(() => {
                        loadExerciseHistory(exerciseName);
                    }, 1500);
                }
            }
        }

        // Load exercise history
        async function loadExerciseHistory(exerciseName) {
            const history = await getExerciseHistory(exerciseName, 3);
            const historyDiv = document.getElementById(`history-${exerciseName.replace(/\s+/g, '-')}`);
            if (historyDiv && history.length > 0) {
                const lastEntry = history[0];
                historyDiv.innerHTML = `Last: ${lastEntry.reps || 'N/A'} ${lastEntry.weight ? `@ ${lastEntry.weight}` : ''}`;
                historyDiv.style.color = 'rgba(255, 255, 255, 0.6)';
            }
        }

        // Mark workout complete
        window.markWorkoutComplete = async function() {
            const workoutData = currentWorkout;
            const saved = await saveWorkoutCompletion(workoutData);
            
            if (saved) {
                alert('üéâ Awesome work! Workout marked as complete. Keep building that streak!');
                // Refresh stats if visible
                const statsContainer = document.getElementById('statsContainer');
                if (!statsContainer.classList.contains('hidden')) {
                    displayStats();
                }
            }
        }

        // Display stats and history
        async function displayStats() {
            const container = document.getElementById('statsContainer');
            const stats = await getStats();
            const history = await getWorkoutHistory(30);

            const workoutTypeBreakdown = Object.entries(stats.workoutTypes)
                .map(([type, count]) => `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--vibrant-cyan);">${count}</div>
                        <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.3rem;">${type}</div>
                    </div>
                `).join('');

            const recentWorkouts = history.slice(0, 10).map(w => {
                const date = new Date(w.date);
                const typeEmoji = w.workoutType === 'HIIT' ? 'üî•' : 
                                 w.workoutType === 'Strength' ? 'üí™' : 
                                 w.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
                return `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--energy-orange); margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--pure-white);">${typeEmoji} ${w.workoutType}</div>
                                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-top: 0.2rem;">${w.dayName} - ${w.totalTime} minutes</div>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--electric-yellow);">
                                ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            let html = `
                <div style="animation: fadeInUp 0.8s ease-out;">
                    <div class="workout-summary">
                        <h2>Your Progress & Stats</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Total Workouts</div>
                                <div class="summary-value">${stats.totalWorkouts}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Last 7 Days</div>
                                <div class="summary-value">${stats.last7Days}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Total Minutes</div>
                                <div class="summary-value">${stats.totalMinutes}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Current Streak</div>
                                <div class="summary-value" style="color: var(--electric-yellow);">üî• ${calculateStreak(history)}</div>
                            </div>
                        </div>
                    </div>

                    ${stats.totalWorkouts > 0 ? `
                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Workout Type Breakdown</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                ${workoutTypeBreakdown}
                            </div>
                        </div>

                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Recent Workouts</h3>
                            ${recentWorkouts}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                            <p style="font-size: 1.2rem; margin-bottom: 1rem;">No workouts recorded yet!</p>
                            <p>Complete your first workout to start tracking your progress.</p>
                        </div>
                    `}

                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="hideStats()" style="background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; font-family: 'Archivo', sans-serif;">
                            Back to Workout
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // Hide workout and social containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
        }

        function calculateStreak(history) {
            if (history.length === 0) return 0;
            
            let streak = 0;
            const sortedHistory = history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let i = 0; i < sortedHistory.length; i++) {
                const workoutDate = new Date(sortedHistory[i].date);
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                
                // Check if workout is from expected date (or within same day)
                if (workoutDate.toDateString() === expectedDate.toDateString()) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        window.hideStats = function() {
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        // Leaderboard Functions
        async function getLeaderboardData(period = 'all-time') {
            try {
                const workoutsRef = collection(db, 'workouts');
                let q;
                
                if (period === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    q = query(
                        workoutsRef,
                        where('date', '>=', weekAgo.toISOString()),
                        orderBy('date', 'desc')
                    );
                } else if (period === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setDate(monthAgo.getDate() - 30);
                    q = query(
                        workoutsRef,
                        where('date', '>=', monthAgo.toISOString()),
                        orderBy('date', 'desc')
                    );
                } else {
                    // All time
                    q = query(workoutsRef, orderBy('date', 'desc'));
                }
                
                const querySnapshot = await getDocs(q);
                const workouts = querySnapshot.docs.map(doc => doc.data());
                
                // Aggregate by user
                const userStats = {};
                workouts.forEach(workout => {
                    if (!userStats[workout.userId]) {
                        userStats[workout.userId] = {
                            userId: workout.userId,
                            displayName: workout.displayName || workout.username || 'Anonymous Camper',
                            photoURL: workout.photoURL || '',
                            totalWorkouts: 0,
                            totalMinutes: 0,
                            workoutTypes: {}
                        };
                    }
                    
                    userStats[workout.userId].totalWorkouts++;
                    userStats[workout.userId].totalMinutes += workout.totalTime || 0;
                    
                    const type = workout.workoutType || 'Other';
                    userStats[workout.userId].workoutTypes[type] = 
                        (userStats[workout.userId].workoutTypes[type] || 0) + 1;
                });
                
                // Convert to array and sort by total workouts
                const leaderboard = Object.values(userStats)
                    .sort((a, b) => b.totalWorkouts - a.totalWorkouts)
                    .slice(0, 50); // Top 50
                
                console.log(`Leaderboard (${period}):`, leaderboard);
                return leaderboard;
            } catch (error) {
                console.error('Error getting leaderboard:', error);
                return [];
            }
        }

        async function displayLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            
            // Hide other containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            container.classList.remove('hidden');
            
            // Default to all-time leaderboard
            let currentPeriod = 'all-time';
            
            async function renderLeaderboard(period) {
                currentPeriod = period;
                const leaderboard = await getLeaderboardData(period);
                
                // Find current user's rank
                const currentUserRank = leaderboard.findIndex(u => u.userId === currentUser.id) + 1;
                
                const periodLabels = {
                    'week': 'This Week',
                    'month': 'This Month',
                    'all-time': 'All Time'
                };
                
                let html = `
                    <div style="animation: fadeInUp 0.8s ease-out;">
                        <div class="workout-summary">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                                <h2 style="margin: 0;">üèÜ Camp Hope Leaderboard</h2>
                                <button onclick="hideLeaderboard()" style="background: rgba(255, 255, 255, 0.1); border: 2px solid var(--energy-orange); color: white; padding: 0.5rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ‚Üê Back to Workout
                                </button>
                            </div>
                            
                            <!-- Period Selector -->
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; justify-content: center; flex-wrap: wrap;">
                                <button class="period-btn" data-period="week" style="padding: 0.75rem 1.5rem; background: ${period === 'week' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${period === 'week' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    üìÖ This Week
                                </button>
                                <button class="period-btn" data-period="month" style="padding: 0.75rem 1.5rem; background: ${period === 'month' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${period === 'month' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    üìÜ This Month
                                </button>
                                <button class="period-btn" data-period="all-time" style="padding: 0.75rem 1.5rem; background: ${period === 'all-time' ? 'var(--energy-orange)' : 'rgba(255, 255, 255, 0.1)'}; border: 2px solid ${period === 'all-time' ? 'var(--electric-yellow)' : 'rgba(255, 255, 255, 0.2)'}; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    üèÖ All Time
                                </button>
                            </div>
                            
                            ${currentUserRank > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(247, 201, 72, 0.2)); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid var(--energy-orange);">
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--electric-yellow); margin-bottom: 0.5rem;">
                                        Your Rank: #${currentUserRank} üéØ
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
                                        ${leaderboard[currentUserRank - 1].totalWorkouts} workouts ‚Ä¢ ${leaderboard[currentUserRank - 1].totalMinutes} minutes
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--vibrant-cyan); margin-bottom: 1.5rem; text-align: center;">
                                ${periodLabels[period]} Rankings
                            </div>
                `;
                
                if (leaderboard.length === 0) {
                    html += `
                        <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üèïÔ∏è</div>
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No campers on the board yet!</div>
                            <div style="font-size: 0.9rem;">Be the first to complete a workout and claim the top spot!</div>
                        </div>
                    `;
                } else {
                    leaderboard.forEach((user, index) => {
                        const rank = index + 1;
                        const isCurrentUser = user.userId === currentUser.id;
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                        
                        // Get most common workout type
                        const topType = Object.entries(user.workoutTypes)
                            .sort((a, b) => b[1] - a[1])[0];
                        const typeEmoji = topType ? (
                            topType[0].includes('HIIT') ? 'üî•' :
                            topType[0].includes('Strength') ? 'üí™' :
                            topType[0].includes('Cross') ? '‚ö°' : 'üßò'
                        ) : 'üí™';
                        
                        html += `
                            <div style="
                                background: ${isCurrentUser ? 'linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(0, 184, 212, 0.2))' : 'rgba(255, 255, 255, 0.05)'};
                                padding: 1.25rem;
                                border-radius: 12px;
                                margin-bottom: 1rem;
                                border: 2px solid ${isCurrentUser ? 'var(--vibrant-cyan)' : 'rgba(255, 255, 255, 0.1)'};
                                transition: all 0.3s;
                            " onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform=''">
                                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                    <div style="
                                        font-size: 1.5rem;
                                        font-weight: 700;
                                        min-width: 50px;
                                        text-align: center;
                                        color: ${rank <= 3 ? 'var(--electric-yellow)' : 'var(--vibrant-cyan)'};
                                    ">
                                        ${medal}
                                    </div>
                                    ${user.photoURL ? `
                                        <img src="${user.photoURL}" alt="${user.displayName}" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid ${isCurrentUser ? 'var(--vibrant-cyan)' : 'var(--energy-orange)'};">
                                    ` : `
                                        <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--energy-orange); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.5rem;">
                                            ${user.displayName.charAt(0).toUpperCase()}
                                        </div>
                                    `}
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 700; font-size: 1.1rem; color: ${isCurrentUser ? 'var(--vibrant-cyan)' : 'var(--pure-white)'};">
                                            ${user.displayName} ${isCurrentUser ? '(You!)' : ''}
                                        </div>
                                        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                                <span style="color: var(--electric-yellow); font-weight: 600;">${user.totalWorkouts}</span> workouts
                                            </div>
                                            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                                <span style="color: var(--energy-orange); font-weight: 600;">${user.totalMinutes}</span> minutes
                                            </div>
                                            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                                ${typeEmoji} ${topType ? topType[0] : 'Mixed'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Add period button event listeners
                container.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        renderLeaderboard(btn.dataset.period);
                    });
                });
            }
            
            // Initial render
            renderLeaderboard(currentPeriod);
        }

        window.hideLeaderboard = function() {
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        // Social Feed Functions
        async function displaySocialFeed() {
            const container = document.getElementById('socialContainer');
            const friends = await getFriendProfiles();
            const activity = await getFriendsActivity(20);

            let html = `
                <div style="animation: fadeInUp 0.8s ease-out;">
                    <div class="workout-summary">
                        <h2>Friends & Community</h2>
                        <div style="margin-top: 1.5rem;">
                            <label style="display: block; font-size: 0.9rem; color: var(--electric-yellow); margin-bottom: 0.5rem; font-weight: 600;">Add Friend by Email</label>
                            <div style="display: flex; gap: 0.75rem;">
                                <input type="email" id="friendUsernameInput" placeholder="Enter their Google email" style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1rem;">
                                <button onclick="addFriendHandler()" style="background: var(--energy-orange); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer; white-space: nowrap;">Add Friend</button>
                            </div>
                        </div>
                    </div>

                    ${friends.length > 0 ? `
                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Your Friends (${friends.length})</h3>
                            <div style="display: grid; gap: 1rem;">
                                ${await Promise.all(friends.map(async friend => {
                                    const stats = await getFriendStats(friend.id);
                                    return `
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                                                <div>
                                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--pure-white); margin-bottom: 0.3rem;">
                                                        ${friend.displayName}
                                                    </div>
                                                    <div style="color: var(--vibrant-cyan); font-size: 0.9rem;">${friend.email}</div>
                                                </div>
                                                ${stats ? `
                                                    <div style="text-align: right;">
                                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--electric-yellow);">${stats.totalWorkouts}</div>
                                                        <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">workouts</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${stats ? `
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                                    <div>
                                                        <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.2rem;">Total Minutes</div>
                                                        <div style="font-weight: 700; color: var(--vibrant-cyan);">${stats.totalMinutes}</div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.2rem;">Last Workout</div>
                                                        <div style="font-weight: 600; color: rgba(255, 255, 255, 0.9); font-size: 0.85rem;">
                                                            ${stats.lastWorkout ? new Date(stats.lastWorkout).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A'}
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                })).then(items => items.join(''))}
                            </div>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 2rem; margin-top: 2rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 1.1rem;">No friends yet!</p>
                            <p style="color: rgba(255, 255, 255, 0.5); margin-top: 0.5rem;">Add friends to see their progress and stay motivated together.</p>
                        </div>
                    `}

                    ${activity.length > 0 ? `
                        <div class="workout-summary" style="margin-top: 2rem;">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 0.08em; margin-bottom: 1.5rem; color: var(--vibrant-cyan);">Recent Activity Feed</h3>
                            ${activity.map(act => {
                                const date = new Date(act.date);
                                const typeEmoji = act.workoutType === 'HIIT' ? 'üî•' : 
                                                 act.workoutType === 'Strength' ? 'üí™' : 
                                                 act.workoutType === 'Cross Training' ? '‚ö°' : 'üßò';
                                const timeAgo = getTimeAgo(date);
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--energy-orange); margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
                                            <div>
                                                <div style="font-weight: 700; color: var(--pure-white); margin-bottom: 0.3rem;">
                                                    ${act.displayName}
                                                </div>
                                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">${timeAgo}</div>
                                            </div>
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.5rem;">${typeEmoji}</span>
                                                <div>
                                                    <div style="font-weight: 700; color: var(--electric-yellow);">Completed ${act.workoutType}</div>
                                                    <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">${act.dayName} ‚Ä¢ ${act.totalTime} minutes</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : friends.length > 0 ? `
                        <div style="text-align: center; padding: 2rem; margin-top: 2rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                            <p style="color: rgba(255, 255, 255, 0.6);">No recent activity from friends yet.</p>
                        </div>
                    ` : ''}

                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="hideSocial()" style="background: var(--slate); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border-radius: 8px; font-family: 'Archivo', sans-serif;">
                            Back to Workout
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // Hide other containers
            document.getElementById('workoutContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        window.addFriendHandler = async function() {
            const friendEmail = document.getElementById('friendUsernameInput').value.trim();
            if (!friendEmail) {
                alert('Please enter an email address');
                return;
            }
            
            const success = await addFriend(friendEmail);
            if (success) {
                alert(`Successfully added ${friendEmail} as a friend!`);
                displaySocialFeed(); // Refresh
            } else {
                alert('User not found or already friends. Make sure they\'ve signed in at least once!');
            }
        }

        window.hideSocial = function() {
            document.getElementById('socialContainer').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('workoutContainer').classList.remove('hidden');
        }

        let currentWorkout = null;

        // Generate workout button
        document.getElementById('generateBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            
            const container = document.getElementById('workoutContainer');
            const statsContainer = document.getElementById('statsContainer');
            const socialContainer = document.getElementById('socialContainer');
            
            // Hide stats and social if showing
            statsContainer.classList.add('hidden');
            socialContainer.classList.add('hidden');
            
            // Show loading
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="color: var(--electric-yellow); font-weight: 600; letter-spacing: 0.1em;">GENERATING YOUR WORKOUT...</p>
                </div>
            `;
            container.classList.remove('hidden');
            
            // Simulate loading for effect
            setTimeout(() => {
                const workout = generateWorkout();
                currentWorkout = workout; // Store for completion tracking
                displayWorkout(workout);
                
                // Load exercise histories
                setTimeout(() => {
                    workout.exercises.forEach(exercise => {
                        if (exercise.category !== 'Recovery Stretch' && 
                            exercise.category !== 'Warm-up' && 
                            exercise.category !== 'Cool-down') {
                            loadExerciseHistory(exercise.name);
                        }
                    });
                }, 500);
            }, 1500);
        });

        // View stats button
        document.getElementById('viewStatsBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displayStats();
        });

        // View leaderboard button
        document.getElementById('viewLeaderboardBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displayLeaderboard();
        });

        // Customize workout button
        document.getElementById('customizeBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            showPreferencesModal();
        });

        // View social feed button
        document.getElementById('viewSocialBtn').addEventListener('click', function() {
            if (!currentUser) {
                showProfileSetup();
                return;
            }
            displaySocialFeed();
        });

        // Auto-initialize on page load
        window.addEventListener('load', async function() {
            await initializeUser();
            await loadPreferences();
            
            if (currentUser) {
                // Show user profile badge
                document.getElementById('userProfileBadge').style.display = 'block';
                document.getElementById('displayNameSpan').textContent = currentUser.displayName;
                document.getElementById('usernameSpan').textContent = currentUser.username;
                
                // Auto-generate workout
                setTimeout(() => {
                    document.getElementById('generateBtn').click();
                }, 500);
            }
        });
    </script>
</body>
</html>
